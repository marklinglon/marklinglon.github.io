{"meta":{"version":1,"warehouse":"4.0.2"},"models":{"Asset":[{"_id":"themes/pure/source/favicon.png","path":"favicon.png","modified":0,"renderable":1},{"_id":"themes/pure/source/css/style.css","path":"css/style.css","modified":1,"renderable":1},{"_id":"themes/pure/source/css/style.min.css","path":"css/style.min.css","modified":0,"renderable":1},{"_id":"themes/pure/source/fonts/README.md","path":"fonts/README.md","modified":0,"renderable":1},{"_id":"themes/pure/source/fonts/iconfont.eot","path":"fonts/iconfont.eot","modified":0,"renderable":1},{"_id":"themes/pure/source/fonts/iconfont.svg","path":"fonts/iconfont.svg","modified":0,"renderable":1},{"_id":"themes/pure/source/fonts/iconfont.ttf","path":"fonts/iconfont.ttf","modified":0,"renderable":1},{"_id":"themes/pure/source/fonts/iconfont.woff","path":"fonts/iconfont.woff","modified":0,"renderable":1},{"_id":"themes/pure/source/images/avatar.jpg","path":"images/avatar.jpg","modified":0,"renderable":1},{"_id":"themes/pure/source/images/avatar_src.jpg","path":"images/avatar_src.jpg","modified":0,"renderable":1},{"_id":"themes/pure/source/images/thumb-default.png","path":"images/thumb-default.png","modified":0,"renderable":1},{"_id":"themes/pure/source/images/xingqiu-qrcode.jpg","path":"images/xingqiu-qrcode.jpg","modified":0,"renderable":1},{"_id":"themes/pure/source/js/application.js","path":"js/application.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/insight.js","path":"js/insight.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/application.min.js","path":"js/application.min.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/plugin.js","path":"js/plugin.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/jquery.min.js","path":"js/jquery.min.js","modified":0,"renderable":1},{"_id":"themes/pure/source/js/plugin.js.map","path":"js/plugin.js.map","modified":0,"renderable":1},{"_id":"themes/pure/source/js/plugin.min.js","path":"js/plugin.min.js","modified":0,"renderable":1},{"_id":"themes/pure/source/images/donate/wechat.png","path":"images/donate/wechat.png","modified":0,"renderable":1},{"_id":"themes/pure/source/images/favatar/SzsFox-logo.png","path":"images/favatar/SzsFox-logo.png","modified":0,"renderable":1},{"_id":"themes/pure/source/images/favatar/chuangzaoshi-logo.png","path":"images/favatar/chuangzaoshi-logo.png","modified":0,"renderable":1},{"_id":"themes/pure/source/images/favatar/idesign-logo.png","path":"images/favatar/idesign-logo.png","modified":0,"renderable":1},{"_id":"themes/pure/source/images/donate/alipay.png","path":"images/donate/alipay.png","modified":0,"renderable":1},{"_id":"themes/pure/source/css/monokai-hook.css","path":"css/monokai-hook.css","modified":0,"renderable":1},{"_id":"themes/pure/source/css/monokai.css","path":"css/monokai.css","modified":0,"renderable":1},{"_id":"source/images/webhook1.jpeg","path":"images/webhook1.jpeg","modified":0,"renderable":0}],"Cache":[{"_id":"source/_data/links.yml","hash":"a5e31f35ebb8e1e8811f2e3d957cf4d4835aa2f9","modified":1684771431536},{"_id":"source/_data/gallery.yml","hash":"eef9b025c2a81fdc714967d0c7b21bed9d55cff5","modified":1684771431536},{"_id":"source/404/index.md","hash":"16638b081d796638565ca462f3c87339b9a0577e","modified":1684771431536},{"_id":"source/about/index.md","hash":"b72470146e8244886e15715e0cae79b4130305e8","modified":1684771431537},{"_id":"source/_posts/hexo.md","hash":"5343069b9f9c45e10dc6f88e189b2cdceb3305f7","modified":1685030785397},{"_id":"source/books/index.md","hash":"d913d58987f539ac2ca4cca366ebf42f8b1a03d1","modified":1684771431537},{"_id":"source/categories/index.md","hash":"b0006184ce9570766e7c7507d20fede1079f4992","modified":1684771431537},{"_id":"source/repository/index.md","hash":"bf2bec13066d7d53fc05a334876eb482e6f95825","modified":1684771431537},{"_id":"source/links/index.md","hash":"d768332d0d322fe39267dbbda05b931488c27d7e","modified":1684771431537},{"_id":"source/tags/index.md","hash":"c35ba8af5acf41102909a9f9c1349a24d89f97a6","modified":1684771431538},{"_id":"themes/pure/LICENSE","hash":"82ce1e15ddeabeaaca60e2186b5a3ce42b1a9c49","modified":1684771431535},{"_id":"themes/pure/.gitignore","hash":"204766bf9e2d6fe1fce5b9b02b8edfac2d235830","modified":1684771431535},{"_id":"themes/pure/README.md","hash":"94fe451bf920cec6152e7bf9cbff4ccf0af0febc","modified":1684771431535},{"_id":"themes/pure/README.cn.md","hash":"c14beac2aa2b6e6deb5359600b215d0ae348c0a4","modified":1684771431535},{"_id":"themes/pure/_config.yml","hash":"e7ea2d1bcd452d2643fe3fc0c5678ba5ba98f394","modified":1685030282188},{"_id":"themes/pure/package.json","hash":"d5bad0f074925c46e8ee5a75d385346d2fcea850","modified":1684771431551},{"_id":"themes/pure/_config.yml.example","hash":"a3b55d01598967db40da6f740b38cdba4f17d7bc","modified":1684771431536},{"_id":"themes/pure/languages/default.yml","hash":"ed342f9158f13fafaf51baa4cc89df4d8aa31720","modified":1684771431538},{"_id":"themes/pure/languages/en.yml","hash":"ed342f9158f13fafaf51baa4cc89df4d8aa31720","modified":1684771431538},{"_id":"themes/pure/languages/zh-CN.yml","hash":"08e6cc44c7c06772cedf6aae49807ba7626c1560","modified":1684939436649},{"_id":"themes/pure/languages/zh-TW.yml","hash":"387ad2ca1b2a01dac36f768a6116a2033c3ac142","modified":1684771431538},{"_id":"themes/pure/layout/about.ejs","hash":"4b64515ccc801cc9eba637a1e1909c6c4dd203f6","modified":1684771431549},{"_id":"themes/pure/layout/books.ejs","hash":"75cbd31d3551c730e8a683bd5b08562881a95b51","modified":1684771431549},{"_id":"themes/pure/layout/categories.ejs","hash":"9cc7b5f5af40fd7ec641bf0f5a5f8f1ce1ac22d5","modified":1684771431550},{"_id":"themes/pure/layout/category.ejs","hash":"b3f7a96fbaf201a65ed64d509edc29976542fbfb","modified":1684771431550},{"_id":"themes/pure/layout/archive.ejs","hash":"62847ac8ce2562908c01d69f7f6886e24a6ded40","modified":1684771431549},{"_id":"themes/pure/layout/index.ejs","hash":"44418dbf1fb82392b8e1e4cc910d16a383190433","modified":1684771431550},{"_id":"themes/pure/layout/layout.ejs","hash":"b508d95307dec7c51be6c9ec3c83081a8c40c0e0","modified":1684938915945},{"_id":"themes/pure/layout/links.ejs","hash":"ee90a5f2a9d19bc02682ea3a59177b947f7f7284","modified":1684771431550},{"_id":"themes/pure/layout/page.ejs","hash":"fbfed3c882059e757b23ff57924400683631594b","modified":1684771431550},{"_id":"themes/pure/layout/post.ejs","hash":"fbfed3c882059e757b23ff57924400683631594b","modified":1684771431550},{"_id":"themes/pure/layout/tag.ejs","hash":"30d8ddd84c9aa87dff1be02af308097cf4e72448","modified":1684771431551},{"_id":"themes/pure/layout/repository.ejs","hash":"0ecad33b6c1ec741eb3b02bb47a3824ac3749d09","modified":1684771431550},{"_id":"themes/pure/layout/tags.ejs","hash":"76bc71f3dfd8a5b1aa14b09dec7b460b14f5028a","modified":1684771431551},{"_id":"themes/pure/scripts/thumbnail.js","hash":"4a7385e533f3567758bc995a8be5eb3e7839ac9c","modified":1684771431563},{"_id":"themes/pure/source/favicon.png","hash":"89875d3b018552e396fc5f0bd8ff5d9f5d4a5d71","modified":1684771431565},{"_id":"themes/pure/.github/ISSUE_TEMPLATE/bug_report.md","hash":"16dbe91b392ef9debb7abeffde473668d3337eb2","modified":1684771431534},{"_id":"themes/pure/.github/ISSUE_TEMPLATE/custom.md","hash":"a3b49dff53b405dbafe2e96834313fc329710007","modified":1684771431534},{"_id":"themes/pure/.github/ISSUE_TEMPLATE/feature_request.md","hash":"205a69ba038cf76affcdc1f39d88a8cb8079fc12","modified":1684771431535},{"_id":"themes/pure/_source/404/index.md","hash":"16638b081d796638565ca462f3c87339b9a0577e","modified":1684771431536},{"_id":"themes/pure/_source/_data/gallery.yml","hash":"eef9b025c2a81fdc714967d0c7b21bed9d55cff5","modified":1684771431536},{"_id":"themes/pure/_source/_data/links.yml","hash":"a5e31f35ebb8e1e8811f2e3d957cf4d4835aa2f9","modified":1684771431536},{"_id":"themes/pure/_source/books/index.md","hash":"d913d58987f539ac2ca4cca366ebf42f8b1a03d1","modified":1684771431537},{"_id":"themes/pure/_source/links/index.md","hash":"d768332d0d322fe39267dbbda05b931488c27d7e","modified":1684771431537},{"_id":"themes/pure/_source/about/index.md","hash":"b72470146e8244886e15715e0cae79b4130305e8","modified":1684771431537},{"_id":"themes/pure/_source/repository/index.md","hash":"bf2bec13066d7d53fc05a334876eb482e6f95825","modified":1684771431537},{"_id":"themes/pure/_source/categories/index.md","hash":"b0006184ce9570766e7c7507d20fede1079f4992","modified":1684771431537},{"_id":"themes/pure/_source/tags/index.md","hash":"c35ba8af5acf41102909a9f9c1349a24d89f97a6","modified":1684771431538},{"_id":"themes/pure/layout/_common/footer.ejs","hash":"caec54ce31577207e1fd31aefa017bde99a8027c","modified":1684771431539},{"_id":"themes/pure/layout/_common/header.ejs","hash":"c05070274965692a270c7e07ad9f4dad6f2c5888","modified":1684771431539},{"_id":"themes/pure/layout/_common/head.ejs","hash":"21ef7a3ae4993d0d128f572c5d4b0dcaf1f4a20e","modified":1684944116870},{"_id":"themes/pure/layout/_common/script.ejs","hash":"3045da0c1979946694b628fbef39c01cc98b6e75","modified":1684771431539},{"_id":"themes/pure/layout/_common/social.ejs","hash":"2bcdc7b0ee3905e724b01c2efa1ca6b47a846e1f","modified":1684771431539},{"_id":"themes/pure/layout/_partial/archive-book.ejs","hash":"944913dcabd09c10d3014c844abf851f4dfdba8d","modified":1684771431540},{"_id":"themes/pure/layout/_partial/archive-category.ejs","hash":"4be88eec64fd40c7e1b74df8ccb6c8cdfa3e7a17","modified":1684771431540},{"_id":"themes/pure/layout/_partial/archive-link.ejs","hash":"a8a387f9e7289a6524cf46d7ab76c34fff37f4bf","modified":1684771431540},{"_id":"themes/pure/layout/_partial/archive-post.ejs","hash":"513892fae41de4e68963c95a9358285714274bb4","modified":1684771431540},{"_id":"themes/pure/layout/_partial/archive-list.ejs","hash":"15ebb5d7cc3f07e6bf5ffa783c3d2feabd252fc1","modified":1684771431540},{"_id":"themes/pure/layout/_partial/archive-repository.ejs","hash":"01fabc035fe48a494581f5680ed23f355e0e59ce","modified":1684771431540},{"_id":"themes/pure/layout/_partial/archive.ejs","hash":"c196b54f92eff017a48e02bacc029dd82edc8cf9","modified":1684771431541},{"_id":"themes/pure/layout/_partial/article-about.ejs","hash":"47bbb53fe9cca05928c45782c6897c8a94d597ff","modified":1684771431541},{"_id":"themes/pure/layout/_partial/article.ejs","hash":"d49f03869bc4fa3d5ad6bdce5eb46888f90fd9a8","modified":1684943396251},{"_id":"themes/pure/layout/_partial/archive-tag.ejs","hash":"db8cba32bf6655a8d21fe8c8ccd0695b049e1d4c","modified":1684771431541},{"_id":"themes/pure/layout/_partial/item-post.ejs","hash":"c5d1add53ce45df5f851f19023b2e4f16dad43ef","modified":1684771431541},{"_id":"themes/pure/layout/_partial/pagination.ejs","hash":"cc450ee5638f180332b3c4b747c5337b89d5a0c8","modified":1684771431541},{"_id":"themes/pure/layout/_partial/sidebar-about.ejs","hash":"17787edc304543c8658c7f51076022bda6ad227d","modified":1684771431543},{"_id":"themes/pure/layout/_partial/sidebar-toc.ejs","hash":"1d90de80d5eb2b10be6cad6fa0bfb465cbc5c9f1","modified":1684771431544},{"_id":"themes/pure/layout/_partial/sidebar.ejs","hash":"a6662f79f7fd6f1cc9b5180672ba8e1d0192fbe2","modified":1684771431544},{"_id":"themes/pure/layout/_script/analytics.ejs","hash":"db2967c6902ceb67caa70364935ef3441b10432f","modified":1684771431546},{"_id":"themes/pure/layout/_script/douban.ejs","hash":"6e671c659b282b690a5d61e842b5d5f38dced6d7","modified":1684771431547},{"_id":"themes/pure/layout/_script/fancybox.ejs","hash":"4558b5713926735d874deb14d8b21ed2e597b714","modified":1684771431547},{"_id":"themes/pure/layout/_script/comment.ejs","hash":"d5c98ab345952bb11d9ee69a9c1e3432b6760c55","modified":1684771431546},{"_id":"themes/pure/layout/_script/mathjax.ejs","hash":"7a64d98212769423425102a441fca52eb6930fff","modified":1684771431547},{"_id":"themes/pure/layout/_script/pv.ejs","hash":"a464706b7a903e25d34b104bdfb298b260abc132","modified":1684771431547},{"_id":"themes/pure/layout/_script/repository.ejs","hash":"42b6602f478c9afa4e462716dcfcc76875c0df7d","modified":1684771431547},{"_id":"themes/pure/layout/_script/search.ejs","hash":"2b784d15581df4309f56682896b725da7d44fcdd","modified":1684771431547},{"_id":"themes/pure/layout/_search/baidu.ejs","hash":"89848cc8e0190ca76cc26d42c6880a23e370702e","modified":1684771431548},{"_id":"themes/pure/layout/_search/index-mobile.ejs","hash":"5e9a5cc9bdc05fabf939db494c3937cc0df48a72","modified":1684771431548},{"_id":"themes/pure/layout/_search/index.ejs","hash":"2c1f06dac5710e5fd073f3e5739545f3f6a0a56f","modified":1684771431548},{"_id":"themes/pure/layout/_search/insight.ejs","hash":"14b1ec0bdb911ab6d92046c78d371264afc4fb19","modified":1684771431548},{"_id":"themes/pure/layout/_search/swiftype.ejs","hash":"dc548a83c33b5a598683bf2e1cb723bc3be4a76b","modified":1684771431548},{"_id":"themes/pure/layout/_widget/board.ejs","hash":"9811bab46dcf436c6d05ae78acd62bc25751df78","modified":1684771431548},{"_id":"themes/pure/layout/_widget/category.ejs","hash":"83c8ce4b099951d58b2be5006f6963afbbe7d4e9","modified":1684771431549},{"_id":"themes/pure/layout/_widget/archive.ejs","hash":"b250fb0f63286f9648cd8bf428bed6a88901b481","modified":1684771431548},{"_id":"themes/pure/layout/_widget/recent_posts.ejs","hash":"8932ce5283a7e6a356c6840104a7d6984f2ea986","modified":1684771431549},{"_id":"themes/pure/layout/_widget/tag.ejs","hash":"24823a881a6c15fd846c7f4780eb90fe869a813b","modified":1684771431549},{"_id":"themes/pure/layout/_widget/tagcloud.ejs","hash":"e6967ec160b93a5f466a73a36745833e644d04c0","modified":1684771431549},{"_id":"themes/pure/source/fonts/README.md","hash":"b5b2aac1b36a86dac2217d242d650e026c5a3b0c","modified":1684771431565},{"_id":"themes/pure/source/fonts/iconfont.eot","hash":"6819d9bb643bdeafc17bfecb0746ae641b018fdf","modified":1684771431565},{"_id":"themes/pure/source/fonts/iconfont.ttf","hash":"9b8837f9f79cf6ab794736301d0665345183a20c","modified":1684771431567},{"_id":"themes/pure/source/fonts/iconfont.woff","hash":"78d29194287b8885d25212048c4f787705212a6e","modified":1684771431567},{"_id":"themes/pure/source/images/avatar_src.jpg","hash":"f86eafc318f3900319b25057811720168f24d248","modified":1684771431567},{"_id":"themes/pure/source/images/thumb-default.png","hash":"e8403b97ed9251f9f5207765b0ce796c5000b4ba","modified":1684771431568},{"_id":"themes/pure/source/images/xingqiu-qrcode.jpg","hash":"ef2c2848dc79db6df7c752510651ed8ba57f2daf","modified":1684771431569},{"_id":"themes/pure/source/js/application.js","hash":"945c0db9a8a62c5178a5eb4af592357123b3375a","modified":1684938813716},{"_id":"themes/pure/source/js/insight.js","hash":"a1b773d9ce470bf0e2f8fdca1b6fac2ac3d31aeb","modified":1684771431569},{"_id":"themes/pure/source/js/application.min.js","hash":"34d765e982c7d6360c37f82202d99f63ac40e408","modified":1684771431569},{"_id":"themes/pure/layout/_partial/post/comment.ejs","hash":"0ef132fc45042b28411e3334e77b6e2a7f47fae2","modified":1684771431542},{"_id":"themes/pure/layout/_partial/post/category.ejs","hash":"20ef0d47ec3d2de7d94db9778ddac092dc2bd4b5","modified":1684771431542},{"_id":"themes/pure/layout/_partial/post/copyright.ejs","hash":"c690e62e930ac7e66a5982aa95e146324e9b1e7f","modified":1684771431542},{"_id":"themes/pure/layout/_partial/post/date.ejs","hash":"8cbaef422bd7f3d1581d1198dd1c36e4c0e1e46e","modified":1684771431542},{"_id":"themes/pure/layout/_partial/post/donate.ejs","hash":"bdef9836ca91b3e45498a9d98bcaec69e6627ced","modified":1684771431542},{"_id":"themes/pure/layout/_partial/post/gallery.ejs","hash":"b0bf3f5d923c261ca2b5fabab513f1ec2708c8ca","modified":1684771431542},{"_id":"themes/pure/layout/_partial/post/livere.ejs","hash":"1d3661deda0974a2c453ecb35ca7e29d40413d76","modified":1684774400314},{"_id":"themes/pure/layout/_partial/post/nav.ejs","hash":"5b4119092b890c156a4e85e15be2cbcebf89fcbd","modified":1684771431542},{"_id":"themes/pure/layout/_partial/post/pv.ejs","hash":"946f4bcfa5e5dc4d60c05916c8187bd2c06d1a95","modified":1684771431543},{"_id":"themes/pure/layout/_partial/post/tag.ejs","hash":"8fd470b8d52606a90d475f7da9dbbed32742b1c9","modified":1684771431543},{"_id":"themes/pure/layout/_partial/post/thumbnail.ejs","hash":"0d8b9a3aeaed95b74e292c593f0a8225711bfdca","modified":1684771431543},{"_id":"themes/pure/layout/_partial/post/title.ejs","hash":"d4a460a35e2112d0c7414fd5e19b3a16093f1caf","modified":1684771431543},{"_id":"themes/pure/layout/_partial/post/wordcount.ejs","hash":"81e9a89734505f54fef83dc74d2e277dab1bfa75","modified":1684771431543},{"_id":"themes/pure/layout/_script/_analytics/baidu-analytics.ejs","hash":"829778c19025882fe73cf1b297a36a9d0eff39a1","modified":1684771431544},{"_id":"themes/pure/layout/_script/_analytics/google-analytics.ejs","hash":"4557389e499b89982eb005a821208fdd3dbac627","modified":1684771431544},{"_id":"themes/pure/layout/_script/_analytics/tencent-analytics.ejs","hash":"19585fc666e13a2816d74a8046998ac7fd36f75c","modified":1684771431544},{"_id":"themes/pure/layout/_script/_comment/disqus.ejs","hash":"98dac12a9cbf47098b49183893d714355e2e5999","modified":1684771431544},{"_id":"themes/pure/layout/_script/_comment/gitalk.ejs","hash":"d6bf1cfaa9167dcfb9ffab20c6670c53a008e838","modified":1684771431545},{"_id":"themes/pure/layout/_script/_comment/gitment.ejs","hash":"0af71b5b354fdddd576fbd55c3aeb0221af71e7d","modified":1684771431545},{"_id":"themes/pure/layout/_script/_comment/livere.ejs","hash":"2cc7b1cb7bdf157fe6470eb34a613963df75afa3","modified":1684771431545},{"_id":"themes/pure/layout/_script/_comment/valine.ejs","hash":"19120669bfea521e0b9d2df5bf3a34f0ecb8bb68","modified":1684771431545},{"_id":"themes/pure/layout/_script/_comment/youyan.ejs","hash":"96fcc36560a8367e6c4ba9ec1e82d0c5a730b1b4","modified":1684771431545},{"_id":"themes/pure/layout/_script/_repository/gitee.ejs","hash":"be7fed016f5332b597af6a5d5de262cc4fe939a0","modified":1684771431545},{"_id":"themes/pure/layout/_script/_repository/github.ejs","hash":"4df2172813297fcfb9ab894f668f21230f2e9e77","modified":1684771431546},{"_id":"themes/pure/layout/_script/_repository/legacy.ejs","hash":"9ed1e7de79bd661065b9c071957c54e58c38827c","modified":1684771431546},{"_id":"themes/pure/layout/_script/_search/baidu.ejs","hash":"72b48dcaab830b615c71f6e810e96100b715c682","modified":1684771431546},{"_id":"themes/pure/layout/_script/_search/insight.ejs","hash":"f95c3289c03fa084afce64e3c399cb5127707f56","modified":1684771431546},{"_id":"themes/pure/source/images/donate/alipayimg.png","hash":"9562f23f2eb57841c65dc769b6cc43a2cf0efa94","modified":1684771431567},{"_id":"themes/pure/source/images/favatar/SzsFox-logo.png","hash":"d71fcc73b7bc2a439d8c7ba461137856d190bd76","modified":1684771431568},{"_id":"themes/pure/source/images/favatar/chuangzaoshi-logo.png","hash":"7fa5734072050952159a02d330bbc008b5a99122","modified":1684771431568},{"_id":"themes/pure/source/images/favatar/idesign-logo.png","hash":"6b150a2dbb9912b7a7662255c27e4d4baaecee71","modified":1684771431568},{"_id":"themes/pure/screenshot/pure-theme-black.png","hash":"10b40f398af7eb7e8ba2bf2f2a959d8779fc1fe1","modified":1684771431552},{"_id":"themes/pure/screenshot/pure-theme-blue.png","hash":"6146890a68d5ea9d343c48d50151ddd5a2a1872c","modified":1684771431552},{"_id":"themes/pure/screenshot/pure-theme-green.png","hash":"12ec0c6033cb2762839fdf75434bbb4fbf946022","modified":1684771431553},{"_id":"themes/pure/screenshot/pure-theme-purple.png","hash":"9855d2eb0acd23370209354f232471df8f4f72e2","modified":1684771431554},{"_id":"themes/pure/screenshot/pure.png","hash":"8f4cfd8d7edfa4fbffdf375291302d9807f5cc1c","modified":1684771431554},{"_id":"themes/pure/source/js/jquery.min.js","hash":"dacc1f76630a9708add066819b1aabf8dce01056","modified":1684771431570},{"_id":"themes/pure/source/js/plugin.min.js","hash":"4eded164f8b6f5187fbf10065873ebeee5ab8787","modified":1684771431572},{"_id":"themes/pure/source/css/style.css","hash":"4fda4b045194290ab3b05b28d263458cc3cf6a6a","modified":1685031504483},{"_id":"themes/pure/source/css/style.min.css","hash":"4e46cbfadf9f0c5c236239a163058a3f525492ce","modified":1684771431564},{"_id":"themes/pure/source/fonts/iconfont.svg","hash":"1af91521f1c29c231ffc19d7f64696ddcd71470b","modified":1684771431566},{"_id":"themes/pure/source/js/plugin.js","hash":"59cb2985d8d21653f0f80ef327517eca86af0ac6","modified":1684771431571},{"_id":"themes/pure/source/js/plugin.js.map","hash":"1730c0cc660f863120aca0a439d7264e2e245fc5","modified":1684771431572},{"_id":"themes/pure/source/images/avatar.jpg","hash":"e81bef64725233884f5526cbf915a86a4d719124","modified":1684808570521},{"_id":"themes/pure/source/images/donate/wechat.png","hash":"7f53e68df822008e75daf19dec0867d19b966c32","modified":1684808264588},{"_id":"themes/pure/screenshot/pure.psd","hash":"a31cea40b45bdc31f051fca2f1e2f4ecbaee1a94","modified":1684771431562},{"_id":"public/atom.xml","hash":"4528b4e83d66e4a5aa634e7d25d776a303577b69","modified":1685031543627},{"_id":"public/content.json","hash":"f153784145ff131096af23f1375589bbc164ea58","modified":1685031543627},{"_id":"public/sitemap.xml","hash":"97f867780cc2d15b6204d5f46a3129379c8b459a","modified":1685031543627},{"_id":"public/baidusitemap.xml","hash":"5d297b0699ec24275e71340f671cb2ac6800deb1","modified":1685031543627},{"_id":"public/sitemap.txt","hash":"c29c37295641a028f0445d57a78229a492fe4a55","modified":1685031543627},{"_id":"public/404.html","hash":"2a7b2eea5410555e806f031a73b2340bf8af4ff0","modified":1685031543627},{"_id":"public/about/index.html","hash":"a908a2a49b43a76eb7a73c0b6c0b9a591418de50","modified":1685031543627},{"_id":"public/categories/index.html","hash":"c5d7a648baed1dd48b3664d2737f280c432540e1","modified":1685031543627},{"_id":"public/repository/index.html","hash":"370da892bcd03d7cade0a1d9a27937f604084355","modified":1685031543627},{"_id":"public/links/index.html","hash":"b263f754e907da905bf894015e0ace63a1b0e630","modified":1685031543627},{"_id":"public/archives/index.html","hash":"377aa77548799e1e6a162314d8b7f069c629e7fa","modified":1685031543627},{"_id":"public/tags/index.html","hash":"484d79efdffa207c9a442e27cd6eb8e887e1e46f","modified":1685031543627},{"_id":"public/archives/2023/index.html","hash":"542288d9e7f0e95ce4a229512dd1f6aee372d992","modified":1685031543627},{"_id":"public/index.html","hash":"bd2e180a8c5799138456fb97b9ee738f56d8fcf1","modified":1685031543627},{"_id":"public/archives/2023/05/index.html","hash":"29454c660c72d264e5e9d38e1a5bcdb9dc9e2d13","modified":1685031543627},{"_id":"public/books/index.html","hash":"b327276e7cf81b74dbbc206c8976eeb364a66cce","modified":1685031543627},{"_id":"public/2023/05/23/hexo/index.html","hash":"6bfff0a33c77385584e0055eadcac8fddb9d16b5","modified":1685031543627},{"_id":"public/favicon.png","hash":"89875d3b018552e396fc5f0bd8ff5d9f5d4a5d71","modified":1685031543627},{"_id":"public/fonts/iconfont.eot","hash":"6819d9bb643bdeafc17bfecb0746ae641b018fdf","modified":1685031543627},{"_id":"public/fonts/iconfont.woff","hash":"78d29194287b8885d25212048c4f787705212a6e","modified":1685031543627},{"_id":"public/fonts/iconfont.ttf","hash":"9b8837f9f79cf6ab794736301d0665345183a20c","modified":1685031543627},{"_id":"public/images/xingqiu-qrcode.jpg","hash":"ef2c2848dc79db6df7c752510651ed8ba57f2daf","modified":1685031543627},{"_id":"public/images/donate/alipayimg.png","hash":"9562f23f2eb57841c65dc769b6cc43a2cf0efa94","modified":1684826578330},{"_id":"public/images/favatar/chuangzaoshi-logo.png","hash":"7fa5734072050952159a02d330bbc008b5a99122","modified":1685031543627},{"_id":"public/images/favatar/SzsFox-logo.png","hash":"d71fcc73b7bc2a439d8c7ba461137856d190bd76","modified":1685031543627},{"_id":"public/images/avatar_src.jpg","hash":"f86eafc318f3900319b25057811720168f24d248","modified":1685031543627},{"_id":"public/images/thumb-default.png","hash":"e8403b97ed9251f9f5207765b0ce796c5000b4ba","modified":1685031543627},{"_id":"public/images/favatar/idesign-logo.png","hash":"6b150a2dbb9912b7a7662255c27e4d4baaecee71","modified":1685031543627},{"_id":"public/fonts/README.html","hash":"26a13286f808d3ef09314df865be3049eef3906f","modified":1685031543627},{"_id":"public/css/style.min.css","hash":"1d23abc76726ebe042f7df4749f00f8f73338444","modified":1685031543627},{"_id":"public/css/style.css","hash":"a470cc5857a97e22982562c6f4673949d05e56a9","modified":1685031543627},{"_id":"public/js/application.js","hash":"85cc3ae61e08df032290df3373bb745918cc497a","modified":1685031543627},{"_id":"public/js/application.min.js","hash":"34d765e982c7d6360c37f82202d99f63ac40e408","modified":1685031543627},{"_id":"public/js/insight.js","hash":"298e8ca42517984bd26f34caa4c45560b0e909ad","modified":1685031543627},{"_id":"public/js/plugin.js","hash":"a8524d42b8621bfaa06602a163c6a1f82702b91d","modified":1685031543627},{"_id":"public/js/jquery.min.js","hash":"5a9dcfbef655a2668e78baebeaa8dc6f41d8dabb","modified":1685031543627},{"_id":"public/js/plugin.min.js","hash":"07fe34638f9832702c5f81d8583c5e4e8b3d9659","modified":1685031543627},{"_id":"public/fonts/iconfont.svg","hash":"1af91521f1c29c231ffc19d7f64696ddcd71470b","modified":1685031543627},{"_id":"public/js/plugin.js.map","hash":"1730c0cc660f863120aca0a439d7264e2e245fc5","modified":1685031543627},{"_id":"public/images/avatar.jpg","hash":"e81bef64725233884f5526cbf915a86a4d719124","modified":1685031543627},{"_id":"public/images/donate/wechat.png","hash":"7f53e68df822008e75daf19dec0867d19b966c32","modified":1685031543627},{"_id":"themes/pure/languages/default copy.yml","hash":"ed342f9158f13fafaf51baa4cc89df4d8aa31720","modified":1684771431538},{"_id":"source/_posts/h1.md","hash":"dd9ab942893224127a9721d1f13f5f01715bb47d","modified":1684812951736},{"_id":"source/_posts/kubebuilder-Admission-Webhooks.md","hash":"aebfe685e19cf6badcf15fc4c229dd1abaae5fa1","modified":1685030729816},{"_id":"source/_posts/kubebuilder-best-practices.md","hash":"11659ba983504ba979f0a322f3632a5d448c41ce","modified":1685030725921},{"_id":"source/_posts/kubebuilder-watch-resources.md","hash":"73b29b3414962dba2ded8559accf681d78e71b93","modified":1685030703803},{"_id":"source/_posts/kubebuilder-webhook.md","hash":"d2c7f8906bfc755b3fc0eb24125cf7a29bacbed9","modified":1685030735973},{"_id":"source/_posts/alertmanager.md","hash":"6bff8da5d04b9ecaf61d7b8d2d8244624d0faddf","modified":1685030753508},{"_id":"public/2023/05/23/alertmanager/index.html","hash":"317894830b162f3615426da8a05121aa5cb7216e","modified":1685031543627},{"_id":"public/2023/05/23/kubebuilder-Admission-Webhooks/index.html","hash":"0a98c99c4cb85561682a998d385c478ec120724e","modified":1685031543627},{"_id":"public/2023/05/23/kubebuilder-watch-resources/index.html","hash":"a32a8b40d8d655a06574c30728a9f7a9e76a5988","modified":1685031543627},{"_id":"public/2023/05/23/kubebuilder-best-practices/index.html","hash":"afee047d6baa890190d57c904cc91e38ccb712a8","modified":1685031543627},{"_id":"public/2023/05/23/kubebuilder-webhook/index.html","hash":"ef88d231818e6f747b394387081f20fe88fa9a63","modified":1685031543627},{"_id":"themes/pure/layout/_partial/article-copy-code.ejs","hash":"a3e1923b1ac6680677677e63a0276d530072ca5a","modified":1684940436011},{"_id":"themes/pure/source/images/donate/alipay.png","hash":"023aad453ee70b55d36ddcbb12eacd7692af1d51","modified":1684939995643},{"_id":"public/images/donate/alipay.png","hash":"023aad453ee70b55d36ddcbb12eacd7692af1d51","modified":1685031543627},{"_id":"themes/pure/source/css/monokai-hook.css","hash":"732596c3bba1ae91b31322bb0907478f59bd4b30","modified":1684943852455},{"_id":"themes/pure/source/css/monokai.css","hash":"2ccd97a7d5e0d9f1a251a2139ed2bbc42a4521db","modified":1684944201871},{"_id":"source/_posts/webhook1.jpeg","hash":"344b435dc3645da6b8585a373aebd1baf8229303","modified":1685015402484},{"_id":"source/images/webhook1.jpeg","hash":"344b435dc3645da6b8585a373aebd1baf8229303","modified":1685015402484},{"_id":"public/images/webhook1.jpeg","hash":"344b435dc3645da6b8585a373aebd1baf8229303","modified":1685031543627},{"_id":"public/css/monokai-hook.css","hash":"ecf3db58a79b778e7688a60ee84d031448c604ca","modified":1685031543627},{"_id":"public/css/monokai.css","hash":"2ccd97a7d5e0d9f1a251a2139ed2bbc42a4521db","modified":1685031543627},{"_id":"public/categories/Kubebuilder/index.html","hash":"409b2eb373e2fbe7c6a7d368ab7c60e8731160b8","modified":1685031543627},{"_id":"public/categories/hexo/index.html","hash":"0aa6526590ff0941fd89003a9c9c5e8c0c8079c0","modified":1685031543627},{"_id":"public/categories/prometheux/index.html","hash":"5fb90becdf8bab0fd5e120f0a7b75e125ef12b6c","modified":1685031543627},{"_id":"public/tags/k8s/index.html","hash":"7e71829c089b5fef1c193869cee3324c9362fbea","modified":1685031543627},{"_id":"public/tags/hexo/index.html","hash":"8d805f65408d5dba26b18edbd65a5c77e8412feb","modified":1685031543627}],"Category":[{"name":"kube","_id":"cli3bjtun00002kf8b7sd150l"},{"name":"Kube","_id":"cli3bjw7l00022kf83rlt2zne"},{"name":"Kubebuilder","_id":"cli3bjxsk00042kf84ekkbnbs"},{"name":"hexo","_id":"cli3blqgy000324f853qic9bw"},{"name":"prometheux","_id":"cli3bm2q4000524f88iur6aku"}],"Data":[{"_id":"links","data":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}}},{"_id":"gallery","data":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}],"Page":[{"title":"404 Not Found：该页无法显示","toc":false,"comments":0,"_content":"<script type=\"text/javascript\" src=\"//www.qq.com/404/search_children.js\" charset=\"utf-8\" homePageUrl=\"<%- config.url %>\" homePageName=\"回到我的主页\"></script>\n","source":"404/index.md","raw":"---\ntitle: 404 Not Found：该页无法显示\ntoc: false\ncomments: false\npermalink: /404\n---\n<script type=\"text/javascript\" src=\"//www.qq.com/404/search_children.js\" charset=\"utf-8\" homePageUrl=\"<%- config.url %>\" homePageName=\"回到我的主页\"></script>\n","date":"2023-05-22T16:03:51.536Z","updated":"2023-05-22T16:03:51.536Z","path":"/404.html","layout":"page","_id":"clhzo2qv50000f0f8fpm08guw","content":"<script type=\"text/javascript\" src=\"//www.qq.com/404/search_children.js\" charset=\"utf-8\" homePageUrl=\"<%- config.url %>\" homePageName=\"回到我的主页\"></script>\n","site":{"data":{"links":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}},"gallery":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}},"excerpt":"","more":"<script type=\"text/javascript\" src=\"//www.qq.com/404/search_children.js\" charset=\"utf-8\" homePageUrl=\"<%- config.url %>\" homePageName=\"回到我的主页\"></script>\n"},{"title":"关于","description":"个人简介","layout":"about","comments":0,"sidebar":"custom","_content":"个人详细介绍","source":"about/index.md","raw":"---\ntitle: 关于\ndescription: 个人简介\nlayout: about\ncomments: false\nsidebar: custom\n---\n个人详细介绍","date":"2023-05-22T16:03:51.537Z","updated":"2023-05-22T16:03:51.537Z","path":"about/index.html","_id":"clhzo2qvb0002f0f87afkd0wf","content":"<p>个人详细介绍</p>\n","site":{"data":{"links":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}},"gallery":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}},"excerpt":"","more":"<p>个人详细介绍</p>\n"},{"title":"书单","layout":"books","comments":0,"sidebar":"none","_content":"","source":"books/index.md","raw":"---\ntitle: 书单\nlayout: books\ncomments: false\nsidebar: none\n---","date":"2023-05-22T16:03:51.537Z","updated":"2023-05-22T16:03:51.537Z","path":"books/index.html","_id":"clhzo2qvc0003f0f8cmh890sz","content":"","site":{"data":{"links":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}},"gallery":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}},"excerpt":"","more":""},{"title":"分类","layout":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ntitle: 分类\nlayout: categories\ncomments: false\n---\n","date":"2023-05-22T16:03:51.537Z","updated":"2023-05-22T16:03:51.537Z","path":"categories/index.html","_id":"clhzo2qvc0004f0f85rzi56e7","content":"","site":{"data":{"links":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}},"gallery":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}},"excerpt":"","more":""},{"title":"Repositories","layout":"repository","comments":0,"sidebar":"none","_content":"","source":"repository/index.md","raw":"---\ntitle: Repositories\nlayout: repository\ncomments: false\nsidebar: none\n---\n","date":"2023-05-22T16:03:51.537Z","updated":"2023-05-22T16:03:51.537Z","path":"repository/index.html","_id":"clhzo2qvd0005f0f8hdf78kmf","content":"","site":{"data":{"links":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}},"gallery":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}},"excerpt":"","more":""},{"title":"友情链接","layout":"links","comments":1,"sidebar":"none","_content":"","source":"links/index.md","raw":"---\ntitle: 友情链接\nlayout: links\ncomments: true\nsidebar: none\n---","date":"2023-05-22T16:03:51.537Z","updated":"2023-05-22T16:03:51.537Z","path":"links/index.html","_id":"clhzo2qvd0006f0f8eca01yep","content":"","site":{"data":{"links":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}},"gallery":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}},"excerpt":"","more":""},{"title":"标签","layout":"tags","comments":0,"_content":"","source":"tags/index.md","raw":"---\ntitle: 标签\nlayout: tags\ncomments: false\n---\n","date":"2023-05-22T16:03:51.538Z","updated":"2023-05-22T16:03:51.538Z","path":"tags/index.html","_id":"clhzo2qve0007f0f88vku48s9","content":"","site":{"data":{"links":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}},"gallery":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}},"excerpt":"","more":""}],"Post":[{"title":"hexo部署文档","sidebar":"none","_content":"Welcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash \n# deploy前先删除public目录\n$ hexo deploy\n```\n\n## 参考链接\n\n```\nhttps://blog.cofess.com/2017/11/01/hexo-blog-theme-pure-usage-description.html // 部署文档\nhttp://blog.iwwee.com/posts/hexo-optimize.html // 优化\nhttps://hexo.io/zh-cn/docs/syntax-highlight.html // 代码高亮\n```\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","source":"_posts/hexo.md","raw":"---\ntitle: hexo部署文档\ncategories:\n  - hexo\ntags:\n  - hexo\nsidebar: none \n---\nWelcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash \n# deploy前先删除public目录\n$ hexo deploy\n```\n\n## 参考链接\n\n```\nhttps://blog.cofess.com/2017/11/01/hexo-blog-theme-pure-usage-description.html // 部署文档\nhttp://blog.iwwee.com/posts/hexo-optimize.html // 优化\nhttps://hexo.io/zh-cn/docs/syntax-highlight.html // 代码高亮\n```\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","slug":"hexo","published":1,"date":"2023-05-23T02:30:45.919Z","updated":"2023-05-25T16:06:25.397Z","_id":"clhzo2qv80001f0f8dwa6cswx","comments":1,"layout":"post","photos":[],"link":"","content":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"quick-start\"><a class=\"markdownIt-Anchor\" href=\"#quick-start\"></a> Quick Start</h2>\n<h3 id=\"create-a-new-post\"><a class=\"markdownIt-Anchor\" href=\"#create-a-new-post\"></a> Create a new post</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"run-server\"><a class=\"markdownIt-Anchor\" href=\"#run-server\"></a> Run server</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"generate-static-files\"><a class=\"markdownIt-Anchor\" href=\"#generate-static-files\"></a> Generate static files</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"deploy-to-remote-sites\"><a class=\"markdownIt-Anchor\" href=\"#deploy-to-remote-sites\"></a> Deploy to remote sites</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># deploy前先删除public目录</span></span><br><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考链接\"><a class=\"markdownIt-Anchor\" href=\"#参考链接\"></a> 参考链接</h2>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https:<span class=\"regexp\">//</span>blog.cofess.com<span class=\"regexp\">/2017/</span><span class=\"number\">11</span><span class=\"regexp\">/01/</span>hexo-blog-theme-pure-usage-description.html <span class=\"regexp\">//</span> 部署文档</span><br><span class=\"line\">http:<span class=\"regexp\">//</span>blog.iwwee.com<span class=\"regexp\">/posts/</span>hexo-optimize.html <span class=\"regexp\">//</span> 优化</span><br><span class=\"line\">https:<span class=\"regexp\">//</span>hexo.io<span class=\"regexp\">/zh-cn/</span>docs<span class=\"regexp\">/syntax-highlight.html /</span><span class=\"regexp\">/ 代码高亮</span></span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n","site":{"data":{"links":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}},"gallery":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}},"excerpt":"","more":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"quick-start\"><a class=\"markdownIt-Anchor\" href=\"#quick-start\"></a> Quick Start</h2>\n<h3 id=\"create-a-new-post\"><a class=\"markdownIt-Anchor\" href=\"#create-a-new-post\"></a> Create a new post</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"run-server\"><a class=\"markdownIt-Anchor\" href=\"#run-server\"></a> Run server</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"generate-static-files\"><a class=\"markdownIt-Anchor\" href=\"#generate-static-files\"></a> Generate static files</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"deploy-to-remote-sites\"><a class=\"markdownIt-Anchor\" href=\"#deploy-to-remote-sites\"></a> Deploy to remote sites</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># deploy前先删除public目录</span></span><br><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<h2 id=\"参考链接\"><a class=\"markdownIt-Anchor\" href=\"#参考链接\"></a> 参考链接</h2>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https:<span class=\"regexp\">//</span>blog.cofess.com<span class=\"regexp\">/2017/</span><span class=\"number\">11</span><span class=\"regexp\">/01/</span>hexo-blog-theme-pure-usage-description.html <span class=\"regexp\">//</span> 部署文档</span><br><span class=\"line\">http:<span class=\"regexp\">//</span>blog.iwwee.com<span class=\"regexp\">/posts/</span>hexo-optimize.html <span class=\"regexp\">//</span> 优化</span><br><span class=\"line\">https:<span class=\"regexp\">//</span>hexo.io<span class=\"regexp\">/zh-cn/</span>docs<span class=\"regexp\">/syntax-highlight.html /</span><span class=\"regexp\">/ 代码高亮</span></span><br></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n"},{"title":"Kubebuilder Webhook 开发之创建 TLS 证书","sidebar":"none","_content":"在编写一个准入 Webhook 服务时，需要配置相关证书，k8s 提供了 api 用于对用户自主创建的证书进行认证签发。以下部分演示为 Webhook 服务创建 TLS 证书。\n\n# 创建 TLS 证书\n## 创建你的证书\n通过运行以下命令生成私钥:\n```\ncat <<EOF | cfssl genkey - | cfssljson -bare server\n{\n  \"hosts\": [\n    \"my-svc.my-namespace.svc.cluster.local\",\n    \"my-pod.my-namespace.pod.cluster.local\",\n    \"192.0.2.24\",\n    \"10.0.34.2\"\n  ],\n  \"CN\": \"my-pod.my-namespace.pod.cluster.local\",\n  \"key\": {\n    \"algo\": \"ecdsa\",\n    \"size\": 256\n  }\n}\nEOF\n```\n此命令生成两个文件；它生成包含 PEM 编码 PKCS#10 证书请求的 server.csr， 以及 PEM 编码密钥的 server-key.pem，用于待生成的证书。\n\n# 创建证书签名请求（CSR）\n```\ncat <<EOF | kubectl apply -f -\napiVersion: certificates.k8s.io/v1beta1\nkind: CertificateSigningRequest\nmetadata:\n  name: example\nspec:\n  request: $(cat server.csr | base64 | tr -d '\\n')\n  usages:\n  - digital signature\n  - key encipherment\n  - server auth\nEOF\n```\n你能看到的输出类似于：\n```\ncertificatesigningrequest.certificates.k8s.io/example created\n```\n> Warning: certificates.k8s.io/v1beta1 CertificateSigningRequest is deprecated in v1.19+, unavailable in v1.22+; use certificates.k8s.io/v1 CertificateSigningRequest\n\nCSR 处于 Pending 状态。执行下面的命令你将可以看到：\n```\nkubectl get csr\n```\n```\nNAME AGE SIGNERNAME REQUESTOR CONDITION\nexample 17s kubernetes.io/legacy-unknown 100015926370-1650441195 Pending\n```\n# 批准证书签名请求（CSR）\n```\nkubectl certificate approve example\n```\n```\ncertificatesigningrequest.certificates.k8s.io/example approved\n```\n# 你现在应该能看到如下输出：\n```\nkubectl get csr\n```\n```\nNAME AGE SIGNERNAME REQUESTOR CONDITION\nexample 5m4s kubernetes.io/legacy-unknown 100015926370-1650441195 Approved,Issued\n```\n# 下载证书并使用它\n```\nkubectl get csr example -o jsonpath='{.status.certificate}' | base64 --decode > server.crt\n```\n现在你可以将 server.crt 和 server-key.pem 作为你的服务的 https 认证了。\n\n例如 kubebuilder 中使用 TLS 证书，将 server.crt 和 server-key.pem 放在 cert 目录中并修改名称为 tls.crt 和 tls.key，然后指定证书目录：\n```\nmgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{\n    Scheme:                 scheme,\n    MetricsBindAddress:     metricsAddr,\n    Port:                   9443,\n    HealthProbeBindAddress: probeAddr,\n    LeaderElection:         enableLeaderElection,\n    LeaderElectionID:       \"27e1b0af.blazehu.com\",\n    CertDir:                \"./cert/\",\n})\n```\n# 从 v1beta1 迁移到 v1\n上述例子使用 certificates.k8s.io/v1beta1 API 版本的 CertificateSigningRequest 不在 v1.22 版本中继续提供。官方迁移指南点这里。 我们可以使用 certificates.k8s.io/v1 API 版本，此 API 从 v1.19 版本开始可用。\n\n•certificates.k8s.io/v1 中需要额外注意的变更：\n•对于请求证书的 API 客户端而言：\n•spec.signerName 现在变成必需字段（参阅 已知的 Kubernetes 签署者）， 并且通过 certificates.k8s.io/v1 API 不可以创建签署者为 kubernetes.io/legacy-unknown 的请求\n•spec.usages 现在变成必需字段，其中不可以包含重复的字符串值， 并且只能包含已知的用法字符串\n\n# 创建你的证书\n通过运行以下命令生成私钥:\n```\ncat <<EOF | cfssl genkey - | cfssljson -bare server\n{\n  \"hosts\": [\n    \"my-svc.my-namespace.svc.cluster.local\",\n    \"my-pod.my-namespace.pod.cluster.local\",\n    \"192.0.2.24\",\n    \"10.0.34.2\"\n  ],\n  \"CN\": \"my-pod.my-namespace.pod.cluster.local\",\n  \"key\": {\n    \"algo\": \"ecdsa\",\n    \"size\": 256\n  }\n}\nEOF\n```\n# 创建证书签名请求（CSR）\n这里 csr signerName 不能是 kubernetes.io/legacy-unknown，演示我们随便指定一个为 example.com/serving，v1beta1 版本默认是 kubernetes.io/legacy-unknown。\n```\ncat <<EOF | kubectl apply -f -\napiVersion: certificates.k8s.io/v1\nkind: CertificateSigningRequest\nmetadata:\n  name: example\nspec:\n  request: $(cat server.csr | base64 | tr -d '\\n')\n  signerName: example.com/serving\n  usages:\n  - digital signature\n  - key encipherment\n  - server auth\nEOF\n```\n\n# 批准证书签名请求（CSR）\n```\nkubectl certificate approve example\n```\n```\ncertificatesigningrequest.certificates.k8s.io/example approved\n```\n你现在应该能看到如下输出：\n```\nkubectl get csr\n```\n```\nNAME AGE SIGNERNAME REQUESTOR CONDITION\nexample 11s example.com/serving 100015926370-1650441195 Approved\n```\n这里可以看到证书请求已被批准，但是没有自动签名，正在等待请求的签名者对其签名。\n\n# 签名证书签名请求（CSR）\n我们扮演证书签署者的角色，颁发证书并将其上传到 API 服务器。\n\n## 创建证书颁发机构\n通过运行以下命令创建签名证书:\n```\ncat <<EOF | cfssl gencert -initca - | cfssljson -bare ca\n{\n  \"CN\": \"example.com/serving\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  }\n}\nEOF\n```\n\n这会产生一个证书颁发机构密钥文件（ca-key.pem）和证书（ca.pem）。\n\n## 颁发证书\n创建文件 server-signing-config.json 内容如下：\n```\n{\n  \"signing\": {\n    \"default\": {\n      \"usages\": [\n        \"digital signature\",\n        \"key encipherment\",\n        \"server auth\"\n      ],\n      \"expiry\": \"876000h\",\n      \"ca_constraint\": {\n        \"is_ca\": false\n      }\n    }\n  }\n}\n```\n\n使用 server-signing-config.json 签名配置、证书颁发机构密钥文件和证书来签署证书请求：\n```\nkubectl get csr example -o jsonpath='{.spec.request}' | \\\nbase64 --decode | \\\ncfssl sign -ca ca.pem -ca-key ca-key.pem -config server-signing-config.json - | \\\ncfssljson -bare ca-signed-server\n```\n这会生成一个签名的服务证书文件，ca-signed-server.pem。\n\n## 上传签名证书\n```\nkubectl get csr example -o json | \\\njq '.status.certificate = \"'$(base64 ca-signed-server.pem | tr -d '\\n')'\"' | \\\nkubectl replace --raw /apis/certificates.k8s.io/v1/certificatesigningrequests/example/status -f -\n```\n批准 CSR 并上传签名证书后，你现在应该能看到如下输出：\n```\nkubectl get csr\n```\n```\nNAME AGE SIGNERNAME REQUESTOR CONDITION\nexample 10m example.com/serving 100015926370-1650441195 Approved,Issued\n```\n这是你可以正常下载证书并使用它了。\n\n# 参考文档\n•https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/\n•https://kubernetes.io/zh-cn/docs/tasks/tls/managing-tls-in-a-cluster/#configuring-your-cluster-to-provide-signing\n•https://kubernetes.io/zh-cn/docs/reference/using-api/deprecation-guide/","source":"_posts/kubebuilder-webhook.md","raw":"---\ntitle: Kubebuilder Webhook 开发之创建 TLS 证书\ncategories: \n  - Kubebuilder\ntags:\n  - k8s\nsidebar: none \n---\n在编写一个准入 Webhook 服务时，需要配置相关证书，k8s 提供了 api 用于对用户自主创建的证书进行认证签发。以下部分演示为 Webhook 服务创建 TLS 证书。\n\n# 创建 TLS 证书\n## 创建你的证书\n通过运行以下命令生成私钥:\n```\ncat <<EOF | cfssl genkey - | cfssljson -bare server\n{\n  \"hosts\": [\n    \"my-svc.my-namespace.svc.cluster.local\",\n    \"my-pod.my-namespace.pod.cluster.local\",\n    \"192.0.2.24\",\n    \"10.0.34.2\"\n  ],\n  \"CN\": \"my-pod.my-namespace.pod.cluster.local\",\n  \"key\": {\n    \"algo\": \"ecdsa\",\n    \"size\": 256\n  }\n}\nEOF\n```\n此命令生成两个文件；它生成包含 PEM 编码 PKCS#10 证书请求的 server.csr， 以及 PEM 编码密钥的 server-key.pem，用于待生成的证书。\n\n# 创建证书签名请求（CSR）\n```\ncat <<EOF | kubectl apply -f -\napiVersion: certificates.k8s.io/v1beta1\nkind: CertificateSigningRequest\nmetadata:\n  name: example\nspec:\n  request: $(cat server.csr | base64 | tr -d '\\n')\n  usages:\n  - digital signature\n  - key encipherment\n  - server auth\nEOF\n```\n你能看到的输出类似于：\n```\ncertificatesigningrequest.certificates.k8s.io/example created\n```\n> Warning: certificates.k8s.io/v1beta1 CertificateSigningRequest is deprecated in v1.19+, unavailable in v1.22+; use certificates.k8s.io/v1 CertificateSigningRequest\n\nCSR 处于 Pending 状态。执行下面的命令你将可以看到：\n```\nkubectl get csr\n```\n```\nNAME AGE SIGNERNAME REQUESTOR CONDITION\nexample 17s kubernetes.io/legacy-unknown 100015926370-1650441195 Pending\n```\n# 批准证书签名请求（CSR）\n```\nkubectl certificate approve example\n```\n```\ncertificatesigningrequest.certificates.k8s.io/example approved\n```\n# 你现在应该能看到如下输出：\n```\nkubectl get csr\n```\n```\nNAME AGE SIGNERNAME REQUESTOR CONDITION\nexample 5m4s kubernetes.io/legacy-unknown 100015926370-1650441195 Approved,Issued\n```\n# 下载证书并使用它\n```\nkubectl get csr example -o jsonpath='{.status.certificate}' | base64 --decode > server.crt\n```\n现在你可以将 server.crt 和 server-key.pem 作为你的服务的 https 认证了。\n\n例如 kubebuilder 中使用 TLS 证书，将 server.crt 和 server-key.pem 放在 cert 目录中并修改名称为 tls.crt 和 tls.key，然后指定证书目录：\n```\nmgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{\n    Scheme:                 scheme,\n    MetricsBindAddress:     metricsAddr,\n    Port:                   9443,\n    HealthProbeBindAddress: probeAddr,\n    LeaderElection:         enableLeaderElection,\n    LeaderElectionID:       \"27e1b0af.blazehu.com\",\n    CertDir:                \"./cert/\",\n})\n```\n# 从 v1beta1 迁移到 v1\n上述例子使用 certificates.k8s.io/v1beta1 API 版本的 CertificateSigningRequest 不在 v1.22 版本中继续提供。官方迁移指南点这里。 我们可以使用 certificates.k8s.io/v1 API 版本，此 API 从 v1.19 版本开始可用。\n\n•certificates.k8s.io/v1 中需要额外注意的变更：\n•对于请求证书的 API 客户端而言：\n•spec.signerName 现在变成必需字段（参阅 已知的 Kubernetes 签署者）， 并且通过 certificates.k8s.io/v1 API 不可以创建签署者为 kubernetes.io/legacy-unknown 的请求\n•spec.usages 现在变成必需字段，其中不可以包含重复的字符串值， 并且只能包含已知的用法字符串\n\n# 创建你的证书\n通过运行以下命令生成私钥:\n```\ncat <<EOF | cfssl genkey - | cfssljson -bare server\n{\n  \"hosts\": [\n    \"my-svc.my-namespace.svc.cluster.local\",\n    \"my-pod.my-namespace.pod.cluster.local\",\n    \"192.0.2.24\",\n    \"10.0.34.2\"\n  ],\n  \"CN\": \"my-pod.my-namespace.pod.cluster.local\",\n  \"key\": {\n    \"algo\": \"ecdsa\",\n    \"size\": 256\n  }\n}\nEOF\n```\n# 创建证书签名请求（CSR）\n这里 csr signerName 不能是 kubernetes.io/legacy-unknown，演示我们随便指定一个为 example.com/serving，v1beta1 版本默认是 kubernetes.io/legacy-unknown。\n```\ncat <<EOF | kubectl apply -f -\napiVersion: certificates.k8s.io/v1\nkind: CertificateSigningRequest\nmetadata:\n  name: example\nspec:\n  request: $(cat server.csr | base64 | tr -d '\\n')\n  signerName: example.com/serving\n  usages:\n  - digital signature\n  - key encipherment\n  - server auth\nEOF\n```\n\n# 批准证书签名请求（CSR）\n```\nkubectl certificate approve example\n```\n```\ncertificatesigningrequest.certificates.k8s.io/example approved\n```\n你现在应该能看到如下输出：\n```\nkubectl get csr\n```\n```\nNAME AGE SIGNERNAME REQUESTOR CONDITION\nexample 11s example.com/serving 100015926370-1650441195 Approved\n```\n这里可以看到证书请求已被批准，但是没有自动签名，正在等待请求的签名者对其签名。\n\n# 签名证书签名请求（CSR）\n我们扮演证书签署者的角色，颁发证书并将其上传到 API 服务器。\n\n## 创建证书颁发机构\n通过运行以下命令创建签名证书:\n```\ncat <<EOF | cfssl gencert -initca - | cfssljson -bare ca\n{\n  \"CN\": \"example.com/serving\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  }\n}\nEOF\n```\n\n这会产生一个证书颁发机构密钥文件（ca-key.pem）和证书（ca.pem）。\n\n## 颁发证书\n创建文件 server-signing-config.json 内容如下：\n```\n{\n  \"signing\": {\n    \"default\": {\n      \"usages\": [\n        \"digital signature\",\n        \"key encipherment\",\n        \"server auth\"\n      ],\n      \"expiry\": \"876000h\",\n      \"ca_constraint\": {\n        \"is_ca\": false\n      }\n    }\n  }\n}\n```\n\n使用 server-signing-config.json 签名配置、证书颁发机构密钥文件和证书来签署证书请求：\n```\nkubectl get csr example -o jsonpath='{.spec.request}' | \\\nbase64 --decode | \\\ncfssl sign -ca ca.pem -ca-key ca-key.pem -config server-signing-config.json - | \\\ncfssljson -bare ca-signed-server\n```\n这会生成一个签名的服务证书文件，ca-signed-server.pem。\n\n## 上传签名证书\n```\nkubectl get csr example -o json | \\\njq '.status.certificate = \"'$(base64 ca-signed-server.pem | tr -d '\\n')'\"' | \\\nkubectl replace --raw /apis/certificates.k8s.io/v1/certificatesigningrequests/example/status -f -\n```\n批准 CSR 并上传签名证书后，你现在应该能看到如下输出：\n```\nkubectl get csr\n```\n```\nNAME AGE SIGNERNAME REQUESTOR CONDITION\nexample 10m example.com/serving 100015926370-1650441195 Approved,Issued\n```\n这是你可以正常下载证书并使用它了。\n\n# 参考文档\n•https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/\n•https://kubernetes.io/zh-cn/docs/tasks/tls/managing-tls-in-a-cluster/#configuring-your-cluster-to-provide-signing\n•https://kubernetes.io/zh-cn/docs/reference/using-api/deprecation-guide/","slug":"kubebuilder-webhook","published":1,"date":"2023-05-23T03:35:30.332Z","updated":"2023-05-25T16:05:35.973Z","_id":"clhzqmhfy0001w8f861i90wy2","comments":1,"layout":"post","photos":[],"link":"","content":"<p>在编写一个准入 Webhook 服务时，需要配置相关证书，k8s 提供了 api 用于对用户自主创建的证书进行认证签发。以下部分演示为 Webhook 服务创建 TLS 证书。</p>\n<h1 id=\"创建-tls-证书\"><a class=\"markdownIt-Anchor\" href=\"#创建-tls-证书\"></a> 创建 TLS 证书</h1>\n<h2 id=\"创建你的证书\"><a class=\"markdownIt-Anchor\" href=\"#创建你的证书\"></a> 创建你的证书</h2>\n<p>通过运行以下命令生成私钥:</p>\n<figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;EOF | <span class=\"type\">cfssl</span> genkey - | <span class=\"type\">cfssljson</span> -bare server</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;my-svc.my-namespace.svc.cluster.local&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;my-pod.my-namespace.pod.cluster.local&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;192.0.2.24&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.34.2&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;my-pod.my-namespace.pod.cluster.local&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;ecdsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: <span class=\"number\">256</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<p>此命令生成两个文件；它生成包含 PEM 编码 PKCS#10 证书请求的 server.csr， 以及 PEM 编码密钥的 server-key.pem，用于待生成的证书。</p>\n<h1 id=\"创建证书签名请求csr\"><a class=\"markdownIt-Anchor\" href=\"#创建证书签名请求csr\"></a> 创建证书签名请求（CSR）</h1>\n<figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">cat &lt;&lt;EOF | kubectl apply -f -</span></span><br><span class=\"line\"><span class=\"attribute\">apiVersion</span><span class=\"punctuation\">:</span> <span class=\"string\">certificates.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attribute\">kind</span><span class=\"punctuation\">:</span> <span class=\"string\">CertificateSigningRequest</span></span><br><span class=\"line\"><span class=\"attribute\">metadata</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"attribute\">name</span><span class=\"punctuation\">:</span> <span class=\"string\">example</span></span><br><span class=\"line\"><span class=\"attribute\">spec</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"attribute\">request</span><span class=\"punctuation\">:</span> <span class=\"string\">$(cat server.csr | base64 | tr -d &#x27;\\n&#x27;)</span></span><br><span class=\"line\">  <span class=\"attribute\">usages</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">digital signature</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">key encipherment</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">server auth</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<p>你能看到的输出类似于：</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certificatesigningrequest<span class=\"selector-class\">.certificates</span><span class=\"selector-class\">.k8s</span>.io/example created</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>Warning: <a href=\"http://certificates.k8s.io/v1beta1\">certificates.k8s.io/v1beta1</a> CertificateSigningRequest is deprecated in v1.19+, unavailable in v1.22+; use <a href=\"http://certificates.k8s.io/v1\">certificates.k8s.io/v1</a> CertificateSigningRequest</p>\n</blockquote>\n<p>CSR 处于 Pending 状态。执行下面的命令你将可以看到：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">get</span> csr</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">NAME</span> AGE SIGNERNAME REQUESTOR CONDITION</span><br><span class=\"line\"><span class=\"attribute\">example</span> <span class=\"number\">17</span>s kubernetes.io/legacy-unknown <span class=\"number\">100015926370</span>-<span class=\"number\">1650441195</span> Pending</span><br></pre></td></tr></table></figure>\n<h1 id=\"批准证书签名请求csr\"><a class=\"markdownIt-Anchor\" href=\"#批准证书签名请求csr\"></a> 批准证书签名请求（CSR）</h1>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">kubectl certificate approve example</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certificatesigningrequest<span class=\"selector-class\">.certificates</span><span class=\"selector-class\">.k8s</span>.io/example approved</span><br></pre></td></tr></table></figure>\n<h1 id=\"你现在应该能看到如下输出\"><a class=\"markdownIt-Anchor\" href=\"#你现在应该能看到如下输出\"></a> 你现在应该能看到如下输出：</h1>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">get</span> csr</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">NAME</span> AGE SIGNERNAME REQUESTOR CONDITION</span><br><span class=\"line\"><span class=\"attribute\">example</span> <span class=\"number\">5</span>m4s kubernetes.io/legacy-unknown <span class=\"number\">100015926370</span>-<span class=\"number\">1650441195</span> Approved,Issued</span><br></pre></td></tr></table></figure>\n<h1 id=\"下载证书并使用它\"><a class=\"markdownIt-Anchor\" href=\"#下载证书并使用它\"></a> 下载证书并使用它</h1>\n<figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">get</span> csr <span class=\"built_in\">example</span> -o jsonpath=&#x27;&#123;.<span class=\"built_in\">status</span>.certificate&#125;&#x27; | <span class=\"built_in\">base64</span> --decode &gt; server.crt</span><br></pre></td></tr></table></figure>\n<p>现在你可以将 server.crt 和 server-key.pem 作为你的服务的 https 认证了。</p>\n<p>例如 kubebuilder 中使用 TLS 证书，将 server.crt 和 server-key.pem 放在 cert 目录中并修改名称为 tls.crt 和 tls.key，然后指定证书目录：</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options<span class=\"punctuation\">&#123;</span></span><br><span class=\"line\"><span class=\"symbol\">    Scheme:</span>                 scheme,</span><br><span class=\"line\"><span class=\"symbol\">    MetricsBindAddress:</span>     metricsAddr,</span><br><span class=\"line\"><span class=\"symbol\">    Port:</span>                   <span class=\"number\">9443</span>,</span><br><span class=\"line\"><span class=\"symbol\">    HealthProbeBindAddress:</span> probeAddr,</span><br><span class=\"line\"><span class=\"symbol\">    LeaderElection:</span>         enableLeaderElection,</span><br><span class=\"line\"><span class=\"symbol\">    LeaderElectionID:</span>       <span class=\"string\">&quot;27e1b0af.blazehu.com&quot;</span>,</span><br><span class=\"line\"><span class=\"symbol\">    CertDir:</span>                <span class=\"string\">&quot;./cert/&quot;</span>,</span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span>)</span><br></pre></td></tr></table></figure>\n<h1 id=\"从-v1beta1-迁移到-v1\"><a class=\"markdownIt-Anchor\" href=\"#从-v1beta1-迁移到-v1\"></a> 从 v1beta1 迁移到 v1</h1>\n<p>上述例子使用 <a href=\"http://certificates.k8s.io/v1beta1\">certificates.k8s.io/v1beta1</a> API 版本的 CertificateSigningRequest 不在 v1.22 版本中继续提供。官方迁移指南点这里。 我们可以使用 <a href=\"http://certificates.k8s.io/v1\">certificates.k8s.io/v1</a> API 版本，此 API 从 v1.19 版本开始可用。</p>\n<p>•<a href=\"http://certificates.k8s.io/v1\">certificates.k8s.io/v1</a> 中需要额外注意的变更：<br />\n•对于请求证书的 API 客户端而言：<br />\n•spec.signerName 现在变成必需字段（参阅 已知的 Kubernetes 签署者）， 并且通过 <a href=\"http://certificates.k8s.io/v1\">certificates.k8s.io/v1</a> API 不可以创建签署者为 <a href=\"http://kubernetes.io/legacy-unknown\">kubernetes.io/legacy-unknown</a> 的请求<br />\n•spec.usages 现在变成必需字段，其中不可以包含重复的字符串值， 并且只能包含已知的用法字符串</p>\n<h1 id=\"创建你的证书-2\"><a class=\"markdownIt-Anchor\" href=\"#创建你的证书-2\"></a> 创建你的证书</h1>\n<p>通过运行以下命令生成私钥:</p>\n<figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;EOF | <span class=\"type\">cfssl</span> genkey - | <span class=\"type\">cfssljson</span> -bare server</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;my-svc.my-namespace.svc.cluster.local&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;my-pod.my-namespace.pod.cluster.local&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;192.0.2.24&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.34.2&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;my-pod.my-namespace.pod.cluster.local&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;ecdsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: <span class=\"number\">256</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h1 id=\"创建证书签名请求csr-2\"><a class=\"markdownIt-Anchor\" href=\"#创建证书签名请求csr-2\"></a> 创建证书签名请求（CSR）</h1>\n<p>这里 csr signerName 不能是 <a href=\"http://kubernetes.io/legacy-unknown%EF%BC%8C%E6%BC%94%E7%A4%BA%E6%88%91%E4%BB%AC%E9%9A%8F%E4%BE%BF%E6%8C%87%E5%AE%9A%E4%B8%80%E4%B8%AA%E4%B8%BA\">kubernetes.io/legacy-unknown，演示我们随便指定一个为</a> <a href=\"http://example.com/serving%EF%BC%8Cv1beta1\">example.com/serving，v1beta1</a> 版本默认是 <a href=\"http://kubernetes.io/legacy-unknown%E3%80%82\">kubernetes.io/legacy-unknown。</a></p>\n<figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">cat &lt;&lt;EOF | kubectl apply -f -</span></span><br><span class=\"line\"><span class=\"attribute\">apiVersion</span><span class=\"punctuation\">:</span> <span class=\"string\">certificates.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attribute\">kind</span><span class=\"punctuation\">:</span> <span class=\"string\">CertificateSigningRequest</span></span><br><span class=\"line\"><span class=\"attribute\">metadata</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"attribute\">name</span><span class=\"punctuation\">:</span> <span class=\"string\">example</span></span><br><span class=\"line\"><span class=\"attribute\">spec</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"attribute\">request</span><span class=\"punctuation\">:</span> <span class=\"string\">$(cat server.csr | base64 | tr -d &#x27;\\n&#x27;)</span></span><br><span class=\"line\">  <span class=\"attribute\">signerName</span><span class=\"punctuation\">:</span> <span class=\"string\">example.com/serving</span></span><br><span class=\"line\">  <span class=\"attribute\">usages</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">digital signature</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">key encipherment</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">server auth</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h1 id=\"批准证书签名请求csr-2\"><a class=\"markdownIt-Anchor\" href=\"#批准证书签名请求csr-2\"></a> 批准证书签名请求（CSR）</h1>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">kubectl certificate approve example</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certificatesigningrequest<span class=\"selector-class\">.certificates</span><span class=\"selector-class\">.k8s</span>.io/example approved</span><br></pre></td></tr></table></figure>\n<p>你现在应该能看到如下输出：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">get</span> csr</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">NAME</span> AGE SIGNERNAME REQUESTOR CONDITION</span><br><span class=\"line\"><span class=\"attribute\">example</span> <span class=\"number\">11</span>s example.com/serving <span class=\"number\">100015926370</span>-<span class=\"number\">1650441195</span> Approved</span><br></pre></td></tr></table></figure>\n<p>这里可以看到证书请求已被批准，但是没有自动签名，正在等待请求的签名者对其签名。</p>\n<h1 id=\"签名证书签名请求csr\"><a class=\"markdownIt-Anchor\" href=\"#签名证书签名请求csr\"></a> 签名证书签名请求（CSR）</h1>\n<p>我们扮演证书签署者的角色，颁发证书并将其上传到 API 服务器。</p>\n<h2 id=\"创建证书颁发机构\"><a class=\"markdownIt-Anchor\" href=\"#创建证书颁发机构\"></a> 创建证书颁发机构</h2>\n<p>通过运行以下命令创建签名证书:</p>\n<figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;EOF | <span class=\"type\">cfssl</span> gencert -initca - | <span class=\"type\">cfssljson</span> -bare ca</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;example.com/serving&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: <span class=\"number\">2048</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<p>这会产生一个证书颁发机构密钥文件（ca-key.pem）和证书（ca.pem）。</p>\n<h2 id=\"颁发证书\"><a class=\"markdownIt-Anchor\" href=\"#颁发证书\"></a> 颁发证书</h2>\n<p>创建文件 server-signing-config.json 内容如下：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;signing&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;default&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;usages&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"string\">&quot;digital signature&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"string\">&quot;key encipherment&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"string\">&quot;server auth&quot;</span></span><br><span class=\"line\">      <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;expiry&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;876000h&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;ca_constraint&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;is_ca&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>使用 server-signing-config.json 签名配置、证书颁发机构密钥文件和证书来签署证书请求：</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">get</span> csr example -<span class=\"keyword\">o</span> jsonpath=<span class=\"string\">&#x27;&#123;.spec.request&#125;&#x27;</span> | \\</span><br><span class=\"line\">base64 --decode | \\</span><br><span class=\"line\">cfssl <span class=\"keyword\">sign</span> -<span class=\"keyword\">ca</span> <span class=\"keyword\">ca</span>.pem -<span class=\"keyword\">ca</span>-key <span class=\"keyword\">ca</span>-key.pem -config server-signing-config.json - | \\</span><br><span class=\"line\">cfssljson -bare <span class=\"keyword\">ca</span>-signed-server</span><br></pre></td></tr></table></figure>\n<p>这会生成一个签名的服务证书文件，ca-signed-server.pem。</p>\n<h2 id=\"上传签名证书\"><a class=\"markdownIt-Anchor\" href=\"#上传签名证书\"></a> 上传签名证书</h2>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get csr example -o json | \\</span><br><span class=\"line\">jq <span class=\"string\">&#x27;.status.certificate = &quot;&#x27;</span>$(base64 ca-signed-server.pem | tr -d <span class=\"string\">&#x27;\\n&#x27;</span>)<span class=\"string\">&#x27;&quot;&#x27;</span> | \\</span><br><span class=\"line\">kubectl replace --raw <span class=\"regexp\">/apis/</span>certificates.k8s.io<span class=\"regexp\">/v1/</span>certificatesigningrequests<span class=\"regexp\">/example/</span>status -f -</span><br></pre></td></tr></table></figure>\n<p>批准 CSR 并上传签名证书后，你现在应该能看到如下输出：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">get</span> csr</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">NAME</span> AGE SIGNERNAME REQUESTOR CONDITION</span><br><span class=\"line\"><span class=\"attribute\">example</span> <span class=\"number\">10</span>m example.com/serving <span class=\"number\">100015926370</span>-<span class=\"number\">1650441195</span> Approved,Issued</span><br></pre></td></tr></table></figure>\n<p>这是你可以正常下载证书并使用它了。</p>\n<h1 id=\"参考文档\"><a class=\"markdownIt-Anchor\" href=\"#参考文档\"></a> 参考文档</h1>\n<p>•<a href=\"https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/\">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/</a><br />\n•<a href=\"https://kubernetes.io/zh-cn/docs/tasks/tls/managing-tls-in-a-cluster/#configuring-your-cluster-to-provide-signing\">https://kubernetes.io/zh-cn/docs/tasks/tls/managing-tls-in-a-cluster/#configuring-your-cluster-to-provide-signing</a><br />\n•<a href=\"https://kubernetes.io/zh-cn/docs/reference/using-api/deprecation-guide/\">https://kubernetes.io/zh-cn/docs/reference/using-api/deprecation-guide/</a></p>\n","site":{"data":{"links":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}},"gallery":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}},"excerpt":"","more":"<p>在编写一个准入 Webhook 服务时，需要配置相关证书，k8s 提供了 api 用于对用户自主创建的证书进行认证签发。以下部分演示为 Webhook 服务创建 TLS 证书。</p>\n<h1 id=\"创建-tls-证书\"><a class=\"markdownIt-Anchor\" href=\"#创建-tls-证书\"></a> 创建 TLS 证书</h1>\n<h2 id=\"创建你的证书\"><a class=\"markdownIt-Anchor\" href=\"#创建你的证书\"></a> 创建你的证书</h2>\n<p>通过运行以下命令生成私钥:</p>\n<figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;EOF | <span class=\"type\">cfssl</span> genkey - | <span class=\"type\">cfssljson</span> -bare server</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;my-svc.my-namespace.svc.cluster.local&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;my-pod.my-namespace.pod.cluster.local&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;192.0.2.24&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.34.2&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;my-pod.my-namespace.pod.cluster.local&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;ecdsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: <span class=\"number\">256</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<p>此命令生成两个文件；它生成包含 PEM 编码 PKCS#10 证书请求的 server.csr， 以及 PEM 编码密钥的 server-key.pem，用于待生成的证书。</p>\n<h1 id=\"创建证书签名请求csr\"><a class=\"markdownIt-Anchor\" href=\"#创建证书签名请求csr\"></a> 创建证书签名请求（CSR）</h1>\n<figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">cat &lt;&lt;EOF | kubectl apply -f -</span></span><br><span class=\"line\"><span class=\"attribute\">apiVersion</span><span class=\"punctuation\">:</span> <span class=\"string\">certificates.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attribute\">kind</span><span class=\"punctuation\">:</span> <span class=\"string\">CertificateSigningRequest</span></span><br><span class=\"line\"><span class=\"attribute\">metadata</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"attribute\">name</span><span class=\"punctuation\">:</span> <span class=\"string\">example</span></span><br><span class=\"line\"><span class=\"attribute\">spec</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"attribute\">request</span><span class=\"punctuation\">:</span> <span class=\"string\">$(cat server.csr | base64 | tr -d &#x27;\\n&#x27;)</span></span><br><span class=\"line\">  <span class=\"attribute\">usages</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">digital signature</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">key encipherment</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">server auth</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<p>你能看到的输出类似于：</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certificatesigningrequest<span class=\"selector-class\">.certificates</span><span class=\"selector-class\">.k8s</span>.io/example created</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>Warning: <a href=\"http://certificates.k8s.io/v1beta1\">certificates.k8s.io/v1beta1</a> CertificateSigningRequest is deprecated in v1.19+, unavailable in v1.22+; use <a href=\"http://certificates.k8s.io/v1\">certificates.k8s.io/v1</a> CertificateSigningRequest</p>\n</blockquote>\n<p>CSR 处于 Pending 状态。执行下面的命令你将可以看到：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">get</span> csr</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">NAME</span> AGE SIGNERNAME REQUESTOR CONDITION</span><br><span class=\"line\"><span class=\"attribute\">example</span> <span class=\"number\">17</span>s kubernetes.io/legacy-unknown <span class=\"number\">100015926370</span>-<span class=\"number\">1650441195</span> Pending</span><br></pre></td></tr></table></figure>\n<h1 id=\"批准证书签名请求csr\"><a class=\"markdownIt-Anchor\" href=\"#批准证书签名请求csr\"></a> 批准证书签名请求（CSR）</h1>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">kubectl certificate approve example</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certificatesigningrequest<span class=\"selector-class\">.certificates</span><span class=\"selector-class\">.k8s</span>.io/example approved</span><br></pre></td></tr></table></figure>\n<h1 id=\"你现在应该能看到如下输出\"><a class=\"markdownIt-Anchor\" href=\"#你现在应该能看到如下输出\"></a> 你现在应该能看到如下输出：</h1>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">get</span> csr</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">NAME</span> AGE SIGNERNAME REQUESTOR CONDITION</span><br><span class=\"line\"><span class=\"attribute\">example</span> <span class=\"number\">5</span>m4s kubernetes.io/legacy-unknown <span class=\"number\">100015926370</span>-<span class=\"number\">1650441195</span> Approved,Issued</span><br></pre></td></tr></table></figure>\n<h1 id=\"下载证书并使用它\"><a class=\"markdownIt-Anchor\" href=\"#下载证书并使用它\"></a> 下载证书并使用它</h1>\n<figure class=\"highlight maxima\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">get</span> csr <span class=\"built_in\">example</span> -o jsonpath=&#x27;&#123;.<span class=\"built_in\">status</span>.certificate&#125;&#x27; | <span class=\"built_in\">base64</span> --decode &gt; server.crt</span><br></pre></td></tr></table></figure>\n<p>现在你可以将 server.crt 和 server-key.pem 作为你的服务的 https 认证了。</p>\n<p>例如 kubebuilder 中使用 TLS 证书，将 server.crt 和 server-key.pem 放在 cert 目录中并修改名称为 tls.crt 和 tls.key，然后指定证书目录：</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options<span class=\"punctuation\">&#123;</span></span><br><span class=\"line\"><span class=\"symbol\">    Scheme:</span>                 scheme,</span><br><span class=\"line\"><span class=\"symbol\">    MetricsBindAddress:</span>     metricsAddr,</span><br><span class=\"line\"><span class=\"symbol\">    Port:</span>                   <span class=\"number\">9443</span>,</span><br><span class=\"line\"><span class=\"symbol\">    HealthProbeBindAddress:</span> probeAddr,</span><br><span class=\"line\"><span class=\"symbol\">    LeaderElection:</span>         enableLeaderElection,</span><br><span class=\"line\"><span class=\"symbol\">    LeaderElectionID:</span>       <span class=\"string\">&quot;27e1b0af.blazehu.com&quot;</span>,</span><br><span class=\"line\"><span class=\"symbol\">    CertDir:</span>                <span class=\"string\">&quot;./cert/&quot;</span>,</span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span>)</span><br></pre></td></tr></table></figure>\n<h1 id=\"从-v1beta1-迁移到-v1\"><a class=\"markdownIt-Anchor\" href=\"#从-v1beta1-迁移到-v1\"></a> 从 v1beta1 迁移到 v1</h1>\n<p>上述例子使用 <a href=\"http://certificates.k8s.io/v1beta1\">certificates.k8s.io/v1beta1</a> API 版本的 CertificateSigningRequest 不在 v1.22 版本中继续提供。官方迁移指南点这里。 我们可以使用 <a href=\"http://certificates.k8s.io/v1\">certificates.k8s.io/v1</a> API 版本，此 API 从 v1.19 版本开始可用。</p>\n<p>•<a href=\"http://certificates.k8s.io/v1\">certificates.k8s.io/v1</a> 中需要额外注意的变更：<br />\n•对于请求证书的 API 客户端而言：<br />\n•spec.signerName 现在变成必需字段（参阅 已知的 Kubernetes 签署者）， 并且通过 <a href=\"http://certificates.k8s.io/v1\">certificates.k8s.io/v1</a> API 不可以创建签署者为 <a href=\"http://kubernetes.io/legacy-unknown\">kubernetes.io/legacy-unknown</a> 的请求<br />\n•spec.usages 现在变成必需字段，其中不可以包含重复的字符串值， 并且只能包含已知的用法字符串</p>\n<h1 id=\"创建你的证书-2\"><a class=\"markdownIt-Anchor\" href=\"#创建你的证书-2\"></a> 创建你的证书</h1>\n<p>通过运行以下命令生成私钥:</p>\n<figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;EOF | <span class=\"type\">cfssl</span> genkey - | <span class=\"type\">cfssljson</span> -bare server</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;my-svc.my-namespace.svc.cluster.local&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;my-pod.my-namespace.pod.cluster.local&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;192.0.2.24&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.34.2&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;my-pod.my-namespace.pod.cluster.local&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;ecdsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: <span class=\"number\">256</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h1 id=\"创建证书签名请求csr-2\"><a class=\"markdownIt-Anchor\" href=\"#创建证书签名请求csr-2\"></a> 创建证书签名请求（CSR）</h1>\n<p>这里 csr signerName 不能是 <a href=\"http://kubernetes.io/legacy-unknown%EF%BC%8C%E6%BC%94%E7%A4%BA%E6%88%91%E4%BB%AC%E9%9A%8F%E4%BE%BF%E6%8C%87%E5%AE%9A%E4%B8%80%E4%B8%AA%E4%B8%BA\">kubernetes.io/legacy-unknown，演示我们随便指定一个为</a> <a href=\"http://example.com/serving%EF%BC%8Cv1beta1\">example.com/serving，v1beta1</a> 版本默认是 <a href=\"http://kubernetes.io/legacy-unknown%E3%80%82\">kubernetes.io/legacy-unknown。</a></p>\n<figure class=\"highlight nestedtext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">cat &lt;&lt;EOF | kubectl apply -f -</span></span><br><span class=\"line\"><span class=\"attribute\">apiVersion</span><span class=\"punctuation\">:</span> <span class=\"string\">certificates.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attribute\">kind</span><span class=\"punctuation\">:</span> <span class=\"string\">CertificateSigningRequest</span></span><br><span class=\"line\"><span class=\"attribute\">metadata</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"attribute\">name</span><span class=\"punctuation\">:</span> <span class=\"string\">example</span></span><br><span class=\"line\"><span class=\"attribute\">spec</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"attribute\">request</span><span class=\"punctuation\">:</span> <span class=\"string\">$(cat server.csr | base64 | tr -d &#x27;\\n&#x27;)</span></span><br><span class=\"line\">  <span class=\"attribute\">signerName</span><span class=\"punctuation\">:</span> <span class=\"string\">example.com/serving</span></span><br><span class=\"line\">  <span class=\"attribute\">usages</span><span class=\"punctuation\">:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">digital signature</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">key encipherment</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">server auth</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h1 id=\"批准证书签名请求csr-2\"><a class=\"markdownIt-Anchor\" href=\"#批准证书签名请求csr-2\"></a> 批准证书签名请求（CSR）</h1>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">kubectl certificate approve example</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certificatesigningrequest<span class=\"selector-class\">.certificates</span><span class=\"selector-class\">.k8s</span>.io/example approved</span><br></pre></td></tr></table></figure>\n<p>你现在应该能看到如下输出：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">get</span> csr</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">NAME</span> AGE SIGNERNAME REQUESTOR CONDITION</span><br><span class=\"line\"><span class=\"attribute\">example</span> <span class=\"number\">11</span>s example.com/serving <span class=\"number\">100015926370</span>-<span class=\"number\">1650441195</span> Approved</span><br></pre></td></tr></table></figure>\n<p>这里可以看到证书请求已被批准，但是没有自动签名，正在等待请求的签名者对其签名。</p>\n<h1 id=\"签名证书签名请求csr\"><a class=\"markdownIt-Anchor\" href=\"#签名证书签名请求csr\"></a> 签名证书签名请求（CSR）</h1>\n<p>我们扮演证书签署者的角色，颁发证书并将其上传到 API 服务器。</p>\n<h2 id=\"创建证书颁发机构\"><a class=\"markdownIt-Anchor\" href=\"#创建证书颁发机构\"></a> 创建证书颁发机构</h2>\n<p>通过运行以下命令创建签名证书:</p>\n<figure class=\"highlight coq\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;EOF | <span class=\"type\">cfssl</span> gencert -initca - | <span class=\"type\">cfssljson</span> -bare ca</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;example.com/serving&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: <span class=\"number\">2048</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<p>这会产生一个证书颁发机构密钥文件（ca-key.pem）和证书（ca.pem）。</p>\n<h2 id=\"颁发证书\"><a class=\"markdownIt-Anchor\" href=\"#颁发证书\"></a> 颁发证书</h2>\n<p>创建文件 server-signing-config.json 内容如下：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;signing&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;default&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;usages&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"string\">&quot;digital signature&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"string\">&quot;key encipherment&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"string\">&quot;server auth&quot;</span></span><br><span class=\"line\">      <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;expiry&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;876000h&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;ca_constraint&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;is_ca&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>使用 server-signing-config.json 签名配置、证书颁发机构密钥文件和证书来签署证书请求：</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">get</span> csr example -<span class=\"keyword\">o</span> jsonpath=<span class=\"string\">&#x27;&#123;.spec.request&#125;&#x27;</span> | \\</span><br><span class=\"line\">base64 --decode | \\</span><br><span class=\"line\">cfssl <span class=\"keyword\">sign</span> -<span class=\"keyword\">ca</span> <span class=\"keyword\">ca</span>.pem -<span class=\"keyword\">ca</span>-key <span class=\"keyword\">ca</span>-key.pem -config server-signing-config.json - | \\</span><br><span class=\"line\">cfssljson -bare <span class=\"keyword\">ca</span>-signed-server</span><br></pre></td></tr></table></figure>\n<p>这会生成一个签名的服务证书文件，ca-signed-server.pem。</p>\n<h2 id=\"上传签名证书\"><a class=\"markdownIt-Anchor\" href=\"#上传签名证书\"></a> 上传签名证书</h2>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get csr example -o json | \\</span><br><span class=\"line\">jq <span class=\"string\">&#x27;.status.certificate = &quot;&#x27;</span>$(base64 ca-signed-server.pem | tr -d <span class=\"string\">&#x27;\\n&#x27;</span>)<span class=\"string\">&#x27;&quot;&#x27;</span> | \\</span><br><span class=\"line\">kubectl replace --raw <span class=\"regexp\">/apis/</span>certificates.k8s.io<span class=\"regexp\">/v1/</span>certificatesigningrequests<span class=\"regexp\">/example/</span>status -f -</span><br></pre></td></tr></table></figure>\n<p>批准 CSR 并上传签名证书后，你现在应该能看到如下输出：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">get</span> csr</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">NAME</span> AGE SIGNERNAME REQUESTOR CONDITION</span><br><span class=\"line\"><span class=\"attribute\">example</span> <span class=\"number\">10</span>m example.com/serving <span class=\"number\">100015926370</span>-<span class=\"number\">1650441195</span> Approved,Issued</span><br></pre></td></tr></table></figure>\n<p>这是你可以正常下载证书并使用它了。</p>\n<h1 id=\"参考文档\"><a class=\"markdownIt-Anchor\" href=\"#参考文档\"></a> 参考文档</h1>\n<p>•<a href=\"https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/\">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/</a><br />\n•<a href=\"https://kubernetes.io/zh-cn/docs/tasks/tls/managing-tls-in-a-cluster/#configuring-your-cluster-to-provide-signing\">https://kubernetes.io/zh-cn/docs/tasks/tls/managing-tls-in-a-cluster/#configuring-your-cluster-to-provide-signing</a><br />\n•<a href=\"https://kubernetes.io/zh-cn/docs/reference/using-api/deprecation-guide/\">https://kubernetes.io/zh-cn/docs/reference/using-api/deprecation-guide/</a></p>\n"},{"title":"Kubebuilder Best Practices","sidebar":"none","_content":"Kubebuilder is a framework for building Kubernetes APIs using custom resource definitions (CRDs).\n> Note: kubebuilder can save us a lot of work and make developing CRDs and adminsion webhooks incredibly easy.\n# Installation\n```\n# download kubebuilder and install locally.\ncurl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/$(go env GOOS)/$(go env GOARCH)\nchmod +x kubebuilder && mv kubebuilder /usr/local/bin/\n```\n# Create a Project \n> Create a directory, and then run the init command inside of it to initialize a new project. Follows an example.\n```\n[marklu@MacBook ~]$ mkdir ~/Project/workspace-go/example\n[marklu@MacBook ~]$ cd ~/Project/workspace-go/example\n[marklu@MacBook ~]$ kubebuilder init --domain marklu.com --owner \"marklu\" --repo marklu.com/example\nWriting kustomize manifests for you to edit...\nWriting scaffold for you to edit...\nGet controller runtime:\n$ go get sigs.k8s.io/controller-runtime@v0.10.0\nUpdate dependencies:\n$ go mod tidy\nNext: define a resource with:\n$ kubebuilder create api\n```\n> If your project is initialized within GOPATH, the implicitly called go mod init will interpolate the module path for you. Otherwise –repo=must be set.\n\n# Adding a new API\n```\n[marklu@MacBook ~]$ kubebuilder create api --group cos --version v1 --kind Bucket\nCreate Resource [y/n]\ny\nCreate Controller [y/n]\ny\nWriting kustomize manifests for you to edit...\nWriting scaffold for you to edit...\napi/v1/bucket_types.go\ncontrollers/bucket_controller.go\nUpdate dependencies:\n$ go mod tidy\nRunning make:\n$ make generate\ngo: creating new go.mod: module tmp\nDownloading sigs.k8s.io/controller-tools/cmd/controller-gen@v0.7.0\ngo get: added sigs.k8s.io/controller-tools v0.7.0\n/Users/huyuhan/Project/workspace-go/example/bin/controller-gen object:headerFile=\"hack/boilerplate.go.txt\" paths=\"./...\"\nNext: implement your new API and generate the manifests (e.g. CRDs,CRs) with:\n$ make manifests\n```\n\n# Designing an API\n> api/v1/bucket_types.go\n```\n// BucketSpec defines the desired state of Bucket\ntype BucketSpec struct {\n\t// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster\n\t// Important: Run \"make\" to regenerate code after modifying this file\n\n\t// Foo is an example field of Bucket. Edit bucket_types.go to remove/update\n\tName   string `json:\"name,omitempty\"`\n\tRegion string `json:\"region,omitempty\"`\n\tACL    string `json:\"acl,omitempty\"`\n}\n```\n\n# Implementing a controller\n>controllers/cos.go \n```\npackage controllers\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"github.com/tencentyun/cos-go-sdk-v5\"\n\t\"net/http\"\n\t\"net/url\"\n)\n\ntype CosStorage struct {\n\tclient          *cos.Client\n\taccessKeyId     string\n\taccessKeySecret string\n\tbucket          string\n\tregion          string\n}\n\n// NewCosStorage endpoint: https://cloud.tencent.com/document/product/436/6224\nfunc NewCosStorage(region, bucketName string) *CosStorage {\n\turl, _ := url.Parse(fmt.Sprintf(\"https://%s.cos.%s.myqcloud.com\", bucketName, region))\n\taccessKeyId := \"\"\n\taccessKeySecret := \"\"\n\tb := &cos.BaseURL{BucketURL: url}\n\tclient := cos.NewClient(b, &http.Client{\n\t\tTransport: &cos.AuthorizationTransport{\n\t\t\tSecretID:  accessKeyId,\n\t\t\tSecretKey: accessKeySecret,\n\t\t},\n\t})\n\treturn &CosStorage{\n\t\tclient:          client,\n\t\taccessKeyId:     accessKeyId,\n\t\taccessKeySecret: accessKeySecret,\n\t\tregion:          region,\n\t\tbucket:          bucketName,\n\t}\n}\n\nfunc (c *CosStorage) Put(acl string) error {\n\topt := &cos.BucketPutOptions{\n\t\tXCosACL: acl,\n\t}\n\t_, err := c.client.Bucket.Put(context.Background(), opt)\n\treturn err\n}\n\nfunc (c *CosStorage) Delete() error {\n\t_, err := c.client.Bucket.Delete(context.Background())\n\treturn err\n}\n```\ncontrollers/bucket_controller.go\n> tips: Finalizers allow controllers to implement asynchronous pre-delete hooks. Let’s say you create an external resource (such as a storage bucket) for each object of your API type, and you want to delete the associated external resource on object’s deletion from Kubernetes, you can use a finalizer to do that.\n```\n/*\nCopyright 2022 marklu.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\npackage controllers\n\nimport (\n\t\"context\"\n\t\"k8s.io/apimachinery/pkg/runtime\"\n\tctrl \"sigs.k8s.io/controller-runtime\"\n\t\"sigs.k8s.io/controller-runtime/pkg/client\"\n\t\"sigs.k8s.io/controller-runtime/pkg/controller/controllerutil\"\n\t\"sigs.k8s.io/controller-runtime/pkg/log\"\n\n\tcosv1 \"marklu.com/example/api/v1\"\n)\n\n// BucketReconciler reconciles a Bucket object\ntype BucketReconciler struct {\n\tclient.Client\n\tScheme *runtime.Scheme\n}\n\nconst (\n\tbucketFinalizerName = \"bucket.cos.marklu.com/finalizer\"\n)\n\n//+kubebuilder:rbac:groups=cos.marklu.com,resources=buckets,verbs=get;list;watch;create;update;patch;delete\n//+kubebuilder:rbac:groups=cos.marklu.com,resources=buckets/status,verbs=get;update;patch\n//+kubebuilder:rbac:groups=cos.marklu.com,resources=buckets/finalizers,verbs=update\n\n// Reconcile is part of the main kubernetes reconciliation loop which aims to\n// move the current state of the cluster closer to the desired state.\n// TODO(user): Modify the Reconcile function to compare the state specified by\n// the Bucket object against the actual cluster state, and then\n// perform operations to make the cluster state reflect the state specified by\n// the user.\n//\n// For more details, check Reconcile and its Result here:\n// - https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.10.0/pkg/reconcile\nfunc (r *BucketReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {\n\tlogger := log.FromContext(ctx)\n\n\tbucket := &cosv1.Bucket{}\n\tif err := r.Get(ctx, req.NamespacedName, bucket); err != nil {\n\t\treturn ctrl.Result{}, client.IgnoreNotFound(err)\n\t}\n\n\t// examine DeletionTimestamp to determine if object is under deletion\n\tif bucket.ObjectMeta.DeletionTimestamp.IsZero() {\n\t\t// The object is not being deleted, so if it does not have our finalizer,\n\t\t// then lets add the finalizer and update the object. This is equivalent\n\t\t// registering our finalizer.\n\t\tif !controllerutil.ContainsFinalizer(bucket, bucketFinalizerName) {\n\t\t\tcontrollerutil.AddFinalizer(bucket, bucketFinalizerName)\n\t\t\tif err := r.Update(ctx, bucket); err != nil {\n\t\t\t\treturn ctrl.Result{}, err\n\t\t\t}\n\t\t} else {\n\t\t\tif err := r.updateExternalResources(bucket); err != nil {\n\t\t\t\tlogger.Error(err, \"unable to create Bucket\")\n\t\t\t\treturn ctrl.Result{}, err\n\t\t\t}\n\t\t\tlogger.Info(\"create Bucket succeed\")\n\t\t}\n\t} else {\n\t\t// The object is being deleted\n\t\tif controllerutil.ContainsFinalizer(bucket, bucketFinalizerName) {\n\t\t\t// our finalizer is present, so lets handle any external dependency\n\t\t\tif err := r.deleteExternalResources(bucket); err != nil {\n\t\t\t\t// if fail to delete the external dependency here, return with error\n\t\t\t\t// so that it can be retried\n\t\t\t\tlogger.Error(err, \"unable to delete Bucket\")\n\t\t\t\treturn ctrl.Result{}, err\n\t\t\t}\n\n\t\t\t// remove our finalizer from the list and update it.\n\t\t\tcontrollerutil.RemoveFinalizer(bucket, bucketFinalizerName)\n\t\t\tif err := r.Update(ctx, bucket); err != nil {\n\t\t\t\treturn ctrl.Result{}, err\n\t\t\t}\n\t\t\tlogger.Info(\"delete Bucket succeed\")\n\t\t}\n\n\t\t// Stop reconciliation as the item is being deleted\n\t\treturn ctrl.Result{}, nil\n\t}\n\n\t// bucket reconcile logic\n\treturn ctrl.Result{}, nil\n}\n\nfunc (r *BucketReconciler) updateExternalResources(bucket *cosv1.Bucket) error {\n\tcosClient := NewCosStorage(bucket.Spec.Region, bucket.Spec.Name)\n\treturn cosClient.Put(bucket.Spec.ACL)\n}\n\nfunc (r *BucketReconciler) deleteExternalResources(bucket *cosv1.Bucket) error {\n\tcosClient := NewCosStorage(bucket.Spec.Region, bucket.Spec.Name)\n\treturn cosClient.Delete()\n}\n\n// SetupWithManager sets up the controller with the Manager.\nfunc (r *BucketReconciler) SetupWithManager(mgr ctrl.Manager) error {\n\treturn ctrl.NewControllerManagedBy(mgr).\n\t\tFor(&cosv1.Bucket{}).\n\t\tComplete(r)\n}\n```\n# Test It Out\n> 1. Install the CRDs into the cluster (make install)\n```\n[marklu@MacBook ~]$ make install\n/Users/huyuhan/Project/workspace-go/example/bin/controller-gen rbac:roleName=manager-role crd webhook paths=\"./...\" output:crd:artifacts:config=config/crd/bases\n/Users/huyuhan/Project/workspace-go/example/bin/kustomize build config/crd | kubectl apply -f -\ncustomresourcedefinition.apiextensions.k8s.io/buckets.cos.marklu.com created\n```\n> 2. Run your controller (this will run in the foreground, so switch to a new terminal if you want to leave it running) (make run)\n```\n[marklu@MacBook ~]$ make run\n/Users/huyuhan/Project/workspace-go/example/bin/controller-gen rbac:roleName=manager-role crd webhook paths=\"./...\" output:crd:artifacts:config=config/crd/bases\n/Users/huyuhan/Project/workspace-go/example/bin/controller-gen object:headerFile=\"hack/boilerplate.go.txt\" paths=\"./...\"\ngo fmt ./...\ngo vet ./...\ngo run ./main.go\n2022-01-27T22:05:30.207+0800\tINFO\tcontroller-runtime.metrics\tmetrics server is starting to listen\t{\"addr\": \":8080\"}\n2022-01-27T22:05:30.207+0800\tINFO\tsetup\tstarting manager\n2022-01-27T22:05:30.208+0800\tINFO\tstarting metrics server\t{\"path\": \"/metrics\"}\n2022-01-27T22:05:30.208+0800\tINFO\tcontroller.bucket\tStarting EventSource\t{\"reconciler group\": \"cos.marklu.com\", \"reconciler kind\": \"Bucket\", \"source\": \"kind source: /, Kind=\"}\n2022-01-27T22:05:30.208+0800\tINFO\tcontroller.bucket\tStarting Controller\t{\"reconciler group\": \"cos.marklu.com\", \"reconciler kind\": \"Bucket\"}\n2022-01-27T22:05:30.309+0800\tINFO\tcontroller.bucket\tStarting workers\t{\"reconciler group\": \"cos.marklu.com\", \"reconciler kind\": \"Bucket\", \"worker count\": 1}\n```\n> 3. Create Custom Resources (create bucket.cos.marklu.com/bucket-sample) (cos_v1_bucket.yaml)\n```\napiVersion: cos.marklu.com/v1\nkind: Bucket\nmetadata:\n  name: bucket-sample\n  namespace: marklu\nspec:\n  # TODO(user): Add fields here\n  name: example-1251762279\n  region: ap-shanghai\n  acl: private\n```\nkubectl apply -f cos_v1_bucket.yaml\n```\n[marklu@MacBook ~]$ kubectl apply -f cos_v1_bucket.yaml\nbucket.cos.marklu.com/bucket-sample created\n[marklu@MacBook ~]$ kubectl get bucket.cos.marklu.com  -n marklu\nNAME            AGE\nbucket-sample   17s\n```\nTencent cloud console view found that the bucket was created normally.\n> 4. Delete Instances of Custom Resources (delete bucket.cos.marklu.com/bucket-sample)\n```\n[marklu@MacBook ~]$ kubectl delete -f cos_v1_bucket.yaml\nbucket.cos.marklu.com \"bucket-sample\" deleted\n```\n# Run It On the Cluster\n> Deploy the controller to the cluster with image specified by IMG\n```\nmake docker-build docker-push IMG=<some-registry>/<project-name>:tag\nmake deploy IMG=<some-registry>/<project-name>:tag\n```\n# Reference documentation\n- https://github.com/kubernetes-sigs/kubebuilder\n- https://book.kubebuilder.io/introduction.html\n- https://kubernetes.io/docs/concepts/extend-kubernetes/operator/","source":"_posts/kubebuilder-best-practices.md","raw":"---\ntitle: Kubebuilder Best Practices\ncategories: \n  - Kubebuilder\ntags:\n  - k8s\nsidebar: none \n---\nKubebuilder is a framework for building Kubernetes APIs using custom resource definitions (CRDs).\n> Note: kubebuilder can save us a lot of work and make developing CRDs and adminsion webhooks incredibly easy.\n# Installation\n```\n# download kubebuilder and install locally.\ncurl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/$(go env GOOS)/$(go env GOARCH)\nchmod +x kubebuilder && mv kubebuilder /usr/local/bin/\n```\n# Create a Project \n> Create a directory, and then run the init command inside of it to initialize a new project. Follows an example.\n```\n[marklu@MacBook ~]$ mkdir ~/Project/workspace-go/example\n[marklu@MacBook ~]$ cd ~/Project/workspace-go/example\n[marklu@MacBook ~]$ kubebuilder init --domain marklu.com --owner \"marklu\" --repo marklu.com/example\nWriting kustomize manifests for you to edit...\nWriting scaffold for you to edit...\nGet controller runtime:\n$ go get sigs.k8s.io/controller-runtime@v0.10.0\nUpdate dependencies:\n$ go mod tidy\nNext: define a resource with:\n$ kubebuilder create api\n```\n> If your project is initialized within GOPATH, the implicitly called go mod init will interpolate the module path for you. Otherwise –repo=must be set.\n\n# Adding a new API\n```\n[marklu@MacBook ~]$ kubebuilder create api --group cos --version v1 --kind Bucket\nCreate Resource [y/n]\ny\nCreate Controller [y/n]\ny\nWriting kustomize manifests for you to edit...\nWriting scaffold for you to edit...\napi/v1/bucket_types.go\ncontrollers/bucket_controller.go\nUpdate dependencies:\n$ go mod tidy\nRunning make:\n$ make generate\ngo: creating new go.mod: module tmp\nDownloading sigs.k8s.io/controller-tools/cmd/controller-gen@v0.7.0\ngo get: added sigs.k8s.io/controller-tools v0.7.0\n/Users/huyuhan/Project/workspace-go/example/bin/controller-gen object:headerFile=\"hack/boilerplate.go.txt\" paths=\"./...\"\nNext: implement your new API and generate the manifests (e.g. CRDs,CRs) with:\n$ make manifests\n```\n\n# Designing an API\n> api/v1/bucket_types.go\n```\n// BucketSpec defines the desired state of Bucket\ntype BucketSpec struct {\n\t// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster\n\t// Important: Run \"make\" to regenerate code after modifying this file\n\n\t// Foo is an example field of Bucket. Edit bucket_types.go to remove/update\n\tName   string `json:\"name,omitempty\"`\n\tRegion string `json:\"region,omitempty\"`\n\tACL    string `json:\"acl,omitempty\"`\n}\n```\n\n# Implementing a controller\n>controllers/cos.go \n```\npackage controllers\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"github.com/tencentyun/cos-go-sdk-v5\"\n\t\"net/http\"\n\t\"net/url\"\n)\n\ntype CosStorage struct {\n\tclient          *cos.Client\n\taccessKeyId     string\n\taccessKeySecret string\n\tbucket          string\n\tregion          string\n}\n\n// NewCosStorage endpoint: https://cloud.tencent.com/document/product/436/6224\nfunc NewCosStorage(region, bucketName string) *CosStorage {\n\turl, _ := url.Parse(fmt.Sprintf(\"https://%s.cos.%s.myqcloud.com\", bucketName, region))\n\taccessKeyId := \"\"\n\taccessKeySecret := \"\"\n\tb := &cos.BaseURL{BucketURL: url}\n\tclient := cos.NewClient(b, &http.Client{\n\t\tTransport: &cos.AuthorizationTransport{\n\t\t\tSecretID:  accessKeyId,\n\t\t\tSecretKey: accessKeySecret,\n\t\t},\n\t})\n\treturn &CosStorage{\n\t\tclient:          client,\n\t\taccessKeyId:     accessKeyId,\n\t\taccessKeySecret: accessKeySecret,\n\t\tregion:          region,\n\t\tbucket:          bucketName,\n\t}\n}\n\nfunc (c *CosStorage) Put(acl string) error {\n\topt := &cos.BucketPutOptions{\n\t\tXCosACL: acl,\n\t}\n\t_, err := c.client.Bucket.Put(context.Background(), opt)\n\treturn err\n}\n\nfunc (c *CosStorage) Delete() error {\n\t_, err := c.client.Bucket.Delete(context.Background())\n\treturn err\n}\n```\ncontrollers/bucket_controller.go\n> tips: Finalizers allow controllers to implement asynchronous pre-delete hooks. Let’s say you create an external resource (such as a storage bucket) for each object of your API type, and you want to delete the associated external resource on object’s deletion from Kubernetes, you can use a finalizer to do that.\n```\n/*\nCopyright 2022 marklu.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\npackage controllers\n\nimport (\n\t\"context\"\n\t\"k8s.io/apimachinery/pkg/runtime\"\n\tctrl \"sigs.k8s.io/controller-runtime\"\n\t\"sigs.k8s.io/controller-runtime/pkg/client\"\n\t\"sigs.k8s.io/controller-runtime/pkg/controller/controllerutil\"\n\t\"sigs.k8s.io/controller-runtime/pkg/log\"\n\n\tcosv1 \"marklu.com/example/api/v1\"\n)\n\n// BucketReconciler reconciles a Bucket object\ntype BucketReconciler struct {\n\tclient.Client\n\tScheme *runtime.Scheme\n}\n\nconst (\n\tbucketFinalizerName = \"bucket.cos.marklu.com/finalizer\"\n)\n\n//+kubebuilder:rbac:groups=cos.marklu.com,resources=buckets,verbs=get;list;watch;create;update;patch;delete\n//+kubebuilder:rbac:groups=cos.marklu.com,resources=buckets/status,verbs=get;update;patch\n//+kubebuilder:rbac:groups=cos.marklu.com,resources=buckets/finalizers,verbs=update\n\n// Reconcile is part of the main kubernetes reconciliation loop which aims to\n// move the current state of the cluster closer to the desired state.\n// TODO(user): Modify the Reconcile function to compare the state specified by\n// the Bucket object against the actual cluster state, and then\n// perform operations to make the cluster state reflect the state specified by\n// the user.\n//\n// For more details, check Reconcile and its Result here:\n// - https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.10.0/pkg/reconcile\nfunc (r *BucketReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {\n\tlogger := log.FromContext(ctx)\n\n\tbucket := &cosv1.Bucket{}\n\tif err := r.Get(ctx, req.NamespacedName, bucket); err != nil {\n\t\treturn ctrl.Result{}, client.IgnoreNotFound(err)\n\t}\n\n\t// examine DeletionTimestamp to determine if object is under deletion\n\tif bucket.ObjectMeta.DeletionTimestamp.IsZero() {\n\t\t// The object is not being deleted, so if it does not have our finalizer,\n\t\t// then lets add the finalizer and update the object. This is equivalent\n\t\t// registering our finalizer.\n\t\tif !controllerutil.ContainsFinalizer(bucket, bucketFinalizerName) {\n\t\t\tcontrollerutil.AddFinalizer(bucket, bucketFinalizerName)\n\t\t\tif err := r.Update(ctx, bucket); err != nil {\n\t\t\t\treturn ctrl.Result{}, err\n\t\t\t}\n\t\t} else {\n\t\t\tif err := r.updateExternalResources(bucket); err != nil {\n\t\t\t\tlogger.Error(err, \"unable to create Bucket\")\n\t\t\t\treturn ctrl.Result{}, err\n\t\t\t}\n\t\t\tlogger.Info(\"create Bucket succeed\")\n\t\t}\n\t} else {\n\t\t// The object is being deleted\n\t\tif controllerutil.ContainsFinalizer(bucket, bucketFinalizerName) {\n\t\t\t// our finalizer is present, so lets handle any external dependency\n\t\t\tif err := r.deleteExternalResources(bucket); err != nil {\n\t\t\t\t// if fail to delete the external dependency here, return with error\n\t\t\t\t// so that it can be retried\n\t\t\t\tlogger.Error(err, \"unable to delete Bucket\")\n\t\t\t\treturn ctrl.Result{}, err\n\t\t\t}\n\n\t\t\t// remove our finalizer from the list and update it.\n\t\t\tcontrollerutil.RemoveFinalizer(bucket, bucketFinalizerName)\n\t\t\tif err := r.Update(ctx, bucket); err != nil {\n\t\t\t\treturn ctrl.Result{}, err\n\t\t\t}\n\t\t\tlogger.Info(\"delete Bucket succeed\")\n\t\t}\n\n\t\t// Stop reconciliation as the item is being deleted\n\t\treturn ctrl.Result{}, nil\n\t}\n\n\t// bucket reconcile logic\n\treturn ctrl.Result{}, nil\n}\n\nfunc (r *BucketReconciler) updateExternalResources(bucket *cosv1.Bucket) error {\n\tcosClient := NewCosStorage(bucket.Spec.Region, bucket.Spec.Name)\n\treturn cosClient.Put(bucket.Spec.ACL)\n}\n\nfunc (r *BucketReconciler) deleteExternalResources(bucket *cosv1.Bucket) error {\n\tcosClient := NewCosStorage(bucket.Spec.Region, bucket.Spec.Name)\n\treturn cosClient.Delete()\n}\n\n// SetupWithManager sets up the controller with the Manager.\nfunc (r *BucketReconciler) SetupWithManager(mgr ctrl.Manager) error {\n\treturn ctrl.NewControllerManagedBy(mgr).\n\t\tFor(&cosv1.Bucket{}).\n\t\tComplete(r)\n}\n```\n# Test It Out\n> 1. Install the CRDs into the cluster (make install)\n```\n[marklu@MacBook ~]$ make install\n/Users/huyuhan/Project/workspace-go/example/bin/controller-gen rbac:roleName=manager-role crd webhook paths=\"./...\" output:crd:artifacts:config=config/crd/bases\n/Users/huyuhan/Project/workspace-go/example/bin/kustomize build config/crd | kubectl apply -f -\ncustomresourcedefinition.apiextensions.k8s.io/buckets.cos.marklu.com created\n```\n> 2. Run your controller (this will run in the foreground, so switch to a new terminal if you want to leave it running) (make run)\n```\n[marklu@MacBook ~]$ make run\n/Users/huyuhan/Project/workspace-go/example/bin/controller-gen rbac:roleName=manager-role crd webhook paths=\"./...\" output:crd:artifacts:config=config/crd/bases\n/Users/huyuhan/Project/workspace-go/example/bin/controller-gen object:headerFile=\"hack/boilerplate.go.txt\" paths=\"./...\"\ngo fmt ./...\ngo vet ./...\ngo run ./main.go\n2022-01-27T22:05:30.207+0800\tINFO\tcontroller-runtime.metrics\tmetrics server is starting to listen\t{\"addr\": \":8080\"}\n2022-01-27T22:05:30.207+0800\tINFO\tsetup\tstarting manager\n2022-01-27T22:05:30.208+0800\tINFO\tstarting metrics server\t{\"path\": \"/metrics\"}\n2022-01-27T22:05:30.208+0800\tINFO\tcontroller.bucket\tStarting EventSource\t{\"reconciler group\": \"cos.marklu.com\", \"reconciler kind\": \"Bucket\", \"source\": \"kind source: /, Kind=\"}\n2022-01-27T22:05:30.208+0800\tINFO\tcontroller.bucket\tStarting Controller\t{\"reconciler group\": \"cos.marklu.com\", \"reconciler kind\": \"Bucket\"}\n2022-01-27T22:05:30.309+0800\tINFO\tcontroller.bucket\tStarting workers\t{\"reconciler group\": \"cos.marklu.com\", \"reconciler kind\": \"Bucket\", \"worker count\": 1}\n```\n> 3. Create Custom Resources (create bucket.cos.marklu.com/bucket-sample) (cos_v1_bucket.yaml)\n```\napiVersion: cos.marklu.com/v1\nkind: Bucket\nmetadata:\n  name: bucket-sample\n  namespace: marklu\nspec:\n  # TODO(user): Add fields here\n  name: example-1251762279\n  region: ap-shanghai\n  acl: private\n```\nkubectl apply -f cos_v1_bucket.yaml\n```\n[marklu@MacBook ~]$ kubectl apply -f cos_v1_bucket.yaml\nbucket.cos.marklu.com/bucket-sample created\n[marklu@MacBook ~]$ kubectl get bucket.cos.marklu.com  -n marklu\nNAME            AGE\nbucket-sample   17s\n```\nTencent cloud console view found that the bucket was created normally.\n> 4. Delete Instances of Custom Resources (delete bucket.cos.marklu.com/bucket-sample)\n```\n[marklu@MacBook ~]$ kubectl delete -f cos_v1_bucket.yaml\nbucket.cos.marklu.com \"bucket-sample\" deleted\n```\n# Run It On the Cluster\n> Deploy the controller to the cluster with image specified by IMG\n```\nmake docker-build docker-push IMG=<some-registry>/<project-name>:tag\nmake deploy IMG=<some-registry>/<project-name>:tag\n```\n# Reference documentation\n- https://github.com/kubernetes-sigs/kubebuilder\n- https://book.kubebuilder.io/introduction.html\n- https://kubernetes.io/docs/concepts/extend-kubernetes/operator/","slug":"kubebuilder-best-practices","published":1,"date":"2023-05-23T03:49:44.614Z","updated":"2023-05-25T16:05:25.921Z","_id":"clhzqn8n90005w8f81pzxesvn","comments":1,"layout":"post","photos":[],"link":"","content":"<p>Kubebuilder is a framework for building Kubernetes APIs using custom resource definitions (CRDs).</p>\n<blockquote>\n<p>Note: kubebuilder can save us a lot of work and make developing CRDs and adminsion webhooks incredibly easy.</p>\n</blockquote>\n<h1 id=\"installation\"><a class=\"markdownIt-Anchor\" href=\"#installation\"></a> Installation</h1>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># download kubebuilder and install locally.</span></span><br><span class=\"line\">curl -L -o kubebuilder https:<span class=\"regexp\">//g</span>o.kubebuilder.io<span class=\"regexp\">/dl/</span>latest<span class=\"regexp\">/$(go env GOOS)/</span>$(go env GOARCH)</span><br><span class=\"line\">chmod +x kubebuilder &amp;&amp; mv kubebuilder <span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/bin/</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"create-a-project\"><a class=\"markdownIt-Anchor\" href=\"#create-a-project\"></a> Create a Project</h1>\n<blockquote>\n<p>Create a directory, and then run the init command inside of it to initialize a new project. Follows an example.</p>\n</blockquote>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[marklu@MacBook ~]$ <span class=\"built_in\">mkdir</span> ~/Project/workspace-<span class=\"keyword\">go</span>/example</span><br><span class=\"line\">[marklu@MacBook ~]$ <span class=\"keyword\">cd</span> ~/Project/workspace-<span class=\"keyword\">go</span>/example</span><br><span class=\"line\">[marklu@MacBook ~]$ kubebuilder init --domain marklu.<span class=\"keyword\">com</span> --owner <span class=\"string\">&quot;marklu&quot;</span> --repo marklu.<span class=\"keyword\">com</span>/example</span><br><span class=\"line\">Writing kustomize manifests <span class=\"keyword\">for</span> you <span class=\"keyword\">to</span> <span class=\"keyword\">edit</span>...</span><br><span class=\"line\">Writing scaffold <span class=\"keyword\">for</span> you <span class=\"keyword\">to</span> <span class=\"keyword\">edit</span>...</span><br><span class=\"line\">Get controller <span class=\"keyword\">runtime</span>:</span><br><span class=\"line\">$ <span class=\"keyword\">go</span> <span class=\"built_in\">get</span> sigs.k8s.io/controller-runtime@v0.<span class=\"number\">10.0</span></span><br><span class=\"line\">Update dependencies:</span><br><span class=\"line\">$ <span class=\"keyword\">go</span> <span class=\"keyword\">mod</span> tidy</span><br><span class=\"line\"><span class=\"keyword\">Next</span>: define <span class=\"keyword\">a</span> resource with:</span><br><span class=\"line\">$ kubebuilder create api</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>If your project is initialized within GOPATH, the implicitly called go mod init will interpolate the module path for you. Otherwise –repo=must be set.</p>\n</blockquote>\n<h1 id=\"adding-a-new-api\"><a class=\"markdownIt-Anchor\" href=\"#adding-a-new-api\"></a> Adding a new API</h1>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[marklu@MacBook ~]$ kubebuilder create api --group <span class=\"built_in\">cos</span> --<span class=\"keyword\">version</span> v1 --kind Bucket</span><br><span class=\"line\">Create Resource [<span class=\"keyword\">y</span>/n]</span><br><span class=\"line\"><span class=\"keyword\">y</span></span><br><span class=\"line\">Create Controller [<span class=\"keyword\">y</span>/n]</span><br><span class=\"line\"><span class=\"keyword\">y</span></span><br><span class=\"line\">Writing kustomize manifests <span class=\"keyword\">for</span> you <span class=\"keyword\">to</span> <span class=\"keyword\">edit</span>...</span><br><span class=\"line\">Writing scaffold <span class=\"keyword\">for</span> you <span class=\"keyword\">to</span> <span class=\"keyword\">edit</span>...</span><br><span class=\"line\">api/v1/bucket_types.<span class=\"keyword\">go</span></span><br><span class=\"line\">controllers/bucket_controller.<span class=\"keyword\">go</span></span><br><span class=\"line\">Update dependencies:</span><br><span class=\"line\">$ <span class=\"keyword\">go</span> <span class=\"keyword\">mod</span> tidy</span><br><span class=\"line\">Running <span class=\"keyword\">make</span>:</span><br><span class=\"line\">$ <span class=\"keyword\">make</span> generate</span><br><span class=\"line\"><span class=\"keyword\">go</span>: creating <span class=\"keyword\">new</span> <span class=\"keyword\">go</span>.<span class=\"keyword\">mod</span>: module tmp</span><br><span class=\"line\">Downloading sigs.k8s.io/controller-tools/cmd/controller-gen@v0.<span class=\"number\">7.0</span></span><br><span class=\"line\"><span class=\"keyword\">go</span> <span class=\"built_in\">get</span>: added sigs.k8s.io/controller-tools v0.<span class=\"number\">7.0</span></span><br><span class=\"line\">/Users/huyuhan/Project/workspace-<span class=\"keyword\">go</span>/example/bin/controller-gen objec<span class=\"variable\">t:headerFile</span>=<span class=\"string\">&quot;hack/boilerplate.go.txt&quot;</span> paths=<span class=\"string\">&quot;./...&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">Next</span>: implement your <span class=\"keyword\">new</span> API <span class=\"built_in\">and</span> generate the manifests (<span class=\"keyword\">e</span>.g. CRDs,CRs) with:</span><br><span class=\"line\">$ <span class=\"keyword\">make</span> manifests</span><br></pre></td></tr></table></figure>\n<h1 id=\"designing-an-api\"><a class=\"markdownIt-Anchor\" href=\"#designing-an-api\"></a> Designing an API</h1>\n<blockquote>\n<p>api/v1/bucket_types.go</p>\n</blockquote>\n<figure class=\"highlight pf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// BucketSpec defines the desired <span class=\"keyword\">state</span> of Bucket</span><br><span class=\"line\">type BucketSpec struct &#123;</span><br><span class=\"line\">\t// INSERT ADDITIONAL SPEC FIELDS - desired <span class=\"keyword\">state</span> of cluster</span><br><span class=\"line\">\t// Important: Run <span class=\"string\">&quot;make&quot;</span> <span class=\"keyword\">to</span> regenerate code after modifying this file</span><br><span class=\"line\"></span><br><span class=\"line\">\t// Foo is an example field of Bucket. Edit bucket_types.go <span class=\"keyword\">to</span> remove/update</span><br><span class=\"line\">\tName   string `json:<span class=\"string\">&quot;name,omitempty&quot;</span>`</span><br><span class=\"line\">\tRegion string `json:<span class=\"string\">&quot;region,omitempty&quot;</span>`</span><br><span class=\"line\">\tACL    string `json:<span class=\"string\">&quot;acl,omitempty&quot;</span>`</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"implementing-a-controller\"><a class=\"markdownIt-Anchor\" href=\"#implementing-a-controller\"></a> Implementing a controller</h1>\n<blockquote>\n<p>controllers/cos.go</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> controllers</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;context&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;github.com/tencentyun/cos-go-sdk-v5&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;net/http&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;net/url&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> CosStorage <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tclient          *cos.Client</span><br><span class=\"line\">\taccessKeyId     <span class=\"type\">string</span></span><br><span class=\"line\">\taccessKeySecret <span class=\"type\">string</span></span><br><span class=\"line\">\tbucket          <span class=\"type\">string</span></span><br><span class=\"line\">\tregion          <span class=\"type\">string</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// NewCosStorage endpoint: https://cloud.tencent.com/document/product/436/6224</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewCosStorage</span><span class=\"params\">(region, bucketName <span class=\"type\">string</span>)</span></span> *CosStorage &#123;</span><br><span class=\"line\">\turl, _ := url.Parse(fmt.Sprintf(<span class=\"string\">&quot;https://%s.cos.%s.myqcloud.com&quot;</span>, bucketName, region))</span><br><span class=\"line\">\taccessKeyId := <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">\taccessKeySecret := <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">\tb := &amp;cos.BaseURL&#123;BucketURL: url&#125;</span><br><span class=\"line\">\tclient := cos.NewClient(b, &amp;http.Client&#123;</span><br><span class=\"line\">\t\tTransport: &amp;cos.AuthorizationTransport&#123;</span><br><span class=\"line\">\t\t\tSecretID:  accessKeyId,</span><br><span class=\"line\">\t\t\tSecretKey: accessKeySecret,</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;CosStorage&#123;</span><br><span class=\"line\">\t\tclient:          client,</span><br><span class=\"line\">\t\taccessKeyId:     accessKeyId,</span><br><span class=\"line\">\t\taccessKeySecret: accessKeySecret,</span><br><span class=\"line\">\t\tregion:          region,</span><br><span class=\"line\">\t\tbucket:          bucketName,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *CosStorage)</span></span> Put(acl <span class=\"type\">string</span>) <span class=\"type\">error</span> &#123;</span><br><span class=\"line\">\topt := &amp;cos.BucketPutOptions&#123;</span><br><span class=\"line\">\t\tXCosACL: acl,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t_, err := c.client.Bucket.Put(context.Background(), opt)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *CosStorage)</span></span> Delete() <span class=\"type\">error</span> &#123;</span><br><span class=\"line\">\t_, err := c.client.Bucket.Delete(context.Background())</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>controllers/bucket_controller.go</p>\n<blockquote>\n<p>tips: Finalizers allow controllers to implement asynchronous pre-delete hooks. Let’s say you create an external resource (such as a storage bucket) for each object of your API type, and you want to delete the associated external resource on object’s deletion from Kubernetes, you can use a finalizer to do that.</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">Copyright 2022 marklu.</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class=\"line\"><span class=\"comment\">you may not use this file except in compliance with the License.</span></span><br><span class=\"line\"><span class=\"comment\">You may obtain a copy of the License at</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">Unless required by applicable law or agreed to in writing, software</span></span><br><span class=\"line\"><span class=\"comment\">distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class=\"line\"><span class=\"comment\">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class=\"line\"><span class=\"comment\">See the License for the specific language governing permissions and</span></span><br><span class=\"line\"><span class=\"comment\">limitations under the License.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> controllers</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;context&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span></span><br><span class=\"line\">\tctrl <span class=\"string\">&quot;sigs.k8s.io/controller-runtime&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/controller/controllerutil&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/log&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tcosv1 <span class=\"string\">&quot;marklu.com/example/api/v1&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// BucketReconciler reconciles a Bucket object</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> BucketReconciler <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tclient.Client</span><br><span class=\"line\">\tScheme *runtime.Scheme</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">\tbucketFinalizerName = <span class=\"string\">&quot;bucket.cos.marklu.com/finalizer&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//+kubebuilder:rbac:groups=cos.marklu.com,resources=buckets,verbs=get;list;watch;create;update;patch;delete</span></span><br><span class=\"line\"><span class=\"comment\">//+kubebuilder:rbac:groups=cos.marklu.com,resources=buckets/status,verbs=get;update;patch</span></span><br><span class=\"line\"><span class=\"comment\">//+kubebuilder:rbac:groups=cos.marklu.com,resources=buckets/finalizers,verbs=update</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Reconcile is part of the main kubernetes reconciliation loop which aims to</span></span><br><span class=\"line\"><span class=\"comment\">// move the current state of the cluster closer to the desired state.</span></span><br><span class=\"line\"><span class=\"comment\">// TODO(user): Modify the Reconcile function to compare the state specified by</span></span><br><span class=\"line\"><span class=\"comment\">// the Bucket object against the actual cluster state, and then</span></span><br><span class=\"line\"><span class=\"comment\">// perform operations to make the cluster state reflect the state specified by</span></span><br><span class=\"line\"><span class=\"comment\">// the user.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// For more details, check Reconcile and its Result here:</span></span><br><span class=\"line\"><span class=\"comment\">// - https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.10.0/pkg/reconcile</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(r *BucketReconciler)</span></span> Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, <span class=\"type\">error</span>) &#123;</span><br><span class=\"line\">\tlogger := log.FromContext(ctx)</span><br><span class=\"line\"></span><br><span class=\"line\">\tbucket := &amp;cosv1.Bucket&#123;&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err := r.Get(ctx, req.NamespacedName, bucket); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, client.IgnoreNotFound(err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// examine DeletionTimestamp to determine if object is under deletion</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> bucket.ObjectMeta.DeletionTimestamp.IsZero() &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// The object is not being deleted, so if it does not have our finalizer,</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// then lets add the finalizer and update the object. This is equivalent</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// registering our finalizer.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> !controllerutil.ContainsFinalizer(bucket, bucketFinalizerName) &#123;</span><br><span class=\"line\">\t\t\tcontrollerutil.AddFinalizer(bucket, bucketFinalizerName)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err := r.Update(ctx, bucket); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, err</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err := r.updateExternalResources(bucket); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\tlogger.Error(err, <span class=\"string\">&quot;unable to create Bucket&quot;</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, err</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tlogger.Info(<span class=\"string\">&quot;create Bucket succeed&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// The object is being deleted</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> controllerutil.ContainsFinalizer(bucket, bucketFinalizerName) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// our finalizer is present, so lets handle any external dependency</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err := r.deleteExternalResources(bucket); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// if fail to delete the external dependency here, return with error</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// so that it can be retried</span></span><br><span class=\"line\">\t\t\t\tlogger.Error(err, <span class=\"string\">&quot;unable to delete Bucket&quot;</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, err</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// remove our finalizer from the list and update it.</span></span><br><span class=\"line\">\t\t\tcontrollerutil.RemoveFinalizer(bucket, bucketFinalizerName)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err := r.Update(ctx, bucket); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, err</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tlogger.Info(<span class=\"string\">&quot;delete Bucket succeed&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Stop reconciliation as the item is being deleted</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, <span class=\"literal\">nil</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// bucket reconcile logic</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(r *BucketReconciler)</span></span> updateExternalResources(bucket *cosv1.Bucket) <span class=\"type\">error</span> &#123;</span><br><span class=\"line\">\tcosClient := NewCosStorage(bucket.Spec.Region, bucket.Spec.Name)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> cosClient.Put(bucket.Spec.ACL)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(r *BucketReconciler)</span></span> deleteExternalResources(bucket *cosv1.Bucket) <span class=\"type\">error</span> &#123;</span><br><span class=\"line\">\tcosClient := NewCosStorage(bucket.Spec.Region, bucket.Spec.Name)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> cosClient.Delete()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// SetupWithManager sets up the controller with the Manager.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(r *BucketReconciler)</span></span> SetupWithManager(mgr ctrl.Manager) <span class=\"type\">error</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ctrl.NewControllerManagedBy(mgr).</span><br><span class=\"line\">\t\tFor(&amp;cosv1.Bucket&#123;&#125;).</span><br><span class=\"line\">\t\tComplete(r)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"test-it-out\"><a class=\"markdownIt-Anchor\" href=\"#test-it-out\"></a> Test It Out</h1>\n<blockquote>\n<ol>\n<li>Install the CRDs into the cluster (make install)</li>\n</ol>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[marklu@MacBook ~]$ make install</span><br><span class=\"line\">/Users/huyuhan/Project/workspace-go/example/bin/controller-gen rbac:roleName=manager-role crd webhook paths=<span class=\"string\">&quot;./...&quot;</span> output:crd:artifacts:config=config/crd/bases</span><br><span class=\"line\">/Users/huyuhan/Project/workspace-go/example/bin/kustomize build config/crd | kubectl apply -f -</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/buckets.cos.marklu.com created</span><br></pre></td></tr></table></figure>\n<blockquote>\n<ol start=\"2\">\n<li>Run your controller (this will run in the foreground, so switch to a new terminal if you want to leave it running) (make run)</li>\n</ol>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[marklu@MacBook ~]$ make <span class=\"built_in\">run</span></span><br><span class=\"line\">/Users/huyuhan/Project/workspace-go/example/bin/controller-gen rbac:<span class=\"attribute\">roleName</span>=manager-role crd webhook <span class=\"attribute\">paths</span>=<span class=\"string\">&quot;./...&quot;</span> output:crd:artifacts:<span class=\"attribute\">config</span>=config/crd/bases</span><br><span class=\"line\">/Users/huyuhan/Project/workspace-go/example/bin/controller-gen object:<span class=\"attribute\">headerFile</span>=<span class=\"string\">&quot;hack/boilerplate.go.txt&quot;</span> <span class=\"attribute\">paths</span>=<span class=\"string\">&quot;./...&quot;</span></span><br><span class=\"line\">go fmt ./<span class=\"built_in\">..</span>.</span><br><span class=\"line\">go vet ./<span class=\"built_in\">..</span>.</span><br><span class=\"line\">go <span class=\"built_in\">run</span> ./main.go</span><br><span class=\"line\">2022-01-27T22:05:30.207+0800\t<span class=\"built_in\">INFO</span>\tcontroller-runtime.metrics\tmetrics<span class=\"built_in\"> server </span>is starting <span class=\"keyword\">to</span> listen\t&#123;<span class=\"string\">&quot;addr&quot;</span>: <span class=\"string\">&quot;:8080&quot;</span>&#125;</span><br><span class=\"line\">2022-01-27T22:05:30.207+0800\t<span class=\"built_in\">INFO</span>\tsetup\tstarting manager</span><br><span class=\"line\">2022-01-27T22:05:30.208+0800\t<span class=\"built_in\">INFO</span>\tstarting metrics<span class=\"built_in\"> server\t</span>&#123;<span class=\"string\">&quot;path&quot;</span>: <span class=\"string\">&quot;/metrics&quot;</span>&#125;</span><br><span class=\"line\">2022-01-27T22:05:30.208+0800\t<span class=\"built_in\">INFO</span>\tcontroller.bucket\tStarting EventSource\t&#123;<span class=\"string\">&quot;reconciler group&quot;</span>: <span class=\"string\">&quot;cos.marklu.com&quot;</span>, <span class=\"string\">&quot;reconciler kind&quot;</span>: <span class=\"string\">&quot;Bucket&quot;</span>, <span class=\"string\">&quot;source&quot;</span>: <span class=\"string\">&quot;kind source: /, Kind=&quot;</span>&#125;</span><br><span class=\"line\">2022-01-27T22:05:30.208+0800\t<span class=\"built_in\">INFO</span>\tcontroller.bucket\tStarting Controller\t&#123;<span class=\"string\">&quot;reconciler group&quot;</span>: <span class=\"string\">&quot;cos.marklu.com&quot;</span>, <span class=\"string\">&quot;reconciler kind&quot;</span>: <span class=\"string\">&quot;Bucket&quot;</span>&#125;</span><br><span class=\"line\">2022-01-27T22:05:30.309+0800\t<span class=\"built_in\">INFO</span>\tcontroller.bucket\tStarting workers\t&#123;<span class=\"string\">&quot;reconciler group&quot;</span>: <span class=\"string\">&quot;cos.marklu.com&quot;</span>, <span class=\"string\">&quot;reconciler kind&quot;</span>: <span class=\"string\">&quot;Bucket&quot;</span>, <span class=\"string\">&quot;worker count&quot;</span>: 1&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<ol start=\"3\">\n<li>Create Custom Resources (create <a href=\"http://bucket.cos.marklu.com/bucket-sample\">bucket.cos.marklu.com/bucket-sample</a>) (cos_v1_bucket.yaml)</li>\n</ol>\n</blockquote>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">apiVersion:</span> cos.marklu.com/v1</span><br><span class=\"line\"><span class=\"symbol\">kind:</span> Bucket</span><br><span class=\"line\"><span class=\"symbol\">metadata:</span></span><br><span class=\"line\"><span class=\"symbol\">  name:</span> bucket-sample</span><br><span class=\"line\"><span class=\"symbol\">  namespace:</span> marklu</span><br><span class=\"line\"><span class=\"symbol\">spec:</span></span><br><span class=\"line\">  <span class=\"meta\"># TODO(user): Add fields here</span></span><br><span class=\"line\"><span class=\"symbol\">  name:</span> example<span class=\"number\">-1251762279</span></span><br><span class=\"line\"><span class=\"symbol\">  region:</span> ap-shanghai</span><br><span class=\"line\"><span class=\"symbol\">  acl:</span> private</span><br></pre></td></tr></table></figure>\n<p>kubectl apply -f cos_v1_bucket.yaml</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[marklu@MacBook ~]</span>$ kubectl apply -f cos_v1_bucket<span class=\"selector-class\">.yaml</span></span><br><span class=\"line\">bucket<span class=\"selector-class\">.cos</span><span class=\"selector-class\">.marklu</span>.com/bucket-sample created</span><br><span class=\"line\"><span class=\"selector-attr\">[marklu@MacBook ~]</span>$ kubectl get bucket<span class=\"selector-class\">.cos</span><span class=\"selector-class\">.marklu</span><span class=\"selector-class\">.com</span>  -n marklu</span><br><span class=\"line\">NAME            AGE</span><br><span class=\"line\">bucket-sample   <span class=\"number\">17s</span></span><br></pre></td></tr></table></figure>\n<p>Tencent cloud console view found that the bucket was created normally.</p>\n<blockquote>\n<ol start=\"4\">\n<li>Delete Instances of Custom Resources (delete <a href=\"http://bucket.cos.marklu.com/bucket-sample\">bucket.cos.marklu.com/bucket-sample</a>)</li>\n</ol>\n</blockquote>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[marklu@MacBook ~]</span>$ kubectl delete -f cos_v1_bucket<span class=\"selector-class\">.yaml</span></span><br><span class=\"line\">bucket<span class=\"selector-class\">.cos</span><span class=\"selector-class\">.marklu</span><span class=\"selector-class\">.com</span> <span class=\"string\">&quot;bucket-sample&quot;</span> deleted</span><br></pre></td></tr></table></figure>\n<h1 id=\"run-it-on-the-cluster\"><a class=\"markdownIt-Anchor\" href=\"#run-it-on-the-cluster\"></a> Run It On the Cluster</h1>\n<blockquote>\n<p>Deploy the controller to the cluster with image specified by IMG</p>\n</blockquote>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">make</span> docker-build docker-push IMG=<span class=\"symbol\">&lt;some-registry&gt;</span>/<span class=\"symbol\">&lt;project-name&gt;</span>:<span class=\"keyword\">tag</span></span><br><span class=\"line\"><span class=\"keyword\">make</span> deploy IMG=<span class=\"symbol\">&lt;some-registry&gt;</span>/<span class=\"symbol\">&lt;project-name&gt;</span>:<span class=\"keyword\">tag</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"reference-documentation\"><a class=\"markdownIt-Anchor\" href=\"#reference-documentation\"></a> Reference documentation</h1>\n<ul>\n<li><a href=\"https://github.com/kubernetes-sigs/kubebuilder\">https://github.com/kubernetes-sigs/kubebuilder</a></li>\n<li><a href=\"https://book.kubebuilder.io/introduction.html\">https://book.kubebuilder.io/introduction.html</a></li>\n<li><a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/operator/\">https://kubernetes.io/docs/concepts/extend-kubernetes/operator/</a></li>\n</ul>\n","site":{"data":{"links":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}},"gallery":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}},"excerpt":"","more":"<p>Kubebuilder is a framework for building Kubernetes APIs using custom resource definitions (CRDs).</p>\n<blockquote>\n<p>Note: kubebuilder can save us a lot of work and make developing CRDs and adminsion webhooks incredibly easy.</p>\n</blockquote>\n<h1 id=\"installation\"><a class=\"markdownIt-Anchor\" href=\"#installation\"></a> Installation</h1>\n<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># download kubebuilder and install locally.</span></span><br><span class=\"line\">curl -L -o kubebuilder https:<span class=\"regexp\">//g</span>o.kubebuilder.io<span class=\"regexp\">/dl/</span>latest<span class=\"regexp\">/$(go env GOOS)/</span>$(go env GOARCH)</span><br><span class=\"line\">chmod +x kubebuilder &amp;&amp; mv kubebuilder <span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/bin/</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"create-a-project\"><a class=\"markdownIt-Anchor\" href=\"#create-a-project\"></a> Create a Project</h1>\n<blockquote>\n<p>Create a directory, and then run the init command inside of it to initialize a new project. Follows an example.</p>\n</blockquote>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[marklu@MacBook ~]$ <span class=\"built_in\">mkdir</span> ~/Project/workspace-<span class=\"keyword\">go</span>/example</span><br><span class=\"line\">[marklu@MacBook ~]$ <span class=\"keyword\">cd</span> ~/Project/workspace-<span class=\"keyword\">go</span>/example</span><br><span class=\"line\">[marklu@MacBook ~]$ kubebuilder init --domain marklu.<span class=\"keyword\">com</span> --owner <span class=\"string\">&quot;marklu&quot;</span> --repo marklu.<span class=\"keyword\">com</span>/example</span><br><span class=\"line\">Writing kustomize manifests <span class=\"keyword\">for</span> you <span class=\"keyword\">to</span> <span class=\"keyword\">edit</span>...</span><br><span class=\"line\">Writing scaffold <span class=\"keyword\">for</span> you <span class=\"keyword\">to</span> <span class=\"keyword\">edit</span>...</span><br><span class=\"line\">Get controller <span class=\"keyword\">runtime</span>:</span><br><span class=\"line\">$ <span class=\"keyword\">go</span> <span class=\"built_in\">get</span> sigs.k8s.io/controller-runtime@v0.<span class=\"number\">10.0</span></span><br><span class=\"line\">Update dependencies:</span><br><span class=\"line\">$ <span class=\"keyword\">go</span> <span class=\"keyword\">mod</span> tidy</span><br><span class=\"line\"><span class=\"keyword\">Next</span>: define <span class=\"keyword\">a</span> resource with:</span><br><span class=\"line\">$ kubebuilder create api</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>If your project is initialized within GOPATH, the implicitly called go mod init will interpolate the module path for you. Otherwise –repo=must be set.</p>\n</blockquote>\n<h1 id=\"adding-a-new-api\"><a class=\"markdownIt-Anchor\" href=\"#adding-a-new-api\"></a> Adding a new API</h1>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[marklu@MacBook ~]$ kubebuilder create api --group <span class=\"built_in\">cos</span> --<span class=\"keyword\">version</span> v1 --kind Bucket</span><br><span class=\"line\">Create Resource [<span class=\"keyword\">y</span>/n]</span><br><span class=\"line\"><span class=\"keyword\">y</span></span><br><span class=\"line\">Create Controller [<span class=\"keyword\">y</span>/n]</span><br><span class=\"line\"><span class=\"keyword\">y</span></span><br><span class=\"line\">Writing kustomize manifests <span class=\"keyword\">for</span> you <span class=\"keyword\">to</span> <span class=\"keyword\">edit</span>...</span><br><span class=\"line\">Writing scaffold <span class=\"keyword\">for</span> you <span class=\"keyword\">to</span> <span class=\"keyword\">edit</span>...</span><br><span class=\"line\">api/v1/bucket_types.<span class=\"keyword\">go</span></span><br><span class=\"line\">controllers/bucket_controller.<span class=\"keyword\">go</span></span><br><span class=\"line\">Update dependencies:</span><br><span class=\"line\">$ <span class=\"keyword\">go</span> <span class=\"keyword\">mod</span> tidy</span><br><span class=\"line\">Running <span class=\"keyword\">make</span>:</span><br><span class=\"line\">$ <span class=\"keyword\">make</span> generate</span><br><span class=\"line\"><span class=\"keyword\">go</span>: creating <span class=\"keyword\">new</span> <span class=\"keyword\">go</span>.<span class=\"keyword\">mod</span>: module tmp</span><br><span class=\"line\">Downloading sigs.k8s.io/controller-tools/cmd/controller-gen@v0.<span class=\"number\">7.0</span></span><br><span class=\"line\"><span class=\"keyword\">go</span> <span class=\"built_in\">get</span>: added sigs.k8s.io/controller-tools v0.<span class=\"number\">7.0</span></span><br><span class=\"line\">/Users/huyuhan/Project/workspace-<span class=\"keyword\">go</span>/example/bin/controller-gen objec<span class=\"variable\">t:headerFile</span>=<span class=\"string\">&quot;hack/boilerplate.go.txt&quot;</span> paths=<span class=\"string\">&quot;./...&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">Next</span>: implement your <span class=\"keyword\">new</span> API <span class=\"built_in\">and</span> generate the manifests (<span class=\"keyword\">e</span>.g. CRDs,CRs) with:</span><br><span class=\"line\">$ <span class=\"keyword\">make</span> manifests</span><br></pre></td></tr></table></figure>\n<h1 id=\"designing-an-api\"><a class=\"markdownIt-Anchor\" href=\"#designing-an-api\"></a> Designing an API</h1>\n<blockquote>\n<p>api/v1/bucket_types.go</p>\n</blockquote>\n<figure class=\"highlight pf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// BucketSpec defines the desired <span class=\"keyword\">state</span> of Bucket</span><br><span class=\"line\">type BucketSpec struct &#123;</span><br><span class=\"line\">\t// INSERT ADDITIONAL SPEC FIELDS - desired <span class=\"keyword\">state</span> of cluster</span><br><span class=\"line\">\t// Important: Run <span class=\"string\">&quot;make&quot;</span> <span class=\"keyword\">to</span> regenerate code after modifying this file</span><br><span class=\"line\"></span><br><span class=\"line\">\t// Foo is an example field of Bucket. Edit bucket_types.go <span class=\"keyword\">to</span> remove/update</span><br><span class=\"line\">\tName   string `json:<span class=\"string\">&quot;name,omitempty&quot;</span>`</span><br><span class=\"line\">\tRegion string `json:<span class=\"string\">&quot;region,omitempty&quot;</span>`</span><br><span class=\"line\">\tACL    string `json:<span class=\"string\">&quot;acl,omitempty&quot;</span>`</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"implementing-a-controller\"><a class=\"markdownIt-Anchor\" href=\"#implementing-a-controller\"></a> Implementing a controller</h1>\n<blockquote>\n<p>controllers/cos.go</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> controllers</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;context&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;github.com/tencentyun/cos-go-sdk-v5&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;net/http&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;net/url&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> CosStorage <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tclient          *cos.Client</span><br><span class=\"line\">\taccessKeyId     <span class=\"type\">string</span></span><br><span class=\"line\">\taccessKeySecret <span class=\"type\">string</span></span><br><span class=\"line\">\tbucket          <span class=\"type\">string</span></span><br><span class=\"line\">\tregion          <span class=\"type\">string</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// NewCosStorage endpoint: https://cloud.tencent.com/document/product/436/6224</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewCosStorage</span><span class=\"params\">(region, bucketName <span class=\"type\">string</span>)</span></span> *CosStorage &#123;</span><br><span class=\"line\">\turl, _ := url.Parse(fmt.Sprintf(<span class=\"string\">&quot;https://%s.cos.%s.myqcloud.com&quot;</span>, bucketName, region))</span><br><span class=\"line\">\taccessKeyId := <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">\taccessKeySecret := <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">\tb := &amp;cos.BaseURL&#123;BucketURL: url&#125;</span><br><span class=\"line\">\tclient := cos.NewClient(b, &amp;http.Client&#123;</span><br><span class=\"line\">\t\tTransport: &amp;cos.AuthorizationTransport&#123;</span><br><span class=\"line\">\t\t\tSecretID:  accessKeyId,</span><br><span class=\"line\">\t\t\tSecretKey: accessKeySecret,</span><br><span class=\"line\">\t\t&#125;,</span><br><span class=\"line\">\t&#125;)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;CosStorage&#123;</span><br><span class=\"line\">\t\tclient:          client,</span><br><span class=\"line\">\t\taccessKeyId:     accessKeyId,</span><br><span class=\"line\">\t\taccessKeySecret: accessKeySecret,</span><br><span class=\"line\">\t\tregion:          region,</span><br><span class=\"line\">\t\tbucket:          bucketName,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *CosStorage)</span></span> Put(acl <span class=\"type\">string</span>) <span class=\"type\">error</span> &#123;</span><br><span class=\"line\">\topt := &amp;cos.BucketPutOptions&#123;</span><br><span class=\"line\">\t\tXCosACL: acl,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t_, err := c.client.Bucket.Put(context.Background(), opt)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *CosStorage)</span></span> Delete() <span class=\"type\">error</span> &#123;</span><br><span class=\"line\">\t_, err := c.client.Bucket.Delete(context.Background())</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> err</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>controllers/bucket_controller.go</p>\n<blockquote>\n<p>tips: Finalizers allow controllers to implement asynchronous pre-delete hooks. Let’s say you create an external resource (such as a storage bucket) for each object of your API type, and you want to delete the associated external resource on object’s deletion from Kubernetes, you can use a finalizer to do that.</p>\n</blockquote>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">Copyright 2022 marklu.</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class=\"line\"><span class=\"comment\">you may not use this file except in compliance with the License.</span></span><br><span class=\"line\"><span class=\"comment\">You may obtain a copy of the License at</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">Unless required by applicable law or agreed to in writing, software</span></span><br><span class=\"line\"><span class=\"comment\">distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class=\"line\"><span class=\"comment\">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class=\"line\"><span class=\"comment\">See the License for the specific language governing permissions and</span></span><br><span class=\"line\"><span class=\"comment\">limitations under the License.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> controllers</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;context&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span></span><br><span class=\"line\">\tctrl <span class=\"string\">&quot;sigs.k8s.io/controller-runtime&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/controller/controllerutil&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/log&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tcosv1 <span class=\"string\">&quot;marklu.com/example/api/v1&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// BucketReconciler reconciles a Bucket object</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> BucketReconciler <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tclient.Client</span><br><span class=\"line\">\tScheme *runtime.Scheme</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> (</span><br><span class=\"line\">\tbucketFinalizerName = <span class=\"string\">&quot;bucket.cos.marklu.com/finalizer&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//+kubebuilder:rbac:groups=cos.marklu.com,resources=buckets,verbs=get;list;watch;create;update;patch;delete</span></span><br><span class=\"line\"><span class=\"comment\">//+kubebuilder:rbac:groups=cos.marklu.com,resources=buckets/status,verbs=get;update;patch</span></span><br><span class=\"line\"><span class=\"comment\">//+kubebuilder:rbac:groups=cos.marklu.com,resources=buckets/finalizers,verbs=update</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Reconcile is part of the main kubernetes reconciliation loop which aims to</span></span><br><span class=\"line\"><span class=\"comment\">// move the current state of the cluster closer to the desired state.</span></span><br><span class=\"line\"><span class=\"comment\">// TODO(user): Modify the Reconcile function to compare the state specified by</span></span><br><span class=\"line\"><span class=\"comment\">// the Bucket object against the actual cluster state, and then</span></span><br><span class=\"line\"><span class=\"comment\">// perform operations to make the cluster state reflect the state specified by</span></span><br><span class=\"line\"><span class=\"comment\">// the user.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"comment\">// For more details, check Reconcile and its Result here:</span></span><br><span class=\"line\"><span class=\"comment\">// - https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.10.0/pkg/reconcile</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(r *BucketReconciler)</span></span> Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, <span class=\"type\">error</span>) &#123;</span><br><span class=\"line\">\tlogger := log.FromContext(ctx)</span><br><span class=\"line\"></span><br><span class=\"line\">\tbucket := &amp;cosv1.Bucket&#123;&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err := r.Get(ctx, req.NamespacedName, bucket); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, client.IgnoreNotFound(err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// examine DeletionTimestamp to determine if object is under deletion</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> bucket.ObjectMeta.DeletionTimestamp.IsZero() &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// The object is not being deleted, so if it does not have our finalizer,</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// then lets add the finalizer and update the object. This is equivalent</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// registering our finalizer.</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> !controllerutil.ContainsFinalizer(bucket, bucketFinalizerName) &#123;</span><br><span class=\"line\">\t\t\tcontrollerutil.AddFinalizer(bucket, bucketFinalizerName)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err := r.Update(ctx, bucket); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, err</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err := r.updateExternalResources(bucket); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\tlogger.Error(err, <span class=\"string\">&quot;unable to create Bucket&quot;</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, err</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tlogger.Info(<span class=\"string\">&quot;create Bucket succeed&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// The object is being deleted</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> controllerutil.ContainsFinalizer(bucket, bucketFinalizerName) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"comment\">// our finalizer is present, so lets handle any external dependency</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err := r.deleteExternalResources(bucket); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// if fail to delete the external dependency here, return with error</span></span><br><span class=\"line\">\t\t\t\t<span class=\"comment\">// so that it can be retried</span></span><br><span class=\"line\">\t\t\t\tlogger.Error(err, <span class=\"string\">&quot;unable to delete Bucket&quot;</span>)</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, err</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"comment\">// remove our finalizer from the list and update it.</span></span><br><span class=\"line\">\t\t\tcontrollerutil.RemoveFinalizer(bucket, bucketFinalizerName)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> err := r.Update(ctx, bucket); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, err</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tlogger.Info(<span class=\"string\">&quot;delete Bucket succeed&quot;</span>)</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"comment\">// Stop reconciliation as the item is being deleted</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, <span class=\"literal\">nil</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// bucket reconcile logic</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ctrl.Result&#123;&#125;, <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(r *BucketReconciler)</span></span> updateExternalResources(bucket *cosv1.Bucket) <span class=\"type\">error</span> &#123;</span><br><span class=\"line\">\tcosClient := NewCosStorage(bucket.Spec.Region, bucket.Spec.Name)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> cosClient.Put(bucket.Spec.ACL)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(r *BucketReconciler)</span></span> deleteExternalResources(bucket *cosv1.Bucket) <span class=\"type\">error</span> &#123;</span><br><span class=\"line\">\tcosClient := NewCosStorage(bucket.Spec.Region, bucket.Spec.Name)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> cosClient.Delete()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// SetupWithManager sets up the controller with the Manager.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(r *BucketReconciler)</span></span> SetupWithManager(mgr ctrl.Manager) <span class=\"type\">error</span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ctrl.NewControllerManagedBy(mgr).</span><br><span class=\"line\">\t\tFor(&amp;cosv1.Bucket&#123;&#125;).</span><br><span class=\"line\">\t\tComplete(r)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"test-it-out\"><a class=\"markdownIt-Anchor\" href=\"#test-it-out\"></a> Test It Out</h1>\n<blockquote>\n<ol>\n<li>Install the CRDs into the cluster (make install)</li>\n</ol>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[marklu@MacBook ~]$ make install</span><br><span class=\"line\">/Users/huyuhan/Project/workspace-go/example/bin/controller-gen rbac:roleName=manager-role crd webhook paths=<span class=\"string\">&quot;./...&quot;</span> output:crd:artifacts:config=config/crd/bases</span><br><span class=\"line\">/Users/huyuhan/Project/workspace-go/example/bin/kustomize build config/crd | kubectl apply -f -</span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/buckets.cos.marklu.com created</span><br></pre></td></tr></table></figure>\n<blockquote>\n<ol start=\"2\">\n<li>Run your controller (this will run in the foreground, so switch to a new terminal if you want to leave it running) (make run)</li>\n</ol>\n</blockquote>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[marklu@MacBook ~]$ make <span class=\"built_in\">run</span></span><br><span class=\"line\">/Users/huyuhan/Project/workspace-go/example/bin/controller-gen rbac:<span class=\"attribute\">roleName</span>=manager-role crd webhook <span class=\"attribute\">paths</span>=<span class=\"string\">&quot;./...&quot;</span> output:crd:artifacts:<span class=\"attribute\">config</span>=config/crd/bases</span><br><span class=\"line\">/Users/huyuhan/Project/workspace-go/example/bin/controller-gen object:<span class=\"attribute\">headerFile</span>=<span class=\"string\">&quot;hack/boilerplate.go.txt&quot;</span> <span class=\"attribute\">paths</span>=<span class=\"string\">&quot;./...&quot;</span></span><br><span class=\"line\">go fmt ./<span class=\"built_in\">..</span>.</span><br><span class=\"line\">go vet ./<span class=\"built_in\">..</span>.</span><br><span class=\"line\">go <span class=\"built_in\">run</span> ./main.go</span><br><span class=\"line\">2022-01-27T22:05:30.207+0800\t<span class=\"built_in\">INFO</span>\tcontroller-runtime.metrics\tmetrics<span class=\"built_in\"> server </span>is starting <span class=\"keyword\">to</span> listen\t&#123;<span class=\"string\">&quot;addr&quot;</span>: <span class=\"string\">&quot;:8080&quot;</span>&#125;</span><br><span class=\"line\">2022-01-27T22:05:30.207+0800\t<span class=\"built_in\">INFO</span>\tsetup\tstarting manager</span><br><span class=\"line\">2022-01-27T22:05:30.208+0800\t<span class=\"built_in\">INFO</span>\tstarting metrics<span class=\"built_in\"> server\t</span>&#123;<span class=\"string\">&quot;path&quot;</span>: <span class=\"string\">&quot;/metrics&quot;</span>&#125;</span><br><span class=\"line\">2022-01-27T22:05:30.208+0800\t<span class=\"built_in\">INFO</span>\tcontroller.bucket\tStarting EventSource\t&#123;<span class=\"string\">&quot;reconciler group&quot;</span>: <span class=\"string\">&quot;cos.marklu.com&quot;</span>, <span class=\"string\">&quot;reconciler kind&quot;</span>: <span class=\"string\">&quot;Bucket&quot;</span>, <span class=\"string\">&quot;source&quot;</span>: <span class=\"string\">&quot;kind source: /, Kind=&quot;</span>&#125;</span><br><span class=\"line\">2022-01-27T22:05:30.208+0800\t<span class=\"built_in\">INFO</span>\tcontroller.bucket\tStarting Controller\t&#123;<span class=\"string\">&quot;reconciler group&quot;</span>: <span class=\"string\">&quot;cos.marklu.com&quot;</span>, <span class=\"string\">&quot;reconciler kind&quot;</span>: <span class=\"string\">&quot;Bucket&quot;</span>&#125;</span><br><span class=\"line\">2022-01-27T22:05:30.309+0800\t<span class=\"built_in\">INFO</span>\tcontroller.bucket\tStarting workers\t&#123;<span class=\"string\">&quot;reconciler group&quot;</span>: <span class=\"string\">&quot;cos.marklu.com&quot;</span>, <span class=\"string\">&quot;reconciler kind&quot;</span>: <span class=\"string\">&quot;Bucket&quot;</span>, <span class=\"string\">&quot;worker count&quot;</span>: 1&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<ol start=\"3\">\n<li>Create Custom Resources (create <a href=\"http://bucket.cos.marklu.com/bucket-sample\">bucket.cos.marklu.com/bucket-sample</a>) (cos_v1_bucket.yaml)</li>\n</ol>\n</blockquote>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">apiVersion:</span> cos.marklu.com/v1</span><br><span class=\"line\"><span class=\"symbol\">kind:</span> Bucket</span><br><span class=\"line\"><span class=\"symbol\">metadata:</span></span><br><span class=\"line\"><span class=\"symbol\">  name:</span> bucket-sample</span><br><span class=\"line\"><span class=\"symbol\">  namespace:</span> marklu</span><br><span class=\"line\"><span class=\"symbol\">spec:</span></span><br><span class=\"line\">  <span class=\"meta\"># TODO(user): Add fields here</span></span><br><span class=\"line\"><span class=\"symbol\">  name:</span> example<span class=\"number\">-1251762279</span></span><br><span class=\"line\"><span class=\"symbol\">  region:</span> ap-shanghai</span><br><span class=\"line\"><span class=\"symbol\">  acl:</span> private</span><br></pre></td></tr></table></figure>\n<p>kubectl apply -f cos_v1_bucket.yaml</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[marklu@MacBook ~]</span>$ kubectl apply -f cos_v1_bucket<span class=\"selector-class\">.yaml</span></span><br><span class=\"line\">bucket<span class=\"selector-class\">.cos</span><span class=\"selector-class\">.marklu</span>.com/bucket-sample created</span><br><span class=\"line\"><span class=\"selector-attr\">[marklu@MacBook ~]</span>$ kubectl get bucket<span class=\"selector-class\">.cos</span><span class=\"selector-class\">.marklu</span><span class=\"selector-class\">.com</span>  -n marklu</span><br><span class=\"line\">NAME            AGE</span><br><span class=\"line\">bucket-sample   <span class=\"number\">17s</span></span><br></pre></td></tr></table></figure>\n<p>Tencent cloud console view found that the bucket was created normally.</p>\n<blockquote>\n<ol start=\"4\">\n<li>Delete Instances of Custom Resources (delete <a href=\"http://bucket.cos.marklu.com/bucket-sample\">bucket.cos.marklu.com/bucket-sample</a>)</li>\n</ol>\n</blockquote>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[marklu@MacBook ~]</span>$ kubectl delete -f cos_v1_bucket<span class=\"selector-class\">.yaml</span></span><br><span class=\"line\">bucket<span class=\"selector-class\">.cos</span><span class=\"selector-class\">.marklu</span><span class=\"selector-class\">.com</span> <span class=\"string\">&quot;bucket-sample&quot;</span> deleted</span><br></pre></td></tr></table></figure>\n<h1 id=\"run-it-on-the-cluster\"><a class=\"markdownIt-Anchor\" href=\"#run-it-on-the-cluster\"></a> Run It On the Cluster</h1>\n<blockquote>\n<p>Deploy the controller to the cluster with image specified by IMG</p>\n</blockquote>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">make</span> docker-build docker-push IMG=<span class=\"symbol\">&lt;some-registry&gt;</span>/<span class=\"symbol\">&lt;project-name&gt;</span>:<span class=\"keyword\">tag</span></span><br><span class=\"line\"><span class=\"keyword\">make</span> deploy IMG=<span class=\"symbol\">&lt;some-registry&gt;</span>/<span class=\"symbol\">&lt;project-name&gt;</span>:<span class=\"keyword\">tag</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"reference-documentation\"><a class=\"markdownIt-Anchor\" href=\"#reference-documentation\"></a> Reference documentation</h1>\n<ul>\n<li><a href=\"https://github.com/kubernetes-sigs/kubebuilder\">https://github.com/kubernetes-sigs/kubebuilder</a></li>\n<li><a href=\"https://book.kubebuilder.io/introduction.html\">https://book.kubebuilder.io/introduction.html</a></li>\n<li><a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/operator/\">https://kubernetes.io/docs/concepts/extend-kubernetes/operator/</a></li>\n</ul>\n"},{"title":"Kubebuilder Watch Rresources","sidebar":"none","_content":"我们在开发过程中，可能需要开发一个类似Deployment的资源逻辑，管理依赖资源是控制器的基础，如果不能观察它们的状态变化就不可能管理它们。这就意味着，我们需要 reconciler 能监控多个资源的变化。\n\n> NOTE: Deployment 必须知道其管理的 ReplicaSet 何时更改，ReplicaSet 必须知道其管理的 Pod 何时被删除，或者从健康变为不健康等。\n\n控制器运行时库为管理和监视资源提供了多种方式。这包括从简单而明显的用例（例如查看由控制器创建和管理的资源）到更独特和更高级的用例。\n\n•控制器创建和管理的资源 (Watching Operator Managed Resources)\n•外部管理的资源 (Watching Externally Managed Resources)\n\n# 背景\n以 Tcaplus 资源为例，Tcaplus 资源通过 ConfigMap（proto 文件）来创建表格。当 ConfigMap 发生变化时自动更新表格，下面例子不实际调用腾讯云API，只要验证接收到事件请求即可。\n\n>NOTE: TcaplusDB 是腾讯出品的分布式NoSQL数据库。官方API文档：https://cloud.tencent.com/document/product/596/39648。\n\n# 控制器创建和管理的资源\n资源定义 (Defined Tcaplus Resources)\napi/v1/tcaplus_types.go\n```\ntype TcaplusSpec struct {\n    Checksum string `json:\"checksum,omitempty\"`\n    ConfigMapTemplate ConfigMapTemplate `json:\"configMapTemplate,omitempty\"`\n}\n\ntype ConfigMapTemplate struct {\n    Name string `json:\"name,omitempty\"`\n    Data map[string]string `json:\"data,omitempty\"`\n}\n```\n# 控制器逻辑 (Manage the Owned Resource)\n## controllers/tcaplus_controller.go\n当 tcaplus CR 创建时根据 ConfigMapTemplate 创建附属的 ConfigMap 资源并设置属主关系。\n\n•Reconcile 方法：根据模版创建 ConfigMap 并设置属主关系\n•SetupWithManager 方法：For 方法之后调用 Owns 方法\n```\nfunc (r *TcaplusReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {\n\tlogger := log.FromContext(ctx)\n\n\tlogger.Info(\"reconciling\")\n\ttcaplus := &examplev1.Tcaplus{}\n\tif err := r.Get(ctx, req.NamespacedName, tcaplus); err != nil {\n\t\treturn ctrl.Result{}, client.IgnoreNotFound(err)\n\t}\n\n\tconfigMap := &corev1.ConfigMap{}\n\tconfigMap.Name = tcaplus.Spec.ConfigMapTemplate.Name\n\tconfigMap.Namespace = tcaplus.Namespace\n\tconfigMap.Data = tcaplus.Spec.ConfigMapTemplate.Data\n    \n\tif err := controllerutil.SetControllerReference(tcaplus, configMap, r.Scheme); err != nil {\n\t\tlogger.Error(err, \"get configmap failed\", \"configmap\", configMap.Name)\n\t\treturn ctrl.Result{}, err\n\t}\n\n\tfoundConfigMap := &corev1.ConfigMap{}\n\terr := r.Get(ctx, types.NamespacedName{Name: configMap.Name, Namespace: tcaplus.Namespace}, foundConfigMap)\n\tif err != nil && errors.IsNotFound(err) {\n\t\tlogger.V(1).Info(\"creating configmap\", \"configmap\", configMap.Name)\n\t\terr = r.Create(ctx, configMap)\n\t}\n\treturn ctrl.Result{}, nil\n}\n\n// SetupWithManager sets up the controller with the Manager.\nfunc (r *TcaplusReconciler) SetupWithManager(mgr ctrl.Manager) error {\n\treturn ctrl.NewControllerManagedBy(mgr).\n\t\tFor(&examplev1.Tcaplus{}).\n\t\tOwns(&corev1.ConfigMap{}).\n\t\tComplete(r)\n}\n```\n\n> NOTE：同一控制器创建的资源才可以设置属主关系，不然会提示：already owned by another controller。\n\n# 测试\nconfig/samples/example_v1_tcaplus.yaml\n```\napiVersion: example.blazehu.com/v1\nkind: Tcaplus\nmetadata:\n  name: tcaplus-sample\nspec:\n  checksum: \"123\"\n  configMapTemplate:\n    name: \"tcaplus-configmap-example\"\n    data:\n      demo.proto: |\n        syntax = \"proto3\";\n        package example;\n        message Example {\n          uint32 a = 1;\n          uint32 b = 2;\n          uint32 c = 3;\n        }\n```\n使用上述配置文件创建 tcaplus 资源。创建结果：\n```\nmarklu-MB2:samples $ k get tcaplus\nNAME AGE\ntcaplus-sample 19m\nmarklu-MB2:samples $ k get configmap\nNAME DATA AGE\ntcaplus-configmap-example 1 19m\n```\n可以查看 tcaplus-configmap-example 的属主关系：\n```\napiVersion: v1\ndata:\n  demo.proto: |\n    syntax = \"proto3\";\n    package example;\n    message Example {\n      uint32 a = 1;\n      uint32 b = 2;\n    }\nkind: ConfigMap\nmetadata:\n  creationTimestamp: \"2022-07-07T09:02:43Z\"\n  name: tcaplus-configmap-example\n  namespace: default\n  ownerReferences:\n  - apiVersion: example.blazehu.com/v1\n    blockOwnerDeletion: true\n    controller: true\n    kind: Tcaplus\n    name: tcaplus-sample\n    uid: 7c50f2e1-0e37-4aa0-bf49-c2d410d6153e\n  resourceVersion: \"6837330713\"\n  selfLink: /api/v1/namespaces/default/configmaps/tcaplus-configmap-example\n  uid: 6c29f90b-0e51-4d9f-a6a8-cfb6906ed1b0\n```\n手动修改 tcaplus-sample 和 tcaplus-configmap-example 后查看控制器日志发现能正常观察 CR 和 ConfigMap 的变化了。\n\n# 外部管理的资源\n资源定义 (Defined Tcaplus Resources)\napi/v1/tcaplus_types.go\n```\ntype TcaplusSpec struct {\n\tChecksum     string             `json:\"checksum,omitempty\"`\n\tConfigMapRef ConfigMapReference `json:\"configMapRef,omitempty\"`\n}\n\ntype ConfigMapReference struct {\n\tName string `json:\"name,omitempty\"`\n}\n```\n# 控制器逻辑 (Manage the Owned Resource)\n##### controllers/tcaplus_controller.go\nFor 方法之后调用 Watches 方法就可以监听对应资源的事件，但是会监听集群里所有相关资源的事件，所以这里我们自定义事件处理方法来过滤出我们关注的资源的事件。\n\n•通过 EnqueueRequestsFromMapFunc 创建一个事件处理方法，该方法通过 FieldSelector 在 ConfigMap 的事件中过滤出跟 tcaplus CR 相关联的事件。\n•使用 FieldSelector 时我们需要建立对应的索引，使用 mgr.GetFieldIndexer().IndexField() 创建。\n```\nconst (\n    ConfigMapField = \".spec.configMapRef.name\"\n) \nfunc (r *TcaplusReconciler) findObjectsForConfigMap(configMap client.Object) []reconcile.Request {\n    attachedTcaplusList := &examplev1.TcaplusList{}\n    listOps := &client.ListOptions{\n        FieldSelector: fields.OneTermEqualSelector(ConfigMapField, configMap.GetName()),\n        Namespace: configMap.GetNamespace(),\n    }\n    err := r.List(context.TODO(), attachedTcaplusList, listOps)\n    if err != nil {\n        return []reconcile.Request{}\n    }\n    requests := make([]reconcile.Request, len(attachedTcaplusList.Items))\n    for i, item := range attachedTcaplusList.Items {\n        requests[i] = reconcile.Request{\n            NamespacedName: types.NamespacedName{\n                Name: item.GetName(),\n                Namespace: item.GetNamespace(),\n            },\n        }\n    }\n    return requests\n} \n\n// SetupWithManager sets up the controller with the Manager.\nfunc (r *TcaplusReconciler) SetupWithManager(mgr ctrl.Manager) error {\n\tif err := mgr.GetFieldIndexer().IndexField(context.Background(), &examplev1.Tcaplus{}, ConfigMapField, func(rawObj client.Object) []string {\n\t\ttcaplus := rawObj.(*examplev1.Tcaplus)\n\t\tif tcaplus.Spec.ConfigMapRef.Name == \"\" {\n\t\t\treturn nil\n\t\t}\n\t\treturn []string{tcaplus.Spec.ConfigMapRef.Name}\n\t}); err != nil {\n\t\treturn err\n\t}\n\n\treturn ctrl.NewControllerManagedBy(mgr).\n\t\tFor(&examplev1.Tcaplus{}).\n\t\tWatches(\n\t\t\t&source.Kind{Type: &corev1.ConfigMap{}},\n\t\t\thandler.EnqueueRequestsFromMapFunc(r.findObjectsForConfigMap),\n\t\t\tbuilder.WithPredicates(predicate.ResourceVersionChangedPredicate{}),\n\t\t).\n\t\tComplete(r)\n}\n```\n> NOTE: 我们也可以自己定一个变更过滤器 Predicate。也可以通过 WithEventFilter 来针对监听的所有资源过滤。\n# 测试\nconfig/samples/example_v1_tcaplus.yaml\n```\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: tcaplus-configmap-example\ndata:\n  demo.proto: |\n    syntax = \"proto3\";\n    package example;\n    message Example {\n      uint32 a = 1;\n      uint32 b = 2;\n      uint32 c = 3;\n    }\n\n---\napiVersion: example.blazehu.com/v1\nkind: Tcaplus\nmetadata:\n  name: tcaplus-sample\nspec:\n  checksum: \"123\"\n  configMapRef:\n    name: \"tcaplus-configmap-example\"\n```\n\n使用上述配置创建完毕后，手动修改 tcaplus-sample 和 tcaplus-configmap-example 查看控制器日志发现同样能正常观察 CR 和 ConfigMap 的变化。\n\n> NOTE: 查看 tcaplus-configmap-example 可以看到没有和 tcaplus 的属主关系。\n\n# 总结\n•EventHandler 可以在 watch 特定资源时设置该资源的事件监听规则。\n•WithEventFilter 配置变更过滤器，可以针对 watch 的所有资源，统一地设置事件监听规则。\n•Owns 源码分析可以发现 Owns 相当于调用 Watches(&source.Kind{Type: <ForType-forInput>}, &handler.EnqueueRequestForOwner{OwnerType: apiType, IsController: true})。\n\n# 参考文档\n•https://www.kubebuilder.io/reference/watching-resources.html\n•https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/owners-dependents/\n•https://segmentfault.com/a/1190000020359577","source":"_posts/kubebuilder-watch-resources.md","raw":"---\ntitle: Kubebuilder Watch Rresources\ncategories: \n  - Kubebuilder\ntags:\n  - k8s\nsidebar: none \n---\n我们在开发过程中，可能需要开发一个类似Deployment的资源逻辑，管理依赖资源是控制器的基础，如果不能观察它们的状态变化就不可能管理它们。这就意味着，我们需要 reconciler 能监控多个资源的变化。\n\n> NOTE: Deployment 必须知道其管理的 ReplicaSet 何时更改，ReplicaSet 必须知道其管理的 Pod 何时被删除，或者从健康变为不健康等。\n\n控制器运行时库为管理和监视资源提供了多种方式。这包括从简单而明显的用例（例如查看由控制器创建和管理的资源）到更独特和更高级的用例。\n\n•控制器创建和管理的资源 (Watching Operator Managed Resources)\n•外部管理的资源 (Watching Externally Managed Resources)\n\n# 背景\n以 Tcaplus 资源为例，Tcaplus 资源通过 ConfigMap（proto 文件）来创建表格。当 ConfigMap 发生变化时自动更新表格，下面例子不实际调用腾讯云API，只要验证接收到事件请求即可。\n\n>NOTE: TcaplusDB 是腾讯出品的分布式NoSQL数据库。官方API文档：https://cloud.tencent.com/document/product/596/39648。\n\n# 控制器创建和管理的资源\n资源定义 (Defined Tcaplus Resources)\napi/v1/tcaplus_types.go\n```\ntype TcaplusSpec struct {\n    Checksum string `json:\"checksum,omitempty\"`\n    ConfigMapTemplate ConfigMapTemplate `json:\"configMapTemplate,omitempty\"`\n}\n\ntype ConfigMapTemplate struct {\n    Name string `json:\"name,omitempty\"`\n    Data map[string]string `json:\"data,omitempty\"`\n}\n```\n# 控制器逻辑 (Manage the Owned Resource)\n## controllers/tcaplus_controller.go\n当 tcaplus CR 创建时根据 ConfigMapTemplate 创建附属的 ConfigMap 资源并设置属主关系。\n\n•Reconcile 方法：根据模版创建 ConfigMap 并设置属主关系\n•SetupWithManager 方法：For 方法之后调用 Owns 方法\n```\nfunc (r *TcaplusReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {\n\tlogger := log.FromContext(ctx)\n\n\tlogger.Info(\"reconciling\")\n\ttcaplus := &examplev1.Tcaplus{}\n\tif err := r.Get(ctx, req.NamespacedName, tcaplus); err != nil {\n\t\treturn ctrl.Result{}, client.IgnoreNotFound(err)\n\t}\n\n\tconfigMap := &corev1.ConfigMap{}\n\tconfigMap.Name = tcaplus.Spec.ConfigMapTemplate.Name\n\tconfigMap.Namespace = tcaplus.Namespace\n\tconfigMap.Data = tcaplus.Spec.ConfigMapTemplate.Data\n    \n\tif err := controllerutil.SetControllerReference(tcaplus, configMap, r.Scheme); err != nil {\n\t\tlogger.Error(err, \"get configmap failed\", \"configmap\", configMap.Name)\n\t\treturn ctrl.Result{}, err\n\t}\n\n\tfoundConfigMap := &corev1.ConfigMap{}\n\terr := r.Get(ctx, types.NamespacedName{Name: configMap.Name, Namespace: tcaplus.Namespace}, foundConfigMap)\n\tif err != nil && errors.IsNotFound(err) {\n\t\tlogger.V(1).Info(\"creating configmap\", \"configmap\", configMap.Name)\n\t\terr = r.Create(ctx, configMap)\n\t}\n\treturn ctrl.Result{}, nil\n}\n\n// SetupWithManager sets up the controller with the Manager.\nfunc (r *TcaplusReconciler) SetupWithManager(mgr ctrl.Manager) error {\n\treturn ctrl.NewControllerManagedBy(mgr).\n\t\tFor(&examplev1.Tcaplus{}).\n\t\tOwns(&corev1.ConfigMap{}).\n\t\tComplete(r)\n}\n```\n\n> NOTE：同一控制器创建的资源才可以设置属主关系，不然会提示：already owned by another controller。\n\n# 测试\nconfig/samples/example_v1_tcaplus.yaml\n```\napiVersion: example.blazehu.com/v1\nkind: Tcaplus\nmetadata:\n  name: tcaplus-sample\nspec:\n  checksum: \"123\"\n  configMapTemplate:\n    name: \"tcaplus-configmap-example\"\n    data:\n      demo.proto: |\n        syntax = \"proto3\";\n        package example;\n        message Example {\n          uint32 a = 1;\n          uint32 b = 2;\n          uint32 c = 3;\n        }\n```\n使用上述配置文件创建 tcaplus 资源。创建结果：\n```\nmarklu-MB2:samples $ k get tcaplus\nNAME AGE\ntcaplus-sample 19m\nmarklu-MB2:samples $ k get configmap\nNAME DATA AGE\ntcaplus-configmap-example 1 19m\n```\n可以查看 tcaplus-configmap-example 的属主关系：\n```\napiVersion: v1\ndata:\n  demo.proto: |\n    syntax = \"proto3\";\n    package example;\n    message Example {\n      uint32 a = 1;\n      uint32 b = 2;\n    }\nkind: ConfigMap\nmetadata:\n  creationTimestamp: \"2022-07-07T09:02:43Z\"\n  name: tcaplus-configmap-example\n  namespace: default\n  ownerReferences:\n  - apiVersion: example.blazehu.com/v1\n    blockOwnerDeletion: true\n    controller: true\n    kind: Tcaplus\n    name: tcaplus-sample\n    uid: 7c50f2e1-0e37-4aa0-bf49-c2d410d6153e\n  resourceVersion: \"6837330713\"\n  selfLink: /api/v1/namespaces/default/configmaps/tcaplus-configmap-example\n  uid: 6c29f90b-0e51-4d9f-a6a8-cfb6906ed1b0\n```\n手动修改 tcaplus-sample 和 tcaplus-configmap-example 后查看控制器日志发现能正常观察 CR 和 ConfigMap 的变化了。\n\n# 外部管理的资源\n资源定义 (Defined Tcaplus Resources)\napi/v1/tcaplus_types.go\n```\ntype TcaplusSpec struct {\n\tChecksum     string             `json:\"checksum,omitempty\"`\n\tConfigMapRef ConfigMapReference `json:\"configMapRef,omitempty\"`\n}\n\ntype ConfigMapReference struct {\n\tName string `json:\"name,omitempty\"`\n}\n```\n# 控制器逻辑 (Manage the Owned Resource)\n##### controllers/tcaplus_controller.go\nFor 方法之后调用 Watches 方法就可以监听对应资源的事件，但是会监听集群里所有相关资源的事件，所以这里我们自定义事件处理方法来过滤出我们关注的资源的事件。\n\n•通过 EnqueueRequestsFromMapFunc 创建一个事件处理方法，该方法通过 FieldSelector 在 ConfigMap 的事件中过滤出跟 tcaplus CR 相关联的事件。\n•使用 FieldSelector 时我们需要建立对应的索引，使用 mgr.GetFieldIndexer().IndexField() 创建。\n```\nconst (\n    ConfigMapField = \".spec.configMapRef.name\"\n) \nfunc (r *TcaplusReconciler) findObjectsForConfigMap(configMap client.Object) []reconcile.Request {\n    attachedTcaplusList := &examplev1.TcaplusList{}\n    listOps := &client.ListOptions{\n        FieldSelector: fields.OneTermEqualSelector(ConfigMapField, configMap.GetName()),\n        Namespace: configMap.GetNamespace(),\n    }\n    err := r.List(context.TODO(), attachedTcaplusList, listOps)\n    if err != nil {\n        return []reconcile.Request{}\n    }\n    requests := make([]reconcile.Request, len(attachedTcaplusList.Items))\n    for i, item := range attachedTcaplusList.Items {\n        requests[i] = reconcile.Request{\n            NamespacedName: types.NamespacedName{\n                Name: item.GetName(),\n                Namespace: item.GetNamespace(),\n            },\n        }\n    }\n    return requests\n} \n\n// SetupWithManager sets up the controller with the Manager.\nfunc (r *TcaplusReconciler) SetupWithManager(mgr ctrl.Manager) error {\n\tif err := mgr.GetFieldIndexer().IndexField(context.Background(), &examplev1.Tcaplus{}, ConfigMapField, func(rawObj client.Object) []string {\n\t\ttcaplus := rawObj.(*examplev1.Tcaplus)\n\t\tif tcaplus.Spec.ConfigMapRef.Name == \"\" {\n\t\t\treturn nil\n\t\t}\n\t\treturn []string{tcaplus.Spec.ConfigMapRef.Name}\n\t}); err != nil {\n\t\treturn err\n\t}\n\n\treturn ctrl.NewControllerManagedBy(mgr).\n\t\tFor(&examplev1.Tcaplus{}).\n\t\tWatches(\n\t\t\t&source.Kind{Type: &corev1.ConfigMap{}},\n\t\t\thandler.EnqueueRequestsFromMapFunc(r.findObjectsForConfigMap),\n\t\t\tbuilder.WithPredicates(predicate.ResourceVersionChangedPredicate{}),\n\t\t).\n\t\tComplete(r)\n}\n```\n> NOTE: 我们也可以自己定一个变更过滤器 Predicate。也可以通过 WithEventFilter 来针对监听的所有资源过滤。\n# 测试\nconfig/samples/example_v1_tcaplus.yaml\n```\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: tcaplus-configmap-example\ndata:\n  demo.proto: |\n    syntax = \"proto3\";\n    package example;\n    message Example {\n      uint32 a = 1;\n      uint32 b = 2;\n      uint32 c = 3;\n    }\n\n---\napiVersion: example.blazehu.com/v1\nkind: Tcaplus\nmetadata:\n  name: tcaplus-sample\nspec:\n  checksum: \"123\"\n  configMapRef:\n    name: \"tcaplus-configmap-example\"\n```\n\n使用上述配置创建完毕后，手动修改 tcaplus-sample 和 tcaplus-configmap-example 查看控制器日志发现同样能正常观察 CR 和 ConfigMap 的变化。\n\n> NOTE: 查看 tcaplus-configmap-example 可以看到没有和 tcaplus 的属主关系。\n\n# 总结\n•EventHandler 可以在 watch 特定资源时设置该资源的事件监听规则。\n•WithEventFilter 配置变更过滤器，可以针对 watch 的所有资源，统一地设置事件监听规则。\n•Owns 源码分析可以发现 Owns 相当于调用 Watches(&source.Kind{Type: <ForType-forInput>}, &handler.EnqueueRequestForOwner{OwnerType: apiType, IsController: true})。\n\n# 参考文档\n•https://www.kubebuilder.io/reference/watching-resources.html\n•https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/owners-dependents/\n•https://segmentfault.com/a/1190000020359577","slug":"kubebuilder-watch-resources","published":1,"date":"2023-05-23T03:51:52.668Z","updated":"2023-05-25T16:05:03.803Z","_id":"clhzqpixk0007w8f84rcm9e90","comments":1,"layout":"post","photos":[],"link":"","content":"<p>我们在开发过程中，可能需要开发一个类似Deployment的资源逻辑，管理依赖资源是控制器的基础，如果不能观察它们的状态变化就不可能管理它们。这就意味着，我们需要 reconciler 能监控多个资源的变化。</p>\n<blockquote>\n<p>NOTE: Deployment 必须知道其管理的 ReplicaSet 何时更改，ReplicaSet 必须知道其管理的 Pod 何时被删除，或者从健康变为不健康等。</p>\n</blockquote>\n<p>控制器运行时库为管理和监视资源提供了多种方式。这包括从简单而明显的用例（例如查看由控制器创建和管理的资源）到更独特和更高级的用例。</p>\n<p>•控制器创建和管理的资源 (Watching Operator Managed Resources)<br />\n•外部管理的资源 (Watching Externally Managed Resources)</p>\n<h1 id=\"背景\"><a class=\"markdownIt-Anchor\" href=\"#背景\"></a> 背景</h1>\n<p>以 Tcaplus 资源为例，Tcaplus 资源通过 ConfigMap（proto 文件）来创建表格。当 ConfigMap 发生变化时自动更新表格，下面例子不实际调用腾讯云API，只要验证接收到事件请求即可。</p>\n<blockquote>\n<p>NOTE: TcaplusDB 是腾讯出品的分布式NoSQL数据库。官方API文档：<a href=\"https://cloud.tencent.com/document/product/596/39648%E3%80%82\">https://cloud.tencent.com/document/product/596/39648。</a></p>\n</blockquote>\n<h1 id=\"控制器创建和管理的资源\"><a class=\"markdownIt-Anchor\" href=\"#控制器创建和管理的资源\"></a> 控制器创建和管理的资源</h1>\n<p>资源定义 (Defined Tcaplus Resources)<br />\napi/v1/tcaplus_types.go</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> TcaplusSpec <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    Checksum <span class=\"type\">string</span> <span class=\"string\">`json:&quot;checksum,omitempty&quot;`</span></span><br><span class=\"line\">    ConfigMapTemplate ConfigMapTemplate <span class=\"string\">`json:&quot;configMapTemplate,omitempty&quot;`</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> ConfigMapTemplate <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    Name <span class=\"type\">string</span> <span class=\"string\">`json:&quot;name,omitempty&quot;`</span></span><br><span class=\"line\">    Data <span class=\"keyword\">map</span>[<span class=\"type\">string</span>]<span class=\"type\">string</span> <span class=\"string\">`json:&quot;data,omitempty&quot;`</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"控制器逻辑-manage-the-owned-resource\"><a class=\"markdownIt-Anchor\" href=\"#控制器逻辑-manage-the-owned-resource\"></a> 控制器逻辑 (Manage the Owned Resource)</h1>\n<h2 id=\"controllerstcaplus_controllergo\"><a class=\"markdownIt-Anchor\" href=\"#controllerstcaplus_controllergo\"></a> controllers/tcaplus_controller.go</h2>\n<p>当 tcaplus CR 创建时根据 ConfigMapTemplate 创建附属的 ConfigMap 资源并设置属主关系。</p>\n<p>•Reconcile 方法：根据模版创建 ConfigMap 并设置属主关系<br />\n•SetupWithManager 方法：For 方法之后调用 Owns 方法</p>\n<figure class=\"highlight roboconf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (r *TcaplusReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">logger</span> := log<span class=\"variable\">.FromContext</span>(ctx)</span><br><span class=\"line\"></span><br><span class=\"line\">\tlogger<span class=\"variable\">.Info</span>(&quot;reconciling&quot;)</span><br><span class=\"line\">\ttcaplus := &amp;examplev1<span class=\"variable\">.Tcaplus</span>&#123;&#125;</span><br><span class=\"line\">\tif err := r<span class=\"variable\">.Get</span>(ctx, req<span class=\"variable\">.NamespacedName</span>, tcaplus); <span class=\"attribute\">err != nil &#123;</span></span><br><span class=\"line\"><span class=\"attribute\">\t\treturn ctrl.Result&#123;&#125;, client.IgnoreNotFound(err)</span></span><br><span class=\"line\"><span class=\"attribute\">\t&#125;</span></span><br><span class=\"line\"><span class=\"attribute\"></span></span><br><span class=\"line\"><span class=\"attribute\">\tconfigMap</span> := &amp;corev1<span class=\"variable\">.ConfigMap</span>&#123;&#125;</span><br><span class=\"line\">\tconfigMap<span class=\"variable\">.Name</span> = tcaplus<span class=\"variable\">.Spec</span><span class=\"variable\">.ConfigMapTemplate</span><span class=\"variable\">.Name</span></span><br><span class=\"line\">\tconfigMap<span class=\"variable\">.Namespace</span> = tcaplus<span class=\"variable\">.Namespace</span></span><br><span class=\"line\">\tconfigMap<span class=\"variable\">.Data</span> = tcaplus<span class=\"variable\">.Spec</span><span class=\"variable\">.ConfigMapTemplate</span><span class=\"variable\">.Data</span></span><br><span class=\"line\">    </span><br><span class=\"line\">\tif err := controllerutil<span class=\"variable\">.SetControllerReference</span>(tcaplus, configMap, r<span class=\"variable\">.Scheme</span>); <span class=\"attribute\">err != nil &#123;</span></span><br><span class=\"line\"><span class=\"attribute\">\t\tlogger.Error(err, &quot;get configmap failed&quot;, &quot;configmap&quot;, configMap.Name)</span></span><br><span class=\"line\"><span class=\"attribute\">\t\treturn ctrl.Result&#123;&#125;, err</span></span><br><span class=\"line\"><span class=\"attribute\">\t&#125;</span></span><br><span class=\"line\"><span class=\"attribute\"></span></span><br><span class=\"line\"><span class=\"attribute\">\tfoundConfigMap</span> := &amp;corev1<span class=\"variable\">.ConfigMap</span>&#123;&#125;</span><br><span class=\"line\">\terr := r<span class=\"variable\">.Get</span>(ctx, types<span class=\"variable\">.NamespacedName</span>&#123;Name: configMap<span class=\"variable\">.Name</span>, Namespace: tcaplus<span class=\"variable\">.Namespace</span>&#125;, foundConfigMap)</span><br><span class=\"line\">\tif err != nil &amp;&amp; errors<span class=\"variable\">.IsNotFound</span>(err) &#123;</span><br><span class=\"line\">\t\tlogger<span class=\"variable\">.V</span>(1)<span class=\"variable\">.Info</span>(&quot;creating configmap&quot;, &quot;configmap&quot;, configMap<span class=\"variable\">.Name</span>)</span><br><span class=\"line\">\t\terr = r<span class=\"variable\">.Create</span>(ctx, configMap)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn ctrl<span class=\"variable\">.Result</span>&#123;&#125;, nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// SetupWithManager sets up the controller with the Manager.</span><br><span class=\"line\">func (r *TcaplusReconciler) SetupWithManager(mgr ctrl<span class=\"variable\">.Manager</span>) error &#123;</span><br><span class=\"line\">\treturn ctrl<span class=\"variable\">.NewControllerManagedBy</span>(mgr).</span><br><span class=\"line\">\t\tFor(&amp;examplev1<span class=\"variable\">.Tcaplus</span>&#123;&#125;).</span><br><span class=\"line\">\t\tOwns(&amp;corev1<span class=\"variable\">.ConfigMap</span>&#123;&#125;).</span><br><span class=\"line\">\t\tComplete(r)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>NOTE：同一控制器创建的资源才可以设置属主关系，不然会提示：already owned by another controller。</p>\n</blockquote>\n<h1 id=\"测试\"><a class=\"markdownIt-Anchor\" href=\"#测试\"></a> 测试</h1>\n<p>config/samples/example_v1_tcaplus.yaml</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">apiVersion:</span> example.blazehu.com/v1</span><br><span class=\"line\"><span class=\"symbol\">kind:</span> Tcaplus</span><br><span class=\"line\"><span class=\"symbol\">metadata:</span></span><br><span class=\"line\"><span class=\"symbol\">  name:</span> tcaplus-sample</span><br><span class=\"line\"><span class=\"symbol\">spec:</span></span><br><span class=\"line\"><span class=\"symbol\">  checksum:</span> <span class=\"string\">&quot;123&quot;</span></span><br><span class=\"line\"><span class=\"symbol\">  configMapTemplate:</span></span><br><span class=\"line\"><span class=\"symbol\">    name:</span> <span class=\"string\">&quot;tcaplus-configmap-example&quot;</span></span><br><span class=\"line\"><span class=\"symbol\">    data:</span></span><br><span class=\"line\">      demo.proto: |</span><br><span class=\"line\">        <span class=\"attr\">syntax</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;proto3&quot;</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">        package <span class=\"attr\">example</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">        message <span class=\"title class_\">Example</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          uint32 a = <span class=\"number\">1</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">          uint32 b = <span class=\"number\">2</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">          uint32 c = <span class=\"number\">3</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>使用上述配置文件创建 tcaplus 资源。创建结果：</p>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">marklu-<span class=\"variable constant_\">MB2</span><span class=\"symbol\">:samples</span> <span class=\"variable\">$ </span>k get tcaplus</span><br><span class=\"line\"><span class=\"variable constant_\">NAME</span> <span class=\"variable constant_\">AGE</span></span><br><span class=\"line\">tcaplus-sample 19m</span><br><span class=\"line\">marklu-<span class=\"variable constant_\">MB2</span><span class=\"symbol\">:samples</span> <span class=\"variable\">$ </span>k get configmap</span><br><span class=\"line\"><span class=\"variable constant_\">NAME</span> <span class=\"variable constant_\">DATA</span> <span class=\"variable constant_\">AGE</span></span><br><span class=\"line\">tcaplus-configmap-example <span class=\"number\">1</span> 19m</span><br></pre></td></tr></table></figure>\n<p>可以查看 tcaplus-configmap-example 的属主关系：</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">apiVersion:</span> v1</span><br><span class=\"line\"><span class=\"symbol\">data:</span></span><br><span class=\"line\">  demo.proto: |</span><br><span class=\"line\">    <span class=\"attr\">syntax</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;proto3&quot;</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">    package <span class=\"attr\">example</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">    message <span class=\"title class_\">Example</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      uint32 a = <span class=\"number\">1</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">      uint32 b = <span class=\"number\">2</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"symbol\">kind:</span> ConfigMap</span><br><span class=\"line\"><span class=\"symbol\">metadata:</span></span><br><span class=\"line\"><span class=\"symbol\">  creationTimestamp:</span> <span class=\"string\">&quot;2022-07-07T09:02:43Z&quot;</span></span><br><span class=\"line\"><span class=\"symbol\">  name:</span> tcaplus-configmap-example</span><br><span class=\"line\"><span class=\"symbol\">  namespace:</span> default</span><br><span class=\"line\"><span class=\"symbol\">  ownerReferences:</span></span><br><span class=\"line\">  - apiVersion: example.blazehu.com/v1</span><br><span class=\"line\"><span class=\"symbol\">    blockOwnerDeletion:</span> true</span><br><span class=\"line\"><span class=\"symbol\">    controller:</span> true</span><br><span class=\"line\"><span class=\"symbol\">    kind:</span> Tcaplus</span><br><span class=\"line\"><span class=\"symbol\">    name:</span> tcaplus-sample</span><br><span class=\"line\"><span class=\"symbol\">    uid:</span> <span class=\"number\">7</span>c50f2e1<span class=\"number\">-0e37</span><span class=\"number\">-4</span>aa0-bf49-c2d410d6153e</span><br><span class=\"line\"><span class=\"symbol\">  resourceVersion:</span> <span class=\"string\">&quot;6837330713&quot;</span></span><br><span class=\"line\"><span class=\"symbol\">  selfLink:</span> <span class=\"keyword\">/api/</span>v1<span class=\"keyword\">/namespaces/</span>default<span class=\"keyword\">/configmaps/</span>tcaplus-configmap-example</span><br><span class=\"line\"><span class=\"symbol\">  uid:</span> <span class=\"number\">6</span>c29f90b<span class=\"number\">-0e51</span><span class=\"number\">-4</span>d9f-a6a8-cfb6906ed1b0</span><br></pre></td></tr></table></figure>\n<p>手动修改 tcaplus-sample 和 tcaplus-configmap-example 后查看控制器日志发现能正常观察 CR 和 ConfigMap 的变化了。</p>\n<h1 id=\"外部管理的资源\"><a class=\"markdownIt-Anchor\" href=\"#外部管理的资源\"></a> 外部管理的资源</h1>\n<p>资源定义 (Defined Tcaplus Resources)<br />\napi/v1/tcaplus_types.go</p>\n<figure class=\"highlight elm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"type\">TcaplusSpec</span> struct &#123;</span><br><span class=\"line\">\t<span class=\"type\">Checksum</span>     string             `json:&quot;checksum,omitempty&quot;`</span><br><span class=\"line\">\t<span class=\"type\">ConfigMapRef</span> <span class=\"type\">ConfigMapReference</span> `json:&quot;configMapRef,omitempty&quot;`</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"type\">ConfigMapReference</span> struct &#123;</span><br><span class=\"line\">\t<span class=\"type\">Name</span> string `json:&quot;name,omitempty&quot;`</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"控制器逻辑-manage-the-owned-resource-2\"><a class=\"markdownIt-Anchor\" href=\"#控制器逻辑-manage-the-owned-resource-2\"></a> 控制器逻辑 (Manage the Owned Resource)</h1>\n<h5 id=\"controllerstcaplus_controllergo-2\"><a class=\"markdownIt-Anchor\" href=\"#controllerstcaplus_controllergo-2\"></a> controllers/tcaplus_controller.go</h5>\n<p>For 方法之后调用 Watches 方法就可以监听对应资源的事件，但是会监听集群里所有相关资源的事件，所以这里我们自定义事件处理方法来过滤出我们关注的资源的事件。</p>\n<p>•通过 EnqueueRequestsFromMapFunc 创建一个事件处理方法，该方法通过 FieldSelector 在 ConfigMap 的事件中过滤出跟 tcaplus CR 相关联的事件。<br />\n•使用 FieldSelector 时我们需要建立对应的索引，使用 mgr.GetFieldIndexer().IndexField() 创建。</p>\n<figure class=\"highlight roboconf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const (</span><br><span class=\"line\">    ConfigMapField = &quot;.spec.configMapRef.name&quot;</span><br><span class=\"line\">) </span><br><span class=\"line\">func (r *TcaplusReconciler) findObjectsForConfigMap(configMap client.Object) []reconcile.Request &#123;</span><br><span class=\"line\">    <span class=\"attribute\">attachedTcaplusList</span> := &amp;examplev1<span class=\"variable\">.TcaplusList</span>&#123;&#125;</span><br><span class=\"line\">    listOps := &amp;client<span class=\"variable\">.ListOptions</span>&#123;</span><br><span class=\"line\">        FieldSelector: fields<span class=\"variable\">.OneTermEqualSelector</span>(ConfigMapField, configMap<span class=\"variable\">.GetName</span>()),</span><br><span class=\"line\">        Namespace: configMap<span class=\"variable\">.GetNamespace</span>(),</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    err := r<span class=\"variable\">.List</span>(context<span class=\"variable\">.TODO</span>(), attachedTcaplusList, listOps)</span><br><span class=\"line\">    if err != nil &#123;</span><br><span class=\"line\">        return []reconcile<span class=\"variable\">.Request</span>&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    requests := make([]reconcile<span class=\"variable\">.Request</span>, len(attachedTcaplusList<span class=\"variable\">.Items</span>))</span><br><span class=\"line\">    for i, item := range attachedTcaplusList<span class=\"variable\">.Items</span> &#123;</span><br><span class=\"line\">        requests[i] = reconcile<span class=\"variable\">.Request</span>&#123;</span><br><span class=\"line\">            NamespacedName: types<span class=\"variable\">.NamespacedName</span>&#123;</span><br><span class=\"line\">                Name: item<span class=\"variable\">.GetName</span>(),</span><br><span class=\"line\">                Namespace: item<span class=\"variable\">.GetNamespace</span>(),</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return requests</span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\">// SetupWithManager sets up the controller with the Manager.</span><br><span class=\"line\">func (r *TcaplusReconciler) SetupWithManager(mgr ctrl<span class=\"variable\">.Manager</span>) error &#123;</span><br><span class=\"line\">\tif err := mgr<span class=\"variable\">.GetFieldIndexer</span>()<span class=\"variable\">.IndexField</span>(context<span class=\"variable\">.Background</span>(), &amp;examplev1<span class=\"variable\">.Tcaplus</span>&#123;&#125;, ConfigMapField, func(rawObj client<span class=\"variable\">.Object</span>) []string &#123;</span><br><span class=\"line\">\t\ttcaplus := rawObj.(*examplev1<span class=\"variable\">.Tcaplus</span>)</span><br><span class=\"line\">\t\tif tcaplus<span class=\"variable\">.Spec</span><span class=\"variable\">.ConfigMapRef</span><span class=\"variable\">.Name</span> == &quot;&quot; &#123;</span><br><span class=\"line\">\t\t\treturn nil</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\treturn []string&#123;tcaplus<span class=\"variable\">.Spec</span><span class=\"variable\">.ConfigMapRef</span><span class=\"variable\">.Name</span>&#125;</span><br><span class=\"line\">\t&#125;); <span class=\"attribute\">err != nil &#123;</span></span><br><span class=\"line\"><span class=\"attribute\">\t\treturn err</span></span><br><span class=\"line\"><span class=\"attribute\">\t&#125;</span></span><br><span class=\"line\"><span class=\"attribute\"></span></span><br><span class=\"line\"><span class=\"attribute\">\treturn ctrl.NewControllerManagedBy(mgr).</span></span><br><span class=\"line\"><span class=\"attribute\">\t\tFor(&amp;examplev1.Tcaplus&#123;&#125;).</span></span><br><span class=\"line\"><span class=\"attribute\">\t\tWatches(</span></span><br><span class=\"line\"><span class=\"attribute\">\t\t\t&amp;source.Kind&#123;Type</span>: &amp;corev1<span class=\"variable\">.ConfigMap</span>&#123;&#125;&#125;,</span><br><span class=\"line\">\t\t\thandler<span class=\"variable\">.EnqueueRequestsFromMapFunc</span>(r<span class=\"variable\">.findObjectsForConfigMap</span>),</span><br><span class=\"line\">\t\t\tbuilder<span class=\"variable\">.WithPredicates</span>(predicate<span class=\"variable\">.ResourceVersionChangedPredicate</span>&#123;&#125;),</span><br><span class=\"line\">\t\t).</span><br><span class=\"line\">\t\tComplete(r)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>NOTE: 我们也可以自己定一个变更过滤器 Predicate。也可以通过 WithEventFilter 来针对监听的所有资源过滤。</p>\n</blockquote>\n<h1 id=\"测试-2\"><a class=\"markdownIt-Anchor\" href=\"#测试-2\"></a> 测试</h1>\n<p>config/samples/example_v1_tcaplus.yaml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">tcaplus-configmap-example</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">demo.proto:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    syntax = &quot;proto3&quot;;</span></span><br><span class=\"line\"><span class=\"string\">    package example;</span></span><br><span class=\"line\"><span class=\"string\">    message Example &#123;</span></span><br><span class=\"line\"><span class=\"string\">      uint32 a = 1;</span></span><br><span class=\"line\"><span class=\"string\">      uint32 b = 2;</span></span><br><span class=\"line\"><span class=\"string\">      uint32 c = 3;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">example.blazehu.com/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Tcaplus</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">tcaplus-sample</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">checksum:</span> <span class=\"string\">&quot;123&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">configMapRef:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">&quot;tcaplus-configmap-example&quot;</span></span><br></pre></td></tr></table></figure>\n<p>使用上述配置创建完毕后，手动修改 tcaplus-sample 和 tcaplus-configmap-example 查看控制器日志发现同样能正常观察 CR 和 ConfigMap 的变化。</p>\n<blockquote>\n<p>NOTE: 查看 tcaplus-configmap-example 可以看到没有和 tcaplus 的属主关系。</p>\n</blockquote>\n<h1 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\"></a> 总结</h1>\n<p>•EventHandler 可以在 watch 特定资源时设置该资源的事件监听规则。<br />\n•WithEventFilter 配置变更过滤器，可以针对 watch 的所有资源，统一地设置事件监听规则。<br />\n•Owns 源码分析可以发现 Owns 相当于调用 Watches(&amp;source.Kind{Type: <ForType-forInput>}, &amp;handler.EnqueueRequestForOwner{OwnerType: apiType, IsController: true})。</p>\n<h1 id=\"参考文档\"><a class=\"markdownIt-Anchor\" href=\"#参考文档\"></a> 参考文档</h1>\n<p>•<a href=\"https://www.kubebuilder.io/reference/watching-resources.html\">https://www.kubebuilder.io/reference/watching-resources.html</a><br />\n•<a href=\"https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/owners-dependents/\">https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/owners-dependents/</a><br />\n•<a href=\"https://segmentfault.com/a/1190000020359577\">https://segmentfault.com/a/1190000020359577</a></p>\n","site":{"data":{"links":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}},"gallery":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}},"excerpt":"","more":"<p>我们在开发过程中，可能需要开发一个类似Deployment的资源逻辑，管理依赖资源是控制器的基础，如果不能观察它们的状态变化就不可能管理它们。这就意味着，我们需要 reconciler 能监控多个资源的变化。</p>\n<blockquote>\n<p>NOTE: Deployment 必须知道其管理的 ReplicaSet 何时更改，ReplicaSet 必须知道其管理的 Pod 何时被删除，或者从健康变为不健康等。</p>\n</blockquote>\n<p>控制器运行时库为管理和监视资源提供了多种方式。这包括从简单而明显的用例（例如查看由控制器创建和管理的资源）到更独特和更高级的用例。</p>\n<p>•控制器创建和管理的资源 (Watching Operator Managed Resources)<br />\n•外部管理的资源 (Watching Externally Managed Resources)</p>\n<h1 id=\"背景\"><a class=\"markdownIt-Anchor\" href=\"#背景\"></a> 背景</h1>\n<p>以 Tcaplus 资源为例，Tcaplus 资源通过 ConfigMap（proto 文件）来创建表格。当 ConfigMap 发生变化时自动更新表格，下面例子不实际调用腾讯云API，只要验证接收到事件请求即可。</p>\n<blockquote>\n<p>NOTE: TcaplusDB 是腾讯出品的分布式NoSQL数据库。官方API文档：<a href=\"https://cloud.tencent.com/document/product/596/39648%E3%80%82\">https://cloud.tencent.com/document/product/596/39648。</a></p>\n</blockquote>\n<h1 id=\"控制器创建和管理的资源\"><a class=\"markdownIt-Anchor\" href=\"#控制器创建和管理的资源\"></a> 控制器创建和管理的资源</h1>\n<p>资源定义 (Defined Tcaplus Resources)<br />\napi/v1/tcaplus_types.go</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> TcaplusSpec <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    Checksum <span class=\"type\">string</span> <span class=\"string\">`json:&quot;checksum,omitempty&quot;`</span></span><br><span class=\"line\">    ConfigMapTemplate ConfigMapTemplate <span class=\"string\">`json:&quot;configMapTemplate,omitempty&quot;`</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> ConfigMapTemplate <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    Name <span class=\"type\">string</span> <span class=\"string\">`json:&quot;name,omitempty&quot;`</span></span><br><span class=\"line\">    Data <span class=\"keyword\">map</span>[<span class=\"type\">string</span>]<span class=\"type\">string</span> <span class=\"string\">`json:&quot;data,omitempty&quot;`</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"控制器逻辑-manage-the-owned-resource\"><a class=\"markdownIt-Anchor\" href=\"#控制器逻辑-manage-the-owned-resource\"></a> 控制器逻辑 (Manage the Owned Resource)</h1>\n<h2 id=\"controllerstcaplus_controllergo\"><a class=\"markdownIt-Anchor\" href=\"#controllerstcaplus_controllergo\"></a> controllers/tcaplus_controller.go</h2>\n<p>当 tcaplus CR 创建时根据 ConfigMapTemplate 创建附属的 ConfigMap 资源并设置属主关系。</p>\n<p>•Reconcile 方法：根据模版创建 ConfigMap 并设置属主关系<br />\n•SetupWithManager 方法：For 方法之后调用 Owns 方法</p>\n<figure class=\"highlight roboconf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">func (r *TcaplusReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">logger</span> := log<span class=\"variable\">.FromContext</span>(ctx)</span><br><span class=\"line\"></span><br><span class=\"line\">\tlogger<span class=\"variable\">.Info</span>(&quot;reconciling&quot;)</span><br><span class=\"line\">\ttcaplus := &amp;examplev1<span class=\"variable\">.Tcaplus</span>&#123;&#125;</span><br><span class=\"line\">\tif err := r<span class=\"variable\">.Get</span>(ctx, req<span class=\"variable\">.NamespacedName</span>, tcaplus); <span class=\"attribute\">err != nil &#123;</span></span><br><span class=\"line\"><span class=\"attribute\">\t\treturn ctrl.Result&#123;&#125;, client.IgnoreNotFound(err)</span></span><br><span class=\"line\"><span class=\"attribute\">\t&#125;</span></span><br><span class=\"line\"><span class=\"attribute\"></span></span><br><span class=\"line\"><span class=\"attribute\">\tconfigMap</span> := &amp;corev1<span class=\"variable\">.ConfigMap</span>&#123;&#125;</span><br><span class=\"line\">\tconfigMap<span class=\"variable\">.Name</span> = tcaplus<span class=\"variable\">.Spec</span><span class=\"variable\">.ConfigMapTemplate</span><span class=\"variable\">.Name</span></span><br><span class=\"line\">\tconfigMap<span class=\"variable\">.Namespace</span> = tcaplus<span class=\"variable\">.Namespace</span></span><br><span class=\"line\">\tconfigMap<span class=\"variable\">.Data</span> = tcaplus<span class=\"variable\">.Spec</span><span class=\"variable\">.ConfigMapTemplate</span><span class=\"variable\">.Data</span></span><br><span class=\"line\">    </span><br><span class=\"line\">\tif err := controllerutil<span class=\"variable\">.SetControllerReference</span>(tcaplus, configMap, r<span class=\"variable\">.Scheme</span>); <span class=\"attribute\">err != nil &#123;</span></span><br><span class=\"line\"><span class=\"attribute\">\t\tlogger.Error(err, &quot;get configmap failed&quot;, &quot;configmap&quot;, configMap.Name)</span></span><br><span class=\"line\"><span class=\"attribute\">\t\treturn ctrl.Result&#123;&#125;, err</span></span><br><span class=\"line\"><span class=\"attribute\">\t&#125;</span></span><br><span class=\"line\"><span class=\"attribute\"></span></span><br><span class=\"line\"><span class=\"attribute\">\tfoundConfigMap</span> := &amp;corev1<span class=\"variable\">.ConfigMap</span>&#123;&#125;</span><br><span class=\"line\">\terr := r<span class=\"variable\">.Get</span>(ctx, types<span class=\"variable\">.NamespacedName</span>&#123;Name: configMap<span class=\"variable\">.Name</span>, Namespace: tcaplus<span class=\"variable\">.Namespace</span>&#125;, foundConfigMap)</span><br><span class=\"line\">\tif err != nil &amp;&amp; errors<span class=\"variable\">.IsNotFound</span>(err) &#123;</span><br><span class=\"line\">\t\tlogger<span class=\"variable\">.V</span>(1)<span class=\"variable\">.Info</span>(&quot;creating configmap&quot;, &quot;configmap&quot;, configMap<span class=\"variable\">.Name</span>)</span><br><span class=\"line\">\t\terr = r<span class=\"variable\">.Create</span>(ctx, configMap)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn ctrl<span class=\"variable\">.Result</span>&#123;&#125;, nil</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// SetupWithManager sets up the controller with the Manager.</span><br><span class=\"line\">func (r *TcaplusReconciler) SetupWithManager(mgr ctrl<span class=\"variable\">.Manager</span>) error &#123;</span><br><span class=\"line\">\treturn ctrl<span class=\"variable\">.NewControllerManagedBy</span>(mgr).</span><br><span class=\"line\">\t\tFor(&amp;examplev1<span class=\"variable\">.Tcaplus</span>&#123;&#125;).</span><br><span class=\"line\">\t\tOwns(&amp;corev1<span class=\"variable\">.ConfigMap</span>&#123;&#125;).</span><br><span class=\"line\">\t\tComplete(r)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>NOTE：同一控制器创建的资源才可以设置属主关系，不然会提示：already owned by another controller。</p>\n</blockquote>\n<h1 id=\"测试\"><a class=\"markdownIt-Anchor\" href=\"#测试\"></a> 测试</h1>\n<p>config/samples/example_v1_tcaplus.yaml</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">apiVersion:</span> example.blazehu.com/v1</span><br><span class=\"line\"><span class=\"symbol\">kind:</span> Tcaplus</span><br><span class=\"line\"><span class=\"symbol\">metadata:</span></span><br><span class=\"line\"><span class=\"symbol\">  name:</span> tcaplus-sample</span><br><span class=\"line\"><span class=\"symbol\">spec:</span></span><br><span class=\"line\"><span class=\"symbol\">  checksum:</span> <span class=\"string\">&quot;123&quot;</span></span><br><span class=\"line\"><span class=\"symbol\">  configMapTemplate:</span></span><br><span class=\"line\"><span class=\"symbol\">    name:</span> <span class=\"string\">&quot;tcaplus-configmap-example&quot;</span></span><br><span class=\"line\"><span class=\"symbol\">    data:</span></span><br><span class=\"line\">      demo.proto: |</span><br><span class=\"line\">        <span class=\"attr\">syntax</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;proto3&quot;</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">        package <span class=\"attr\">example</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">        message <span class=\"title class_\">Example</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          uint32 a = <span class=\"number\">1</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">          uint32 b = <span class=\"number\">2</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">          uint32 c = <span class=\"number\">3</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p>使用上述配置文件创建 tcaplus 资源。创建结果：</p>\n<figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">marklu-<span class=\"variable constant_\">MB2</span><span class=\"symbol\">:samples</span> <span class=\"variable\">$ </span>k get tcaplus</span><br><span class=\"line\"><span class=\"variable constant_\">NAME</span> <span class=\"variable constant_\">AGE</span></span><br><span class=\"line\">tcaplus-sample 19m</span><br><span class=\"line\">marklu-<span class=\"variable constant_\">MB2</span><span class=\"symbol\">:samples</span> <span class=\"variable\">$ </span>k get configmap</span><br><span class=\"line\"><span class=\"variable constant_\">NAME</span> <span class=\"variable constant_\">DATA</span> <span class=\"variable constant_\">AGE</span></span><br><span class=\"line\">tcaplus-configmap-example <span class=\"number\">1</span> 19m</span><br></pre></td></tr></table></figure>\n<p>可以查看 tcaplus-configmap-example 的属主关系：</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">apiVersion:</span> v1</span><br><span class=\"line\"><span class=\"symbol\">data:</span></span><br><span class=\"line\">  demo.proto: |</span><br><span class=\"line\">    <span class=\"attr\">syntax</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;proto3&quot;</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">    package <span class=\"attr\">example</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">    message <span class=\"title class_\">Example</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      uint32 a = <span class=\"number\">1</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">      uint32 b = <span class=\"number\">2</span><span class=\"punctuation\">;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"symbol\">kind:</span> ConfigMap</span><br><span class=\"line\"><span class=\"symbol\">metadata:</span></span><br><span class=\"line\"><span class=\"symbol\">  creationTimestamp:</span> <span class=\"string\">&quot;2022-07-07T09:02:43Z&quot;</span></span><br><span class=\"line\"><span class=\"symbol\">  name:</span> tcaplus-configmap-example</span><br><span class=\"line\"><span class=\"symbol\">  namespace:</span> default</span><br><span class=\"line\"><span class=\"symbol\">  ownerReferences:</span></span><br><span class=\"line\">  - apiVersion: example.blazehu.com/v1</span><br><span class=\"line\"><span class=\"symbol\">    blockOwnerDeletion:</span> true</span><br><span class=\"line\"><span class=\"symbol\">    controller:</span> true</span><br><span class=\"line\"><span class=\"symbol\">    kind:</span> Tcaplus</span><br><span class=\"line\"><span class=\"symbol\">    name:</span> tcaplus-sample</span><br><span class=\"line\"><span class=\"symbol\">    uid:</span> <span class=\"number\">7</span>c50f2e1<span class=\"number\">-0e37</span><span class=\"number\">-4</span>aa0-bf49-c2d410d6153e</span><br><span class=\"line\"><span class=\"symbol\">  resourceVersion:</span> <span class=\"string\">&quot;6837330713&quot;</span></span><br><span class=\"line\"><span class=\"symbol\">  selfLink:</span> <span class=\"keyword\">/api/</span>v1<span class=\"keyword\">/namespaces/</span>default<span class=\"keyword\">/configmaps/</span>tcaplus-configmap-example</span><br><span class=\"line\"><span class=\"symbol\">  uid:</span> <span class=\"number\">6</span>c29f90b<span class=\"number\">-0e51</span><span class=\"number\">-4</span>d9f-a6a8-cfb6906ed1b0</span><br></pre></td></tr></table></figure>\n<p>手动修改 tcaplus-sample 和 tcaplus-configmap-example 后查看控制器日志发现能正常观察 CR 和 ConfigMap 的变化了。</p>\n<h1 id=\"外部管理的资源\"><a class=\"markdownIt-Anchor\" href=\"#外部管理的资源\"></a> 外部管理的资源</h1>\n<p>资源定义 (Defined Tcaplus Resources)<br />\napi/v1/tcaplus_types.go</p>\n<figure class=\"highlight elm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"type\">TcaplusSpec</span> struct &#123;</span><br><span class=\"line\">\t<span class=\"type\">Checksum</span>     string             `json:&quot;checksum,omitempty&quot;`</span><br><span class=\"line\">\t<span class=\"type\">ConfigMapRef</span> <span class=\"type\">ConfigMapReference</span> `json:&quot;configMapRef,omitempty&quot;`</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"type\">ConfigMapReference</span> struct &#123;</span><br><span class=\"line\">\t<span class=\"type\">Name</span> string `json:&quot;name,omitempty&quot;`</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"控制器逻辑-manage-the-owned-resource-2\"><a class=\"markdownIt-Anchor\" href=\"#控制器逻辑-manage-the-owned-resource-2\"></a> 控制器逻辑 (Manage the Owned Resource)</h1>\n<h5 id=\"controllerstcaplus_controllergo-2\"><a class=\"markdownIt-Anchor\" href=\"#controllerstcaplus_controllergo-2\"></a> controllers/tcaplus_controller.go</h5>\n<p>For 方法之后调用 Watches 方法就可以监听对应资源的事件，但是会监听集群里所有相关资源的事件，所以这里我们自定义事件处理方法来过滤出我们关注的资源的事件。</p>\n<p>•通过 EnqueueRequestsFromMapFunc 创建一个事件处理方法，该方法通过 FieldSelector 在 ConfigMap 的事件中过滤出跟 tcaplus CR 相关联的事件。<br />\n•使用 FieldSelector 时我们需要建立对应的索引，使用 mgr.GetFieldIndexer().IndexField() 创建。</p>\n<figure class=\"highlight roboconf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const (</span><br><span class=\"line\">    ConfigMapField = &quot;.spec.configMapRef.name&quot;</span><br><span class=\"line\">) </span><br><span class=\"line\">func (r *TcaplusReconciler) findObjectsForConfigMap(configMap client.Object) []reconcile.Request &#123;</span><br><span class=\"line\">    <span class=\"attribute\">attachedTcaplusList</span> := &amp;examplev1<span class=\"variable\">.TcaplusList</span>&#123;&#125;</span><br><span class=\"line\">    listOps := &amp;client<span class=\"variable\">.ListOptions</span>&#123;</span><br><span class=\"line\">        FieldSelector: fields<span class=\"variable\">.OneTermEqualSelector</span>(ConfigMapField, configMap<span class=\"variable\">.GetName</span>()),</span><br><span class=\"line\">        Namespace: configMap<span class=\"variable\">.GetNamespace</span>(),</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    err := r<span class=\"variable\">.List</span>(context<span class=\"variable\">.TODO</span>(), attachedTcaplusList, listOps)</span><br><span class=\"line\">    if err != nil &#123;</span><br><span class=\"line\">        return []reconcile<span class=\"variable\">.Request</span>&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    requests := make([]reconcile<span class=\"variable\">.Request</span>, len(attachedTcaplusList<span class=\"variable\">.Items</span>))</span><br><span class=\"line\">    for i, item := range attachedTcaplusList<span class=\"variable\">.Items</span> &#123;</span><br><span class=\"line\">        requests[i] = reconcile<span class=\"variable\">.Request</span>&#123;</span><br><span class=\"line\">            NamespacedName: types<span class=\"variable\">.NamespacedName</span>&#123;</span><br><span class=\"line\">                Name: item<span class=\"variable\">.GetName</span>(),</span><br><span class=\"line\">                Namespace: item<span class=\"variable\">.GetNamespace</span>(),</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return requests</span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\">// SetupWithManager sets up the controller with the Manager.</span><br><span class=\"line\">func (r *TcaplusReconciler) SetupWithManager(mgr ctrl<span class=\"variable\">.Manager</span>) error &#123;</span><br><span class=\"line\">\tif err := mgr<span class=\"variable\">.GetFieldIndexer</span>()<span class=\"variable\">.IndexField</span>(context<span class=\"variable\">.Background</span>(), &amp;examplev1<span class=\"variable\">.Tcaplus</span>&#123;&#125;, ConfigMapField, func(rawObj client<span class=\"variable\">.Object</span>) []string &#123;</span><br><span class=\"line\">\t\ttcaplus := rawObj.(*examplev1<span class=\"variable\">.Tcaplus</span>)</span><br><span class=\"line\">\t\tif tcaplus<span class=\"variable\">.Spec</span><span class=\"variable\">.ConfigMapRef</span><span class=\"variable\">.Name</span> == &quot;&quot; &#123;</span><br><span class=\"line\">\t\t\treturn nil</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\treturn []string&#123;tcaplus<span class=\"variable\">.Spec</span><span class=\"variable\">.ConfigMapRef</span><span class=\"variable\">.Name</span>&#125;</span><br><span class=\"line\">\t&#125;); <span class=\"attribute\">err != nil &#123;</span></span><br><span class=\"line\"><span class=\"attribute\">\t\treturn err</span></span><br><span class=\"line\"><span class=\"attribute\">\t&#125;</span></span><br><span class=\"line\"><span class=\"attribute\"></span></span><br><span class=\"line\"><span class=\"attribute\">\treturn ctrl.NewControllerManagedBy(mgr).</span></span><br><span class=\"line\"><span class=\"attribute\">\t\tFor(&amp;examplev1.Tcaplus&#123;&#125;).</span></span><br><span class=\"line\"><span class=\"attribute\">\t\tWatches(</span></span><br><span class=\"line\"><span class=\"attribute\">\t\t\t&amp;source.Kind&#123;Type</span>: &amp;corev1<span class=\"variable\">.ConfigMap</span>&#123;&#125;&#125;,</span><br><span class=\"line\">\t\t\thandler<span class=\"variable\">.EnqueueRequestsFromMapFunc</span>(r<span class=\"variable\">.findObjectsForConfigMap</span>),</span><br><span class=\"line\">\t\t\tbuilder<span class=\"variable\">.WithPredicates</span>(predicate<span class=\"variable\">.ResourceVersionChangedPredicate</span>&#123;&#125;),</span><br><span class=\"line\">\t\t).</span><br><span class=\"line\">\t\tComplete(r)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>NOTE: 我们也可以自己定一个变更过滤器 Predicate。也可以通过 WithEventFilter 来针对监听的所有资源过滤。</p>\n</blockquote>\n<h1 id=\"测试-2\"><a class=\"markdownIt-Anchor\" href=\"#测试-2\"></a> 测试</h1>\n<p>config/samples/example_v1_tcaplus.yaml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">tcaplus-configmap-example</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">demo.proto:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    syntax = &quot;proto3&quot;;</span></span><br><span class=\"line\"><span class=\"string\">    package example;</span></span><br><span class=\"line\"><span class=\"string\">    message Example &#123;</span></span><br><span class=\"line\"><span class=\"string\">      uint32 a = 1;</span></span><br><span class=\"line\"><span class=\"string\">      uint32 b = 2;</span></span><br><span class=\"line\"><span class=\"string\">      uint32 c = 3;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">example.blazehu.com/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Tcaplus</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">tcaplus-sample</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">checksum:</span> <span class=\"string\">&quot;123&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">configMapRef:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">&quot;tcaplus-configmap-example&quot;</span></span><br></pre></td></tr></table></figure>\n<p>使用上述配置创建完毕后，手动修改 tcaplus-sample 和 tcaplus-configmap-example 查看控制器日志发现同样能正常观察 CR 和 ConfigMap 的变化。</p>\n<blockquote>\n<p>NOTE: 查看 tcaplus-configmap-example 可以看到没有和 tcaplus 的属主关系。</p>\n</blockquote>\n<h1 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\"></a> 总结</h1>\n<p>•EventHandler 可以在 watch 特定资源时设置该资源的事件监听规则。<br />\n•WithEventFilter 配置变更过滤器，可以针对 watch 的所有资源，统一地设置事件监听规则。<br />\n•Owns 源码分析可以发现 Owns 相当于调用 Watches(&amp;source.Kind{Type: <ForType-forInput>}, &amp;handler.EnqueueRequestForOwner{OwnerType: apiType, IsController: true})。</p>\n<h1 id=\"参考文档\"><a class=\"markdownIt-Anchor\" href=\"#参考文档\"></a> 参考文档</h1>\n<p>•<a href=\"https://www.kubebuilder.io/reference/watching-resources.html\">https://www.kubebuilder.io/reference/watching-resources.html</a><br />\n•<a href=\"https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/owners-dependents/\">https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/owners-dependents/</a><br />\n•<a href=\"https://segmentfault.com/a/1190000020359577\">https://segmentfault.com/a/1190000020359577</a></p>\n"},{"title":"Kubebuilder Admission Webhooks","sidebar":"none","_content":"# 什么是准入控制?\n准入控制（Admission Controller）是 Kubernetes API Server 用于拦截请求的一种手段。Admission 可以做到对请求的资源对象进行校验，修改。service mesh 最近很火的项目 Istio 天生支持 Kubernetes，利用的就是 Admission 对服务实例自动注入 sidecar。\n\n# 什么是准入 Webhook？\n准入 Webhook 是一种用于接收准入请求并对其进行处理的 HTTP 回调机制。 可以定义两种类型的准入 webhook，即 验证性质的准入 Webhook 和 修改性质的准入 Webhook。修改性质的准入 Webhook 会先被调用。它们可以更改发送到 API 服务器的对象以执行自定义的设置默认值操作。\n\n在完成了所有对象修改并且 API 服务器也验证了所传入的对象之后， 验证性质的 Webhook 会被调用，并通过拒绝请求的方式来强制实施自定义的策略。\n\n> 说明： 如果准入 Webhook 需要保证它们所看到的是对象的最终状态以实施某种策略。 则应使用验证性质的准入 Webhook，因为对象被修改性质 Webhook 看到之后仍然可能被修改。\n![图片](/images/webhook1.jpeg)\n\n# 尝试准入 Webhook\n先决条件\n•确保 Kubernetes 集群版本至少为 v1.16（以便使用 admissionregistration.k8s.io/v1 API） 或者 v1.9 （以便使 admissionregistration.k8s.io/v1beta1 API）。\n•确保启用 MutatingAdmissionWebhook 和 ValidatingAdmissionWebhook 控制器。 这里是一组推荐的 admission 控制器，通常可以启用。\n•确保启用了 admissionregistration.k8s.io/v1beta1 API。\n\n# 配置准入 Webhook\n你可以通过 ValidatingWebhookConfiguration 或者 MutatingWebhookConfiguration 动态配置哪些资源要被哪些准入 Webhook 处理。详细配置可以参阅 Webhook配置 部分。\n\n# 认证和信任\n默认情况下，apiserver不会向webhooks进行身份验证。但是，如果您想对客户端进行身份验证，可以将apiserver配置为使用基本身份验证、承载令牌或证书对Webhook进行身份验证。你可以在这里找到详细的步骤。\n\n# 编写一个准入 Webhook 服务器\nWebhook Admission 属于同步调用，需要用户部署自己的 webhook server，创建自定义的配置资源对象： ValidatingWebhookConfiguration 或 MutatingWebhookConfiguration。下面使用 kubebuilder 开发一个简单的 demo。\n\n6.1 创建项目\n```\nkubebuilder init --domain marklu.com --owner \"marklu\" --repo marklu.com/kubegame\n```\n\n提示： 这里通过 kubebuilder v3 创建的话，在 config 目录下会缺少 certmanager、webhook 目录以及 default/manager_webhook_patch.yml 和 webhookcainjection_patch.yaml 文件。可以通过从v2生成拷贝过来进行修改。\n\n6.2 创建控制器\n这里只需要创建一个控制器\n```\nkubebuilder create api --group svc --version v1 --kind App\n```\n6.3 创建 webhook\nImplement Your Handler\n新增 mutatingwebhook.go & validatingwebhook.go 文件\n```\n// mutatingwebhook.go\npackage controllers\n\nimport (\n\t\"context\"\n\t\"encoding/json\"\n\tcorev1 \"k8s.io/api/core/v1\"\n\t\"net/http\"\n\t\"sigs.k8s.io/controller-runtime/pkg/client\"\n\t\"sigs.k8s.io/controller-runtime/pkg/webhook/admission\"\n)\n\n// +kubebuilder:webhook:admissionReviewVersions=v1,sideEffects=None,path=/mutate-v1-svc,mutating=true,failurePolicy=fail,groups=\"\",resources=services,verbs=create;update,versions=v1,name=msvc.kb.io\n\n// KubeGameAnnotator annotates Pods\ntype KubeGameAnnotator struct {\n\tClient  client.Client\n\tdecoder *admission.Decoder\n}\n\n// Handle adds an annotation to every incoming pods.\nfunc (a *KubeGameAnnotator) Handle(ctx context.Context, req admission.Request) admission.Response {\n\tpod := &corev1.Pod{}\n\n\terr := a.decoder.Decode(req, pod)\n\tif err != nil {\n\t\treturn admission.Errored(http.StatusBadRequest, err)\n\t}\n\n\tif pod.Annotations == nil {\n\t\tpod.Annotations = map[string]string{}\n\t}\n\tpod.Annotations[\"example-mutating-admission-webhook\"] = \"foo\"\n\n\tmarshaledPod, err := json.Marshal(pod)\n\tif err != nil {\n\t\treturn admission.Errored(http.StatusInternalServerError, err)\n\t}\n\n\treturn admission.PatchResponseFromRaw(req.Object.Raw, marshaledPod)\n}\n\n// KubeGameAnnotator implements admission.DecoderInjector.\n// A decoder will be automatically injected.\n\n// InjectDecoder injects the decoder.\nfunc (a *KubeGameAnnotator) InjectDecoder(d *admission.Decoder) error {\n\ta.decoder = d\n\treturn nil\n}\n```\n```\n// validatingwebhook.go\npackage controllers\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\tcorev1 \"k8s.io/api/core/v1\"\n\t\"net/http\"\n\t\"sigs.k8s.io/controller-runtime/pkg/client\"\n\t\"sigs.k8s.io/controller-runtime/pkg/webhook/admission\"\n)\n\n// +kubebuilder:webhook:admissionReviewVersions=v1,sideEffects=None,path=/validate-v1-svc,mutating=false,failurePolicy=fail,groups=\"\",resources=services,verbs=create;update,versions=v1,name=vsvc.kb.io\n\n// KubeGameValidator validates Pods\ntype KubeGameValidator struct {\n\tClient  client.Client\n\tdecoder *admission.Decoder\n}\n\n// Handle admits a pod if a specific annotation exists.\nfunc (v *KubeGameValidator) Handle(ctx context.Context, req admission.Request) admission.Response {\n\tpod := &corev1.Pod{}\n\n\terr := v.decoder.Decode(req, pod)\n\tif err != nil {\n\t\treturn admission.Errored(http.StatusBadRequest, err)\n\t}\n\n\tkey := \"example-mutating-admission-webhook\"\n\tanno, found := pod.Annotations[key]\n\tif !found {\n\t\treturn admission.Denied(fmt.Sprintf(\"missing annotation %s\", key))\n\t}\n\tif anno != \"foo\" {\n\t\treturn admission.Denied(fmt.Sprintf(\"annotation %s did not have value %q\", key, \"foo\"))\n\t}\n\n\treturn admission.Allowed(\"\")\n}\n\n// KubeGameValidator implements admission.DecoderInjector.\n// A decoder will be automatically injected.\n\n// InjectDecoder injects the decoder.\nfunc (v *KubeGameValidator) InjectDecoder(d *admission.Decoder) error {\n\tv.decoder = d\n\treturn nil\n}\n```\n> 注意：因为上述逻辑需要services权限，所以我们在控制器里需要添加如下内容 //+kubebuilder:rbac:groups=\"\",resources=services,verbs=get;list;watch;create;update;patch;delete 用于生成 rbac manifests。\n\n> Register Your Handler\n修改 main.go ，注册我们的 webhook handler\n```\nsetupLog.Info(\"setting up webhook server\")\nhookServer := mgr.GetWebhookServer()\n\nsetupLog.Info(\"registering webhooks to the webhook server\")\nhookServer.Register(\"/mutate-v1-svc\", &webhook.Admission{Handler: &controllers.KubeGameAnnotator{Client: mgr.GetClient()}})\nhookServer.Register(\"/validate-v1-svc\", &webhook.Admission{Handler: &controllers.KubeGameValidator{Client: mgr.GetClient()}})\n```\n> 提示： 这里注册的path（例如 validate-v1-sv）路径需要和 validatingwebhook.go 、mutatingwebhook.go 文件里的 CRD validation 匹配，不然 kustomize 生成出来的 webhook yaml 文件不对。\n\n# 本地测试\nmake run 会报如下错误，是因为没有证书导致，需要配置证书，可以手动签发证书。\n```\n1.646924212701068e+09 ERROR setup problem running manager {\"error\": \"open /var/folders/67/375276sx6hv0nln1whwm5syh0000gq/T/k8s-webhook-server/serving-certs/tls.crt: no such file or directory\"}\n```\n\n我本地指定证书目录：\n```\nmgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{\n\t\tScheme:                 scheme,\n\t\tMetricsBindAddress:     metricsAddr,\n\t\tPort:                   9443,\n\t\tHealthProbeBindAddress: probeAddr,\n\t\tLeaderElection:         enableLeaderElection,\n\t\tLeaderElectionID:       \"27e1b0af.blazehu.com\",\n\t\tCertDir:                \"./cert/\",\n\t})\n```\n重新启动发现恢复正常\n\n> 提示： run controller-gen rbac:roleName=manager-role crd webhook paths=./... output:crd:artifacts:config=config/crd/bases -w to see all available markers, or controller-gen rbac:roleName=manager-role crd webhook paths=./... output:crd:artifacts:config=config/crd/bases -h for usage\n\n# 7. 部署至集群\n7.1 部署 cert manager\n建议使用 certmanager 为 webhook 服务器提供证书。其他解决方案也有效，只要它们将证书放在所需的位置。安装文档点这里\n通过如下方式注入 caBundle :\n```\n# This patch add annotation to admission webhook config and\n# the variables $(CERTIFICATE_NAMESPACE) and $(CERTIFICATE_NAME) will be substituted by kustomize.\napiVersion: admissionregistration.k8s.io/v1\nkind: MutatingWebhookConfiguration\nmetadata:\n  name: mutating-webhook-configuration\n  annotations:\n    cert-manager.io/inject-ca-from: $(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)\n---\napiVersion: admissionregistration.k8s.io/v1\nkind: ValidatingWebhookConfiguration\nmetadata:\n  name: validating-webhook-configuration\n  annotations:\n    cert-manager.io/inject-ca-from: $(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)\n```\n# 7.2 构建镜像\n•镜像替换：default/manager_auth_proxy_patch.yaml 文件中的 gcr.io/kubebuilder/kube-rbac-proxy:v0.8.0 （网络慢）\n•Dockerfile 去掉 go mod download，直接使用本地 vendor 构建 （网络慢）\n•Dockerfile 去掉 COPY api/ api/， 因为没有创建 Resource\n•去掉 main.go 文件中配置的证书路径\n```\nmake docker-build IMG=xxxx\nmake docker-push IMG=xxxx\n```\n# 7.3 修改模版，然后部署\n•修改 config/default/kustomization.yaml ， 将 webhook、certmanager 相关的注释去掉。\n•修改 config/crd/kustomization.yaml ，将 webhook、certmanager 相关的注释去掉。\n•修改 config/default/kustomization.yaml ， 将 crd 相关的给注释掉。\n```\nmake deploy IMG=xxxx\n```\n部署成功：\n\n查看控制器日志：\n\n# 7.4 测试\n简单创建一个 service，webhook 会注入一个注解，并进行验证。下图可以看到成功注入。\n\n\n控制日志：\n\n说明：查看 MutatingWebhookConfiguration 配置可以看到 caBundle 被注入其中了。\n\n# 8. 总结\n总结下 webhook Admission 的优势：\n\n•webhook 可动态扩展 Admission 能力，满足自定义客户的需求。\n•不需要重启 API Server，可通过创建 webhook configuration 热加载 webhook admission。\n\nReference documentation\n•https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers\n•https://kubernetes.io/zh/docs/tasks/tls/managing-tls-in-a-cluster/\n•https://book.kubebuilder.io/reference/admission-webhook.html\n•https://github.com/kubernetes-sigs/controller-runtime/tree/master/examples/builtins","source":"_posts/kubebuilder-Admission-Webhooks.md","raw":"---\ntitle: Kubebuilder Admission Webhooks\ncategories: \n  - Kubebuilder\ntags:\n  - k8s\nsidebar: none \n---\n# 什么是准入控制?\n准入控制（Admission Controller）是 Kubernetes API Server 用于拦截请求的一种手段。Admission 可以做到对请求的资源对象进行校验，修改。service mesh 最近很火的项目 Istio 天生支持 Kubernetes，利用的就是 Admission 对服务实例自动注入 sidecar。\n\n# 什么是准入 Webhook？\n准入 Webhook 是一种用于接收准入请求并对其进行处理的 HTTP 回调机制。 可以定义两种类型的准入 webhook，即 验证性质的准入 Webhook 和 修改性质的准入 Webhook。修改性质的准入 Webhook 会先被调用。它们可以更改发送到 API 服务器的对象以执行自定义的设置默认值操作。\n\n在完成了所有对象修改并且 API 服务器也验证了所传入的对象之后， 验证性质的 Webhook 会被调用，并通过拒绝请求的方式来强制实施自定义的策略。\n\n> 说明： 如果准入 Webhook 需要保证它们所看到的是对象的最终状态以实施某种策略。 则应使用验证性质的准入 Webhook，因为对象被修改性质 Webhook 看到之后仍然可能被修改。\n![图片](/images/webhook1.jpeg)\n\n# 尝试准入 Webhook\n先决条件\n•确保 Kubernetes 集群版本至少为 v1.16（以便使用 admissionregistration.k8s.io/v1 API） 或者 v1.9 （以便使 admissionregistration.k8s.io/v1beta1 API）。\n•确保启用 MutatingAdmissionWebhook 和 ValidatingAdmissionWebhook 控制器。 这里是一组推荐的 admission 控制器，通常可以启用。\n•确保启用了 admissionregistration.k8s.io/v1beta1 API。\n\n# 配置准入 Webhook\n你可以通过 ValidatingWebhookConfiguration 或者 MutatingWebhookConfiguration 动态配置哪些资源要被哪些准入 Webhook 处理。详细配置可以参阅 Webhook配置 部分。\n\n# 认证和信任\n默认情况下，apiserver不会向webhooks进行身份验证。但是，如果您想对客户端进行身份验证，可以将apiserver配置为使用基本身份验证、承载令牌或证书对Webhook进行身份验证。你可以在这里找到详细的步骤。\n\n# 编写一个准入 Webhook 服务器\nWebhook Admission 属于同步调用，需要用户部署自己的 webhook server，创建自定义的配置资源对象： ValidatingWebhookConfiguration 或 MutatingWebhookConfiguration。下面使用 kubebuilder 开发一个简单的 demo。\n\n6.1 创建项目\n```\nkubebuilder init --domain marklu.com --owner \"marklu\" --repo marklu.com/kubegame\n```\n\n提示： 这里通过 kubebuilder v3 创建的话，在 config 目录下会缺少 certmanager、webhook 目录以及 default/manager_webhook_patch.yml 和 webhookcainjection_patch.yaml 文件。可以通过从v2生成拷贝过来进行修改。\n\n6.2 创建控制器\n这里只需要创建一个控制器\n```\nkubebuilder create api --group svc --version v1 --kind App\n```\n6.3 创建 webhook\nImplement Your Handler\n新增 mutatingwebhook.go & validatingwebhook.go 文件\n```\n// mutatingwebhook.go\npackage controllers\n\nimport (\n\t\"context\"\n\t\"encoding/json\"\n\tcorev1 \"k8s.io/api/core/v1\"\n\t\"net/http\"\n\t\"sigs.k8s.io/controller-runtime/pkg/client\"\n\t\"sigs.k8s.io/controller-runtime/pkg/webhook/admission\"\n)\n\n// +kubebuilder:webhook:admissionReviewVersions=v1,sideEffects=None,path=/mutate-v1-svc,mutating=true,failurePolicy=fail,groups=\"\",resources=services,verbs=create;update,versions=v1,name=msvc.kb.io\n\n// KubeGameAnnotator annotates Pods\ntype KubeGameAnnotator struct {\n\tClient  client.Client\n\tdecoder *admission.Decoder\n}\n\n// Handle adds an annotation to every incoming pods.\nfunc (a *KubeGameAnnotator) Handle(ctx context.Context, req admission.Request) admission.Response {\n\tpod := &corev1.Pod{}\n\n\terr := a.decoder.Decode(req, pod)\n\tif err != nil {\n\t\treturn admission.Errored(http.StatusBadRequest, err)\n\t}\n\n\tif pod.Annotations == nil {\n\t\tpod.Annotations = map[string]string{}\n\t}\n\tpod.Annotations[\"example-mutating-admission-webhook\"] = \"foo\"\n\n\tmarshaledPod, err := json.Marshal(pod)\n\tif err != nil {\n\t\treturn admission.Errored(http.StatusInternalServerError, err)\n\t}\n\n\treturn admission.PatchResponseFromRaw(req.Object.Raw, marshaledPod)\n}\n\n// KubeGameAnnotator implements admission.DecoderInjector.\n// A decoder will be automatically injected.\n\n// InjectDecoder injects the decoder.\nfunc (a *KubeGameAnnotator) InjectDecoder(d *admission.Decoder) error {\n\ta.decoder = d\n\treturn nil\n}\n```\n```\n// validatingwebhook.go\npackage controllers\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\tcorev1 \"k8s.io/api/core/v1\"\n\t\"net/http\"\n\t\"sigs.k8s.io/controller-runtime/pkg/client\"\n\t\"sigs.k8s.io/controller-runtime/pkg/webhook/admission\"\n)\n\n// +kubebuilder:webhook:admissionReviewVersions=v1,sideEffects=None,path=/validate-v1-svc,mutating=false,failurePolicy=fail,groups=\"\",resources=services,verbs=create;update,versions=v1,name=vsvc.kb.io\n\n// KubeGameValidator validates Pods\ntype KubeGameValidator struct {\n\tClient  client.Client\n\tdecoder *admission.Decoder\n}\n\n// Handle admits a pod if a specific annotation exists.\nfunc (v *KubeGameValidator) Handle(ctx context.Context, req admission.Request) admission.Response {\n\tpod := &corev1.Pod{}\n\n\terr := v.decoder.Decode(req, pod)\n\tif err != nil {\n\t\treturn admission.Errored(http.StatusBadRequest, err)\n\t}\n\n\tkey := \"example-mutating-admission-webhook\"\n\tanno, found := pod.Annotations[key]\n\tif !found {\n\t\treturn admission.Denied(fmt.Sprintf(\"missing annotation %s\", key))\n\t}\n\tif anno != \"foo\" {\n\t\treturn admission.Denied(fmt.Sprintf(\"annotation %s did not have value %q\", key, \"foo\"))\n\t}\n\n\treturn admission.Allowed(\"\")\n}\n\n// KubeGameValidator implements admission.DecoderInjector.\n// A decoder will be automatically injected.\n\n// InjectDecoder injects the decoder.\nfunc (v *KubeGameValidator) InjectDecoder(d *admission.Decoder) error {\n\tv.decoder = d\n\treturn nil\n}\n```\n> 注意：因为上述逻辑需要services权限，所以我们在控制器里需要添加如下内容 //+kubebuilder:rbac:groups=\"\",resources=services,verbs=get;list;watch;create;update;patch;delete 用于生成 rbac manifests。\n\n> Register Your Handler\n修改 main.go ，注册我们的 webhook handler\n```\nsetupLog.Info(\"setting up webhook server\")\nhookServer := mgr.GetWebhookServer()\n\nsetupLog.Info(\"registering webhooks to the webhook server\")\nhookServer.Register(\"/mutate-v1-svc\", &webhook.Admission{Handler: &controllers.KubeGameAnnotator{Client: mgr.GetClient()}})\nhookServer.Register(\"/validate-v1-svc\", &webhook.Admission{Handler: &controllers.KubeGameValidator{Client: mgr.GetClient()}})\n```\n> 提示： 这里注册的path（例如 validate-v1-sv）路径需要和 validatingwebhook.go 、mutatingwebhook.go 文件里的 CRD validation 匹配，不然 kustomize 生成出来的 webhook yaml 文件不对。\n\n# 本地测试\nmake run 会报如下错误，是因为没有证书导致，需要配置证书，可以手动签发证书。\n```\n1.646924212701068e+09 ERROR setup problem running manager {\"error\": \"open /var/folders/67/375276sx6hv0nln1whwm5syh0000gq/T/k8s-webhook-server/serving-certs/tls.crt: no such file or directory\"}\n```\n\n我本地指定证书目录：\n```\nmgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{\n\t\tScheme:                 scheme,\n\t\tMetricsBindAddress:     metricsAddr,\n\t\tPort:                   9443,\n\t\tHealthProbeBindAddress: probeAddr,\n\t\tLeaderElection:         enableLeaderElection,\n\t\tLeaderElectionID:       \"27e1b0af.blazehu.com\",\n\t\tCertDir:                \"./cert/\",\n\t})\n```\n重新启动发现恢复正常\n\n> 提示： run controller-gen rbac:roleName=manager-role crd webhook paths=./... output:crd:artifacts:config=config/crd/bases -w to see all available markers, or controller-gen rbac:roleName=manager-role crd webhook paths=./... output:crd:artifacts:config=config/crd/bases -h for usage\n\n# 7. 部署至集群\n7.1 部署 cert manager\n建议使用 certmanager 为 webhook 服务器提供证书。其他解决方案也有效，只要它们将证书放在所需的位置。安装文档点这里\n通过如下方式注入 caBundle :\n```\n# This patch add annotation to admission webhook config and\n# the variables $(CERTIFICATE_NAMESPACE) and $(CERTIFICATE_NAME) will be substituted by kustomize.\napiVersion: admissionregistration.k8s.io/v1\nkind: MutatingWebhookConfiguration\nmetadata:\n  name: mutating-webhook-configuration\n  annotations:\n    cert-manager.io/inject-ca-from: $(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)\n---\napiVersion: admissionregistration.k8s.io/v1\nkind: ValidatingWebhookConfiguration\nmetadata:\n  name: validating-webhook-configuration\n  annotations:\n    cert-manager.io/inject-ca-from: $(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)\n```\n# 7.2 构建镜像\n•镜像替换：default/manager_auth_proxy_patch.yaml 文件中的 gcr.io/kubebuilder/kube-rbac-proxy:v0.8.0 （网络慢）\n•Dockerfile 去掉 go mod download，直接使用本地 vendor 构建 （网络慢）\n•Dockerfile 去掉 COPY api/ api/， 因为没有创建 Resource\n•去掉 main.go 文件中配置的证书路径\n```\nmake docker-build IMG=xxxx\nmake docker-push IMG=xxxx\n```\n# 7.3 修改模版，然后部署\n•修改 config/default/kustomization.yaml ， 将 webhook、certmanager 相关的注释去掉。\n•修改 config/crd/kustomization.yaml ，将 webhook、certmanager 相关的注释去掉。\n•修改 config/default/kustomization.yaml ， 将 crd 相关的给注释掉。\n```\nmake deploy IMG=xxxx\n```\n部署成功：\n\n查看控制器日志：\n\n# 7.4 测试\n简单创建一个 service，webhook 会注入一个注解，并进行验证。下图可以看到成功注入。\n\n\n控制日志：\n\n说明：查看 MutatingWebhookConfiguration 配置可以看到 caBundle 被注入其中了。\n\n# 8. 总结\n总结下 webhook Admission 的优势：\n\n•webhook 可动态扩展 Admission 能力，满足自定义客户的需求。\n•不需要重启 API Server，可通过创建 webhook configuration 热加载 webhook admission。\n\nReference documentation\n•https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers\n•https://kubernetes.io/zh/docs/tasks/tls/managing-tls-in-a-cluster/\n•https://book.kubebuilder.io/reference/admission-webhook.html\n•https://github.com/kubernetes-sigs/controller-runtime/tree/master/examples/builtins","slug":"kubebuilder-Admission-Webhooks","published":1,"date":"2023-05-23T03:53:22.095Z","updated":"2023-05-25T16:05:29.816Z","_id":"clhzqrgue0009w8f8cbd71yy6","comments":1,"layout":"post","photos":[],"link":"","content":"<h1 id=\"什么是准入控制\"><a class=\"markdownIt-Anchor\" href=\"#什么是准入控制\"></a> 什么是准入控制?</h1>\n<p>准入控制（Admission Controller）是 Kubernetes API Server 用于拦截请求的一种手段。Admission 可以做到对请求的资源对象进行校验，修改。service mesh 最近很火的项目 Istio 天生支持 Kubernetes，利用的就是 Admission 对服务实例自动注入 sidecar。</p>\n<h1 id=\"什么是准入-webhook\"><a class=\"markdownIt-Anchor\" href=\"#什么是准入-webhook\"></a> 什么是准入 Webhook？</h1>\n<p>准入 Webhook 是一种用于接收准入请求并对其进行处理的 HTTP 回调机制。 可以定义两种类型的准入 webhook，即 验证性质的准入 Webhook 和 修改性质的准入 Webhook。修改性质的准入 Webhook 会先被调用。它们可以更改发送到 API 服务器的对象以执行自定义的设置默认值操作。</p>\n<p>在完成了所有对象修改并且 API 服务器也验证了所传入的对象之后， 验证性质的 Webhook 会被调用，并通过拒绝请求的方式来强制实施自定义的策略。</p>\n<blockquote>\n<p>说明： 如果准入 Webhook 需要保证它们所看到的是对象的最终状态以实施某种策略。 则应使用验证性质的准入 Webhook，因为对象被修改性质 Webhook 看到之后仍然可能被修改。<br />\n<img src=\"/images/webhook1.jpeg\" alt=\"图片\" /></p>\n</blockquote>\n<h1 id=\"尝试准入-webhook\"><a class=\"markdownIt-Anchor\" href=\"#尝试准入-webhook\"></a> 尝试准入 Webhook</h1>\n<p>先决条件<br />\n•确保 Kubernetes 集群版本至少为 v1.16（以便使用 <a href=\"http://admissionregistration.k8s.io/v1\">admissionregistration.k8s.io/v1</a> API） 或者 v1.9 （以便使 <a href=\"http://admissionregistration.k8s.io/v1beta1\">admissionregistration.k8s.io/v1beta1</a> API）。<br />\n•确保启用 MutatingAdmissionWebhook 和 ValidatingAdmissionWebhook 控制器。 这里是一组推荐的 admission 控制器，通常可以启用。<br />\n•确保启用了 <a href=\"http://admissionregistration.k8s.io/v1beta1\">admissionregistration.k8s.io/v1beta1</a> API。</p>\n<h1 id=\"配置准入-webhook\"><a class=\"markdownIt-Anchor\" href=\"#配置准入-webhook\"></a> 配置准入 Webhook</h1>\n<p>你可以通过 ValidatingWebhookConfiguration 或者 MutatingWebhookConfiguration 动态配置哪些资源要被哪些准入 Webhook 处理。详细配置可以参阅 Webhook配置 部分。</p>\n<h1 id=\"认证和信任\"><a class=\"markdownIt-Anchor\" href=\"#认证和信任\"></a> 认证和信任</h1>\n<p>默认情况下，apiserver不会向webhooks进行身份验证。但是，如果您想对客户端进行身份验证，可以将apiserver配置为使用基本身份验证、承载令牌或证书对Webhook进行身份验证。你可以在这里找到详细的步骤。</p>\n<h1 id=\"编写一个准入-webhook-服务器\"><a class=\"markdownIt-Anchor\" href=\"#编写一个准入-webhook-服务器\"></a> 编写一个准入 Webhook 服务器</h1>\n<p>Webhook Admission 属于同步调用，需要用户部署自己的 webhook server，创建自定义的配置资源对象： ValidatingWebhookConfiguration 或 MutatingWebhookConfiguration。下面使用 kubebuilder 开发一个简单的 demo。</p>\n<p>6.1 创建项目</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubebuilder init <span class=\"attr\">--domain</span> marklu<span class=\"selector-class\">.com</span> <span class=\"attr\">--owner</span> <span class=\"string\">&quot;marklu&quot;</span> <span class=\"attr\">--repo</span> marklu.com/kubegame</span><br></pre></td></tr></table></figure>\n<p>提示： 这里通过 kubebuilder v3 创建的话，在 config 目录下会缺少 certmanager、webhook 目录以及 default/manager_webhook_patch.yml 和 webhookcainjection_patch.yaml 文件。可以通过从v2生成拷贝过来进行修改。</p>\n<p>6.2 创建控制器<br />\n这里只需要创建一个控制器</p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubebuilder create api --<span class=\"keyword\">group</span> <span class=\"title\">svc</span> --<span class=\"keyword\">version</span> v1 --kind App</span><br></pre></td></tr></table></figure>\n<p>6.3 创建 webhook<br />\nImplement Your Handler<br />\n新增 mutatingwebhook.go &amp; validatingwebhook.go 文件</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// mutatingwebhook.go</span></span><br><span class=\"line\">package controllers</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">\t<span class=\"string\">&quot;context&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;encoding/json&quot;</span></span><br><span class=\"line\">\tcorev1 <span class=\"string\">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;net/http&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/webhook/admission&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// +kubebuilder:webhook:admissionReviewVersions=v1,sideEffects=None,path=/mutate-v1-svc,mutating=true,failurePolicy=fail,groups=&quot;&quot;,resources=services,verbs=create;update,versions=v1,name=msvc.kb.io</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// KubeGameAnnotator annotates Pods</span></span><br><span class=\"line\">type KubeGameAnnotator struct &#123;</span><br><span class=\"line\">\tClient  client<span class=\"selector-class\">.Client</span></span><br><span class=\"line\">\tdecoder *admission<span class=\"selector-class\">.Decoder</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Handle adds an annotation to every incoming pods.</span></span><br><span class=\"line\">func (<span class=\"selector-tag\">a</span> *KubeGameAnnotator) <span class=\"built_in\">Handle</span>(ctx context<span class=\"selector-class\">.Context</span>, req admission.Request) admission<span class=\"selector-class\">.Response</span> &#123;</span><br><span class=\"line\">\tpod := &amp;corev1.Pod&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\terr := <span class=\"selector-tag\">a</span><span class=\"selector-class\">.decoder</span><span class=\"selector-class\">.Decode</span>(req, pod)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != nil &#123;</span><br><span class=\"line\">\t\treturn admission<span class=\"selector-class\">.Errored</span>(http<span class=\"selector-class\">.StatusBadRequest</span>, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> pod<span class=\"selector-class\">.Annotations</span> == nil &#123;</span><br><span class=\"line\">\t\tpod<span class=\"selector-class\">.Annotations</span> = map<span class=\"selector-attr\">[string]</span>string&#123;&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tpod<span class=\"selector-class\">.Annotations</span><span class=\"selector-attr\">[<span class=\"string\">&quot;example-mutating-admission-webhook&quot;</span>]</span> = <span class=\"string\">&quot;foo&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tmarshaledPod, err := json<span class=\"selector-class\">.Marshal</span>(pod)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != nil &#123;</span><br><span class=\"line\">\t\treturn admission<span class=\"selector-class\">.Errored</span>(http<span class=\"selector-class\">.StatusInternalServerError</span>, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn admission<span class=\"selector-class\">.PatchResponseFromRaw</span>(req<span class=\"selector-class\">.Object</span><span class=\"selector-class\">.Raw</span>, marshaledPod)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// KubeGameAnnotator implements admission.DecoderInjector.</span></span><br><span class=\"line\"><span class=\"comment\">// A decoder will be automatically injected.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// InjectDecoder injects the decoder.</span></span><br><span class=\"line\">func (<span class=\"selector-tag\">a</span> *KubeGameAnnotator) <span class=\"built_in\">InjectDecoder</span>(d *admission.Decoder) error &#123;</span><br><span class=\"line\">\t<span class=\"selector-tag\">a</span><span class=\"selector-class\">.decoder</span> = d</span><br><span class=\"line\">\treturn nil</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// validatingwebhook.go</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> controllers</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;context&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\tcorev1 <span class=\"string\">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;net/http&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/webhook/admission&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// +kubebuilder:webhook:admissionReviewVersions=v1,sideEffects=None,path=/validate-v1-svc,mutating=false,failurePolicy=fail,groups=&quot;&quot;,resources=services,verbs=create;update,versions=v1,name=vsvc.kb.io</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// KubeGameValidator validates Pods</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> KubeGameValidator <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tClient  client.Client</span><br><span class=\"line\">\tdecoder *admission.Decoder</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Handle admits a pod if a specific annotation exists.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(v *KubeGameValidator)</span></span> Handle(ctx context.Context, req admission.Request) admission.Response &#123;</span><br><span class=\"line\">\tpod := &amp;corev1.Pod&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\terr := v.decoder.Decode(req, pod)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> admission.Errored(http.StatusBadRequest, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tkey := <span class=\"string\">&quot;example-mutating-admission-webhook&quot;</span></span><br><span class=\"line\">\tanno, found := pod.Annotations[key]</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !found &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> admission.Denied(fmt.Sprintf(<span class=\"string\">&quot;missing annotation %s&quot;</span>, key))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> anno != <span class=\"string\">&quot;foo&quot;</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> admission.Denied(fmt.Sprintf(<span class=\"string\">&quot;annotation %s did not have value %q&quot;</span>, key, <span class=\"string\">&quot;foo&quot;</span>))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> admission.Allowed(<span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// KubeGameValidator implements admission.DecoderInjector.</span></span><br><span class=\"line\"><span class=\"comment\">// A decoder will be automatically injected.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// InjectDecoder injects the decoder.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(v *KubeGameValidator)</span></span> InjectDecoder(d *admission.Decoder) <span class=\"type\">error</span> &#123;</span><br><span class=\"line\">\tv.decoder = d</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>注意：因为上述逻辑需要services权限，所以我们在控制器里需要添加如下内容 //+kubebuilder:rbac:groups=“”,resources=services,verbs=get;list;watch;create;update;patch;delete 用于生成 rbac manifests。</p>\n</blockquote>\n<blockquote>\n<p>Register Your Handler<br />\n修改 main.go ，注册我们的 webhook handler</p>\n</blockquote>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setupLog<span class=\"selector-class\">.Info</span>(&quot;setting up webhook server&quot;)</span><br><span class=\"line\">hookServer := mgr.<span class=\"built_in\">GetWebhookServer</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">setupLog.<span class=\"built_in\">Info</span>(<span class=\"string\">&quot;registering webhooks to the webhook server&quot;</span>)</span><br><span class=\"line\">hookServer.<span class=\"built_in\">Register</span>(<span class=\"string\">&quot;/mutate-v1-svc&quot;</span>, &amp;webhook.Admission&#123;Handler: &amp;controllers.KubeGameAnnotator&#123;Client: mgr.<span class=\"built_in\">GetClient</span>()&#125;&#125;)</span><br><span class=\"line\">hookServer<span class=\"selector-class\">.Register</span>(&quot;/validate-v1-svc&quot;, &amp;webhook<span class=\"selector-class\">.Admission</span>&#123;Handler: &amp;controllers.KubeGameValidator&#123;Client: mgr.<span class=\"built_in\">GetClient</span>()&#125;&#125;)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>提示： 这里注册的path（例如 validate-v1-sv）路径需要和 validatingwebhook.go 、mutatingwebhook.go 文件里的 CRD validation 匹配，不然 kustomize 生成出来的 webhook yaml 文件不对。</p>\n</blockquote>\n<h1 id=\"本地测试\"><a class=\"markdownIt-Anchor\" href=\"#本地测试\"></a> 本地测试</h1>\n<p>make run 会报如下错误，是因为没有证书导致，需要配置证书，可以手动签发证书。</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">1</span>.<span class=\"number\">646924212701068</span>e+<span class=\"number\">09</span> ERROR setup problem running manager &#123;<span class=\"string\">&quot;error&quot;</span>: <span class=\"string\">&quot;open /var/folders/67/375276sx6hv0nln1whwm5syh0000gq/T/k8s-webhook-server/serving-certs/tls.crt: no such file or directory&quot;</span>&#125;</span><br></pre></td></tr></table></figure>\n<p>我本地指定证书目录：</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options<span class=\"punctuation\">&#123;</span></span><br><span class=\"line\"><span class=\"symbol\">\t\tScheme:</span>                 scheme,</span><br><span class=\"line\"><span class=\"symbol\">\t\tMetricsBindAddress:</span>     metricsAddr,</span><br><span class=\"line\"><span class=\"symbol\">\t\tPort:</span>                   <span class=\"number\">9443</span>,</span><br><span class=\"line\"><span class=\"symbol\">\t\tHealthProbeBindAddress:</span> probeAddr,</span><br><span class=\"line\"><span class=\"symbol\">\t\tLeaderElection:</span>         enableLeaderElection,</span><br><span class=\"line\"><span class=\"symbol\">\t\tLeaderElectionID:</span>       <span class=\"string\">&quot;27e1b0af.blazehu.com&quot;</span>,</span><br><span class=\"line\"><span class=\"symbol\">\t\tCertDir:</span>                <span class=\"string\">&quot;./cert/&quot;</span>,</span><br><span class=\"line\">\t<span class=\"punctuation\">&#125;</span>)</span><br></pre></td></tr></table></figure>\n<p>重新启动发现恢复正常</p>\n<blockquote>\n<p>提示： run controller-gen rbac:roleName=manager-role crd webhook paths=./… output:crd:artifacts:config=config/crd/bases -w to see all available markers, or controller-gen rbac:roleName=manager-role crd webhook paths=./… output:crd:artifacts:config=config/crd/bases -h for usage</p>\n</blockquote>\n<h1 id=\"7-部署至集群\"><a class=\"markdownIt-Anchor\" href=\"#7-部署至集群\"></a> 7. 部署至集群</h1>\n<p>7.1 部署 cert manager<br />\n建议使用 certmanager 为 webhook 服务器提供证书。其他解决方案也有效，只要它们将证书放在所需的位置。安装文档点这里<br />\n通过如下方式注入 caBundle :</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># This patch add annotation to admission webhook config and</span></span><br><span class=\"line\"><span class=\"comment\"># the variables $(CERTIFICATE_NAMESPACE) and $(CERTIFICATE_NAME) will be substituted by kustomize.</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">admissionregistration.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">MutatingWebhookConfiguration</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mutating-webhook-configuration</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">cert-manager.io/inject-ca-from:</span> <span class=\"string\">$(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">admissionregistration.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ValidatingWebhookConfiguration</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">validating-webhook-configuration</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">cert-manager.io/inject-ca-from:</span> <span class=\"string\">$(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"72-构建镜像\"><a class=\"markdownIt-Anchor\" href=\"#72-构建镜像\"></a> 7.2 构建镜像</h1>\n<p>•镜像替换：default/manager_auth_proxy_patch.yaml 文件中的 <a href=\"http://gcr.io/kubebuilder/kube-rbac-proxy:v0.8.0\">gcr.io/kubebuilder/kube-rbac-proxy:v0.8.0</a> （网络慢）<br />\n•Dockerfile 去掉 go mod download，直接使用本地 vendor 构建 （网络慢）<br />\n•Dockerfile 去掉 COPY api/ api/， 因为没有创建 Resource<br />\n•去掉 main.go 文件中配置的证书路径</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make docker-build <span class=\"attribute\">IMG</span>=xxxx</span><br><span class=\"line\">make docker-push <span class=\"attribute\">IMG</span>=xxxx</span><br></pre></td></tr></table></figure>\n<h1 id=\"73-修改模版然后部署\"><a class=\"markdownIt-Anchor\" href=\"#73-修改模版然后部署\"></a> 7.3 修改模版，然后部署</h1>\n<p>•修改 config/default/kustomization.yaml ， 将 webhook、certmanager 相关的注释去掉。<br />\n•修改 config/crd/kustomization.yaml ，将 webhook、certmanager 相关的注释去掉。<br />\n•修改 config/default/kustomization.yaml ， 将 crd 相关的给注释掉。</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make deploy <span class=\"attribute\">IMG</span>=xxxx</span><br></pre></td></tr></table></figure>\n<p>部署成功：</p>\n<p>查看控制器日志：</p>\n<h1 id=\"74-测试\"><a class=\"markdownIt-Anchor\" href=\"#74-测试\"></a> 7.4 测试</h1>\n<p>简单创建一个 service，webhook 会注入一个注解，并进行验证。下图可以看到成功注入。</p>\n<p>控制日志：</p>\n<p>说明：查看 MutatingWebhookConfiguration 配置可以看到 caBundle 被注入其中了。</p>\n<h1 id=\"8-总结\"><a class=\"markdownIt-Anchor\" href=\"#8-总结\"></a> 8. 总结</h1>\n<p>总结下 webhook Admission 的优势：</p>\n<p>•webhook 可动态扩展 Admission 能力，满足自定义客户的需求。<br />\n•不需要重启 API Server，可通过创建 webhook configuration 热加载 webhook admission。</p>\n<p>Reference documentation<br />\n•<a href=\"https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers\">https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers</a><br />\n•<a href=\"https://kubernetes.io/zh/docs/tasks/tls/managing-tls-in-a-cluster/\">https://kubernetes.io/zh/docs/tasks/tls/managing-tls-in-a-cluster/</a><br />\n•<a href=\"https://book.kubebuilder.io/reference/admission-webhook.html\">https://book.kubebuilder.io/reference/admission-webhook.html</a><br />\n•<a href=\"https://github.com/kubernetes-sigs/controller-runtime/tree/master/examples/builtins\">https://github.com/kubernetes-sigs/controller-runtime/tree/master/examples/builtins</a></p>\n","site":{"data":{"links":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}},"gallery":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}},"excerpt":"","more":"<h1 id=\"什么是准入控制\"><a class=\"markdownIt-Anchor\" href=\"#什么是准入控制\"></a> 什么是准入控制?</h1>\n<p>准入控制（Admission Controller）是 Kubernetes API Server 用于拦截请求的一种手段。Admission 可以做到对请求的资源对象进行校验，修改。service mesh 最近很火的项目 Istio 天生支持 Kubernetes，利用的就是 Admission 对服务实例自动注入 sidecar。</p>\n<h1 id=\"什么是准入-webhook\"><a class=\"markdownIt-Anchor\" href=\"#什么是准入-webhook\"></a> 什么是准入 Webhook？</h1>\n<p>准入 Webhook 是一种用于接收准入请求并对其进行处理的 HTTP 回调机制。 可以定义两种类型的准入 webhook，即 验证性质的准入 Webhook 和 修改性质的准入 Webhook。修改性质的准入 Webhook 会先被调用。它们可以更改发送到 API 服务器的对象以执行自定义的设置默认值操作。</p>\n<p>在完成了所有对象修改并且 API 服务器也验证了所传入的对象之后， 验证性质的 Webhook 会被调用，并通过拒绝请求的方式来强制实施自定义的策略。</p>\n<blockquote>\n<p>说明： 如果准入 Webhook 需要保证它们所看到的是对象的最终状态以实施某种策略。 则应使用验证性质的准入 Webhook，因为对象被修改性质 Webhook 看到之后仍然可能被修改。<br />\n<img src=\"/images/webhook1.jpeg\" alt=\"图片\" /></p>\n</blockquote>\n<h1 id=\"尝试准入-webhook\"><a class=\"markdownIt-Anchor\" href=\"#尝试准入-webhook\"></a> 尝试准入 Webhook</h1>\n<p>先决条件<br />\n•确保 Kubernetes 集群版本至少为 v1.16（以便使用 <a href=\"http://admissionregistration.k8s.io/v1\">admissionregistration.k8s.io/v1</a> API） 或者 v1.9 （以便使 <a href=\"http://admissionregistration.k8s.io/v1beta1\">admissionregistration.k8s.io/v1beta1</a> API）。<br />\n•确保启用 MutatingAdmissionWebhook 和 ValidatingAdmissionWebhook 控制器。 这里是一组推荐的 admission 控制器，通常可以启用。<br />\n•确保启用了 <a href=\"http://admissionregistration.k8s.io/v1beta1\">admissionregistration.k8s.io/v1beta1</a> API。</p>\n<h1 id=\"配置准入-webhook\"><a class=\"markdownIt-Anchor\" href=\"#配置准入-webhook\"></a> 配置准入 Webhook</h1>\n<p>你可以通过 ValidatingWebhookConfiguration 或者 MutatingWebhookConfiguration 动态配置哪些资源要被哪些准入 Webhook 处理。详细配置可以参阅 Webhook配置 部分。</p>\n<h1 id=\"认证和信任\"><a class=\"markdownIt-Anchor\" href=\"#认证和信任\"></a> 认证和信任</h1>\n<p>默认情况下，apiserver不会向webhooks进行身份验证。但是，如果您想对客户端进行身份验证，可以将apiserver配置为使用基本身份验证、承载令牌或证书对Webhook进行身份验证。你可以在这里找到详细的步骤。</p>\n<h1 id=\"编写一个准入-webhook-服务器\"><a class=\"markdownIt-Anchor\" href=\"#编写一个准入-webhook-服务器\"></a> 编写一个准入 Webhook 服务器</h1>\n<p>Webhook Admission 属于同步调用，需要用户部署自己的 webhook server，创建自定义的配置资源对象： ValidatingWebhookConfiguration 或 MutatingWebhookConfiguration。下面使用 kubebuilder 开发一个简单的 demo。</p>\n<p>6.1 创建项目</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubebuilder init <span class=\"attr\">--domain</span> marklu<span class=\"selector-class\">.com</span> <span class=\"attr\">--owner</span> <span class=\"string\">&quot;marklu&quot;</span> <span class=\"attr\">--repo</span> marklu.com/kubegame</span><br></pre></td></tr></table></figure>\n<p>提示： 这里通过 kubebuilder v3 创建的话，在 config 目录下会缺少 certmanager、webhook 目录以及 default/manager_webhook_patch.yml 和 webhookcainjection_patch.yaml 文件。可以通过从v2生成拷贝过来进行修改。</p>\n<p>6.2 创建控制器<br />\n这里只需要创建一个控制器</p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubebuilder create api --<span class=\"keyword\">group</span> <span class=\"title\">svc</span> --<span class=\"keyword\">version</span> v1 --kind App</span><br></pre></td></tr></table></figure>\n<p>6.3 创建 webhook<br />\nImplement Your Handler<br />\n新增 mutatingwebhook.go &amp; validatingwebhook.go 文件</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// mutatingwebhook.go</span></span><br><span class=\"line\">package controllers</span><br><span class=\"line\"></span><br><span class=\"line\">import (</span><br><span class=\"line\">\t<span class=\"string\">&quot;context&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;encoding/json&quot;</span></span><br><span class=\"line\">\tcorev1 <span class=\"string\">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;net/http&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/webhook/admission&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// +kubebuilder:webhook:admissionReviewVersions=v1,sideEffects=None,path=/mutate-v1-svc,mutating=true,failurePolicy=fail,groups=&quot;&quot;,resources=services,verbs=create;update,versions=v1,name=msvc.kb.io</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// KubeGameAnnotator annotates Pods</span></span><br><span class=\"line\">type KubeGameAnnotator struct &#123;</span><br><span class=\"line\">\tClient  client<span class=\"selector-class\">.Client</span></span><br><span class=\"line\">\tdecoder *admission<span class=\"selector-class\">.Decoder</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Handle adds an annotation to every incoming pods.</span></span><br><span class=\"line\">func (<span class=\"selector-tag\">a</span> *KubeGameAnnotator) <span class=\"built_in\">Handle</span>(ctx context<span class=\"selector-class\">.Context</span>, req admission.Request) admission<span class=\"selector-class\">.Response</span> &#123;</span><br><span class=\"line\">\tpod := &amp;corev1.Pod&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\terr := <span class=\"selector-tag\">a</span><span class=\"selector-class\">.decoder</span><span class=\"selector-class\">.Decode</span>(req, pod)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != nil &#123;</span><br><span class=\"line\">\t\treturn admission<span class=\"selector-class\">.Errored</span>(http<span class=\"selector-class\">.StatusBadRequest</span>, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> pod<span class=\"selector-class\">.Annotations</span> == nil &#123;</span><br><span class=\"line\">\t\tpod<span class=\"selector-class\">.Annotations</span> = map<span class=\"selector-attr\">[string]</span>string&#123;&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tpod<span class=\"selector-class\">.Annotations</span><span class=\"selector-attr\">[<span class=\"string\">&quot;example-mutating-admission-webhook&quot;</span>]</span> = <span class=\"string\">&quot;foo&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\tmarshaledPod, err := json<span class=\"selector-class\">.Marshal</span>(pod)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != nil &#123;</span><br><span class=\"line\">\t\treturn admission<span class=\"selector-class\">.Errored</span>(http<span class=\"selector-class\">.StatusInternalServerError</span>, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\treturn admission<span class=\"selector-class\">.PatchResponseFromRaw</span>(req<span class=\"selector-class\">.Object</span><span class=\"selector-class\">.Raw</span>, marshaledPod)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// KubeGameAnnotator implements admission.DecoderInjector.</span></span><br><span class=\"line\"><span class=\"comment\">// A decoder will be automatically injected.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// InjectDecoder injects the decoder.</span></span><br><span class=\"line\">func (<span class=\"selector-tag\">a</span> *KubeGameAnnotator) <span class=\"built_in\">InjectDecoder</span>(d *admission.Decoder) error &#123;</span><br><span class=\"line\">\t<span class=\"selector-tag\">a</span><span class=\"selector-class\">.decoder</span> = d</span><br><span class=\"line\">\treturn nil</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// validatingwebhook.go</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> controllers</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">&quot;context&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;fmt&quot;</span></span><br><span class=\"line\">\tcorev1 <span class=\"string\">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;net/http&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;sigs.k8s.io/controller-runtime/pkg/webhook/admission&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// +kubebuilder:webhook:admissionReviewVersions=v1,sideEffects=None,path=/validate-v1-svc,mutating=false,failurePolicy=fail,groups=&quot;&quot;,resources=services,verbs=create;update,versions=v1,name=vsvc.kb.io</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// KubeGameValidator validates Pods</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> KubeGameValidator <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tClient  client.Client</span><br><span class=\"line\">\tdecoder *admission.Decoder</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Handle admits a pod if a specific annotation exists.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(v *KubeGameValidator)</span></span> Handle(ctx context.Context, req admission.Request) admission.Response &#123;</span><br><span class=\"line\">\tpod := &amp;corev1.Pod&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\terr := v.decoder.Decode(req, pod)</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> admission.Errored(http.StatusBadRequest, err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tkey := <span class=\"string\">&quot;example-mutating-admission-webhook&quot;</span></span><br><span class=\"line\">\tanno, found := pod.Annotations[key]</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> !found &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> admission.Denied(fmt.Sprintf(<span class=\"string\">&quot;missing annotation %s&quot;</span>, key))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> anno != <span class=\"string\">&quot;foo&quot;</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> admission.Denied(fmt.Sprintf(<span class=\"string\">&quot;annotation %s did not have value %q&quot;</span>, key, <span class=\"string\">&quot;foo&quot;</span>))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> admission.Allowed(<span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// KubeGameValidator implements admission.DecoderInjector.</span></span><br><span class=\"line\"><span class=\"comment\">// A decoder will be automatically injected.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// InjectDecoder injects the decoder.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(v *KubeGameValidator)</span></span> InjectDecoder(d *admission.Decoder) <span class=\"type\">error</span> &#123;</span><br><span class=\"line\">\tv.decoder = d</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>注意：因为上述逻辑需要services权限，所以我们在控制器里需要添加如下内容 //+kubebuilder:rbac:groups=“”,resources=services,verbs=get;list;watch;create;update;patch;delete 用于生成 rbac manifests。</p>\n</blockquote>\n<blockquote>\n<p>Register Your Handler<br />\n修改 main.go ，注册我们的 webhook handler</p>\n</blockquote>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setupLog<span class=\"selector-class\">.Info</span>(&quot;setting up webhook server&quot;)</span><br><span class=\"line\">hookServer := mgr.<span class=\"built_in\">GetWebhookServer</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">setupLog.<span class=\"built_in\">Info</span>(<span class=\"string\">&quot;registering webhooks to the webhook server&quot;</span>)</span><br><span class=\"line\">hookServer.<span class=\"built_in\">Register</span>(<span class=\"string\">&quot;/mutate-v1-svc&quot;</span>, &amp;webhook.Admission&#123;Handler: &amp;controllers.KubeGameAnnotator&#123;Client: mgr.<span class=\"built_in\">GetClient</span>()&#125;&#125;)</span><br><span class=\"line\">hookServer<span class=\"selector-class\">.Register</span>(&quot;/validate-v1-svc&quot;, &amp;webhook<span class=\"selector-class\">.Admission</span>&#123;Handler: &amp;controllers.KubeGameValidator&#123;Client: mgr.<span class=\"built_in\">GetClient</span>()&#125;&#125;)</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>提示： 这里注册的path（例如 validate-v1-sv）路径需要和 validatingwebhook.go 、mutatingwebhook.go 文件里的 CRD validation 匹配，不然 kustomize 生成出来的 webhook yaml 文件不对。</p>\n</blockquote>\n<h1 id=\"本地测试\"><a class=\"markdownIt-Anchor\" href=\"#本地测试\"></a> 本地测试</h1>\n<p>make run 会报如下错误，是因为没有证书导致，需要配置证书，可以手动签发证书。</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">1</span>.<span class=\"number\">646924212701068</span>e+<span class=\"number\">09</span> ERROR setup problem running manager &#123;<span class=\"string\">&quot;error&quot;</span>: <span class=\"string\">&quot;open /var/folders/67/375276sx6hv0nln1whwm5syh0000gq/T/k8s-webhook-server/serving-certs/tls.crt: no such file or directory&quot;</span>&#125;</span><br></pre></td></tr></table></figure>\n<p>我本地指定证书目录：</p>\n<figure class=\"highlight dts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options<span class=\"punctuation\">&#123;</span></span><br><span class=\"line\"><span class=\"symbol\">\t\tScheme:</span>                 scheme,</span><br><span class=\"line\"><span class=\"symbol\">\t\tMetricsBindAddress:</span>     metricsAddr,</span><br><span class=\"line\"><span class=\"symbol\">\t\tPort:</span>                   <span class=\"number\">9443</span>,</span><br><span class=\"line\"><span class=\"symbol\">\t\tHealthProbeBindAddress:</span> probeAddr,</span><br><span class=\"line\"><span class=\"symbol\">\t\tLeaderElection:</span>         enableLeaderElection,</span><br><span class=\"line\"><span class=\"symbol\">\t\tLeaderElectionID:</span>       <span class=\"string\">&quot;27e1b0af.blazehu.com&quot;</span>,</span><br><span class=\"line\"><span class=\"symbol\">\t\tCertDir:</span>                <span class=\"string\">&quot;./cert/&quot;</span>,</span><br><span class=\"line\">\t<span class=\"punctuation\">&#125;</span>)</span><br></pre></td></tr></table></figure>\n<p>重新启动发现恢复正常</p>\n<blockquote>\n<p>提示： run controller-gen rbac:roleName=manager-role crd webhook paths=./… output:crd:artifacts:config=config/crd/bases -w to see all available markers, or controller-gen rbac:roleName=manager-role crd webhook paths=./… output:crd:artifacts:config=config/crd/bases -h for usage</p>\n</blockquote>\n<h1 id=\"7-部署至集群\"><a class=\"markdownIt-Anchor\" href=\"#7-部署至集群\"></a> 7. 部署至集群</h1>\n<p>7.1 部署 cert manager<br />\n建议使用 certmanager 为 webhook 服务器提供证书。其他解决方案也有效，只要它们将证书放在所需的位置。安装文档点这里<br />\n通过如下方式注入 caBundle :</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># This patch add annotation to admission webhook config and</span></span><br><span class=\"line\"><span class=\"comment\"># the variables $(CERTIFICATE_NAMESPACE) and $(CERTIFICATE_NAME) will be substituted by kustomize.</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">admissionregistration.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">MutatingWebhookConfiguration</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mutating-webhook-configuration</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">cert-manager.io/inject-ca-from:</span> <span class=\"string\">$(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">admissionregistration.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ValidatingWebhookConfiguration</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">validating-webhook-configuration</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">cert-manager.io/inject-ca-from:</span> <span class=\"string\">$(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"72-构建镜像\"><a class=\"markdownIt-Anchor\" href=\"#72-构建镜像\"></a> 7.2 构建镜像</h1>\n<p>•镜像替换：default/manager_auth_proxy_patch.yaml 文件中的 <a href=\"http://gcr.io/kubebuilder/kube-rbac-proxy:v0.8.0\">gcr.io/kubebuilder/kube-rbac-proxy:v0.8.0</a> （网络慢）<br />\n•Dockerfile 去掉 go mod download，直接使用本地 vendor 构建 （网络慢）<br />\n•Dockerfile 去掉 COPY api/ api/， 因为没有创建 Resource<br />\n•去掉 main.go 文件中配置的证书路径</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make docker-build <span class=\"attribute\">IMG</span>=xxxx</span><br><span class=\"line\">make docker-push <span class=\"attribute\">IMG</span>=xxxx</span><br></pre></td></tr></table></figure>\n<h1 id=\"73-修改模版然后部署\"><a class=\"markdownIt-Anchor\" href=\"#73-修改模版然后部署\"></a> 7.3 修改模版，然后部署</h1>\n<p>•修改 config/default/kustomization.yaml ， 将 webhook、certmanager 相关的注释去掉。<br />\n•修改 config/crd/kustomization.yaml ，将 webhook、certmanager 相关的注释去掉。<br />\n•修改 config/default/kustomization.yaml ， 将 crd 相关的给注释掉。</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make deploy <span class=\"attribute\">IMG</span>=xxxx</span><br></pre></td></tr></table></figure>\n<p>部署成功：</p>\n<p>查看控制器日志：</p>\n<h1 id=\"74-测试\"><a class=\"markdownIt-Anchor\" href=\"#74-测试\"></a> 7.4 测试</h1>\n<p>简单创建一个 service，webhook 会注入一个注解，并进行验证。下图可以看到成功注入。</p>\n<p>控制日志：</p>\n<p>说明：查看 MutatingWebhookConfiguration 配置可以看到 caBundle 被注入其中了。</p>\n<h1 id=\"8-总结\"><a class=\"markdownIt-Anchor\" href=\"#8-总结\"></a> 8. 总结</h1>\n<p>总结下 webhook Admission 的优势：</p>\n<p>•webhook 可动态扩展 Admission 能力，满足自定义客户的需求。<br />\n•不需要重启 API Server，可通过创建 webhook configuration 热加载 webhook admission。</p>\n<p>Reference documentation<br />\n•<a href=\"https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers\">https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers</a><br />\n•<a href=\"https://kubernetes.io/zh/docs/tasks/tls/managing-tls-in-a-cluster/\">https://kubernetes.io/zh/docs/tasks/tls/managing-tls-in-a-cluster/</a><br />\n•<a href=\"https://book.kubebuilder.io/reference/admission-webhook.html\">https://book.kubebuilder.io/reference/admission-webhook.html</a><br />\n•<a href=\"https://github.com/kubernetes-sigs/controller-runtime/tree/master/examples/builtins\">https://github.com/kubernetes-sigs/controller-runtime/tree/master/examples/builtins</a></p>\n"},{"title":"Alertmanager","sidebar":"none","_content":"```\nglobal:\n  smtp_smarthost: \"\"\n  smtp_from: \"\"\n  smtp_auth_username: \"\"\n  smtp_auth_password: \"\"\nroute:\n  group_by: [\"alertname\",\"severity\"]\n  group_wait: 60s # 接收到告警后，多久开始发送,\n  group_interval: 120s # 同一个周期内，多个分组发送报警的间隔时间\n  repeat_interval: 60s # 不同周期内，每个分组重复告警的时间间隔\n  receiver: devops # 默认使用这个接收器\n  routes:\n  - receiver: test-dev\n    group_wait: 10s\n    match_re:\n       POD_IP: '^10\\.100.*'\n       alertname: ^(BlackboxProbeFailed|PodMemoryUsageAlmostFull|JvmMemoryUsageAlmostFull|ElasticsearchNoNewDocuments|etcdMembersDown|etcdInsufficientMembers|etcdNoLeader|JvmFullGcOccured|JvmThreadsUsageOverload|PodNotReady|KubePodNotReady)$\n  - receiver: prod-dev\n    group_wait: 10s\n    match_re:\n       POD_IP: '^10\\.102.*'\n       alertname: ^(BlackboxProbeFailed|PodMemoryUsageAlmostFull|JvmMemoryUsageAlmostFull|ElasticsearchNoNewDocuments|etcdMembersDown|etcdInsufficientMembers|etcdNoLeader|JvmFullGcOccured|JvmThreadsUsageOverload|PodNotReady|KubePodNotReady)$\n  - receiver: test-ops-crit\n    group_wait: 10s\n    match_re:\n      severity: critical\n      POD_IP: '^10\\.100.*'\n  - receiver: prod-ops-crit\n    group_wait: 10s\n    match_re:\n      severity: critical\n      POD_IP: '^10\\.102.*'\n  - receiver: test-ops-warn\n    group_wait: 10s\n    match_re:\n      severity: warning\n      POD_IP: '^10\\.100.*'\n  - receiver: prod-ops-warn\n    group_wait: 10s\n    match_re:\n      severity: warning\n      POD_IP: '^10\\.102.*'\n\nreceivers:\n- name: 'devops'\n  webhook_configs:\n  - url: http://alertmanager-wechat:8001\n    send_resolved: false\n\n- name: 'test-ops-crit'\n  webhook_configs:\n  - url: \"\"\n    send_resolved: false\n\n- name: 'test-ops-warn'\n  webhook_configs:\n  - url: \"\"\n    send_resolved: false\n\n- name: 'test-dev'\n  webhook_configs:\n  - url: \"\"\n    send_resolved: false\n\n- name: 'prod-ops-crit'\n  webhook_configs:\n  - url: \"\"\n    send_resolved: false\n\n- name: 'prod-ops-warn'\n  webhook_configs:\n  - url: \"\"\n    send_resolved: false\n\n- name: 'prod-dev'\n  webhook_configs:\n  - url: \"\"\n    send_resolved: false\n\ninhibit_rules:\n  - source_match:\n      severity: 'critical'\n    target_match:\n      severity: 'critical'\n    equal: ['alertname']\n  - source_match:\n      severity: 'error'\n    target_match:\n      severity: 'error'\n    equal: ['alertname']\n  - source_match:\n      severity: 'warning'\n    target_match:\n      severity: 'warning'\n    equal: ['alertname']\n    ```","source":"_posts/alertmanager.md","raw":"---\ntitle: Alertmanager\ncategories: \n  - prometheux\ntags:\n  - k8s\nsidebar: none \n---\n```\nglobal:\n  smtp_smarthost: \"\"\n  smtp_from: \"\"\n  smtp_auth_username: \"\"\n  smtp_auth_password: \"\"\nroute:\n  group_by: [\"alertname\",\"severity\"]\n  group_wait: 60s # 接收到告警后，多久开始发送,\n  group_interval: 120s # 同一个周期内，多个分组发送报警的间隔时间\n  repeat_interval: 60s # 不同周期内，每个分组重复告警的时间间隔\n  receiver: devops # 默认使用这个接收器\n  routes:\n  - receiver: test-dev\n    group_wait: 10s\n    match_re:\n       POD_IP: '^10\\.100.*'\n       alertname: ^(BlackboxProbeFailed|PodMemoryUsageAlmostFull|JvmMemoryUsageAlmostFull|ElasticsearchNoNewDocuments|etcdMembersDown|etcdInsufficientMembers|etcdNoLeader|JvmFullGcOccured|JvmThreadsUsageOverload|PodNotReady|KubePodNotReady)$\n  - receiver: prod-dev\n    group_wait: 10s\n    match_re:\n       POD_IP: '^10\\.102.*'\n       alertname: ^(BlackboxProbeFailed|PodMemoryUsageAlmostFull|JvmMemoryUsageAlmostFull|ElasticsearchNoNewDocuments|etcdMembersDown|etcdInsufficientMembers|etcdNoLeader|JvmFullGcOccured|JvmThreadsUsageOverload|PodNotReady|KubePodNotReady)$\n  - receiver: test-ops-crit\n    group_wait: 10s\n    match_re:\n      severity: critical\n      POD_IP: '^10\\.100.*'\n  - receiver: prod-ops-crit\n    group_wait: 10s\n    match_re:\n      severity: critical\n      POD_IP: '^10\\.102.*'\n  - receiver: test-ops-warn\n    group_wait: 10s\n    match_re:\n      severity: warning\n      POD_IP: '^10\\.100.*'\n  - receiver: prod-ops-warn\n    group_wait: 10s\n    match_re:\n      severity: warning\n      POD_IP: '^10\\.102.*'\n\nreceivers:\n- name: 'devops'\n  webhook_configs:\n  - url: http://alertmanager-wechat:8001\n    send_resolved: false\n\n- name: 'test-ops-crit'\n  webhook_configs:\n  - url: \"\"\n    send_resolved: false\n\n- name: 'test-ops-warn'\n  webhook_configs:\n  - url: \"\"\n    send_resolved: false\n\n- name: 'test-dev'\n  webhook_configs:\n  - url: \"\"\n    send_resolved: false\n\n- name: 'prod-ops-crit'\n  webhook_configs:\n  - url: \"\"\n    send_resolved: false\n\n- name: 'prod-ops-warn'\n  webhook_configs:\n  - url: \"\"\n    send_resolved: false\n\n- name: 'prod-dev'\n  webhook_configs:\n  - url: \"\"\n    send_resolved: false\n\ninhibit_rules:\n  - source_match:\n      severity: 'critical'\n    target_match:\n      severity: 'critical'\n    equal: ['alertname']\n  - source_match:\n      severity: 'error'\n    target_match:\n      severity: 'error'\n    equal: ['alertname']\n  - source_match:\n      severity: 'warning'\n    target_match:\n      severity: 'warning'\n    equal: ['alertname']\n    ```","slug":"alertmanager","published":1,"date":"2023-05-23T06:07:43.635Z","updated":"2023-05-25T16:05:53.508Z","_id":"clhzvkmv8000030f8apqx2yyy","comments":1,"layout":"post","photos":[],"link":"","content":"<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\">  <span class=\"attr\">smtp_smarthost:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">smtp_from:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">smtp_auth_username:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">smtp_auth_password:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"attr\">route:</span></span><br><span class=\"line\">  <span class=\"attr\">group_by:</span> [<span class=\"string\">&quot;alertname&quot;</span>,<span class=\"string\">&quot;severity&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">group_wait:</span> <span class=\"string\">60s</span> <span class=\"comment\"># 接收到告警后，多久开始发送,</span></span><br><span class=\"line\">  <span class=\"attr\">group_interval:</span> <span class=\"string\">120s</span> <span class=\"comment\"># 同一个周期内，多个分组发送报警的间隔时间</span></span><br><span class=\"line\">  <span class=\"attr\">repeat_interval:</span> <span class=\"string\">60s</span> <span class=\"comment\"># 不同周期内，每个分组重复告警的时间间隔</span></span><br><span class=\"line\">  <span class=\"attr\">receiver:</span> <span class=\"string\">devops</span> <span class=\"comment\"># 默认使用这个接收器</span></span><br><span class=\"line\">  <span class=\"attr\">routes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">receiver:</span> <span class=\"string\">test-dev</span></span><br><span class=\"line\">    <span class=\"attr\">group_wait:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">    <span class=\"attr\">match_re:</span></span><br><span class=\"line\">       <span class=\"attr\">POD_IP:</span> <span class=\"string\">&#x27;^10\\.100.*&#x27;</span></span><br><span class=\"line\">       <span class=\"attr\">alertname:</span> <span class=\"string\">^(BlackboxProbeFailed|PodMemoryUsageAlmostFull|JvmMemoryUsageAlmostFull|ElasticsearchNoNewDocuments|etcdMembersDown|etcdInsufficientMembers|etcdNoLeader|JvmFullGcOccured|JvmThreadsUsageOverload|PodNotReady|KubePodNotReady)$</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">receiver:</span> <span class=\"string\">prod-dev</span></span><br><span class=\"line\">    <span class=\"attr\">group_wait:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">    <span class=\"attr\">match_re:</span></span><br><span class=\"line\">       <span class=\"attr\">POD_IP:</span> <span class=\"string\">&#x27;^10\\.102.*&#x27;</span></span><br><span class=\"line\">       <span class=\"attr\">alertname:</span> <span class=\"string\">^(BlackboxProbeFailed|PodMemoryUsageAlmostFull|JvmMemoryUsageAlmostFull|ElasticsearchNoNewDocuments|etcdMembersDown|etcdInsufficientMembers|etcdNoLeader|JvmFullGcOccured|JvmThreadsUsageOverload|PodNotReady|KubePodNotReady)$</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">receiver:</span> <span class=\"string\">test-ops-crit</span></span><br><span class=\"line\">    <span class=\"attr\">group_wait:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">    <span class=\"attr\">match_re:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">critical</span></span><br><span class=\"line\">      <span class=\"attr\">POD_IP:</span> <span class=\"string\">&#x27;^10\\.100.*&#x27;</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">receiver:</span> <span class=\"string\">prod-ops-crit</span></span><br><span class=\"line\">    <span class=\"attr\">group_wait:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">    <span class=\"attr\">match_re:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">critical</span></span><br><span class=\"line\">      <span class=\"attr\">POD_IP:</span> <span class=\"string\">&#x27;^10\\.102.*&#x27;</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">receiver:</span> <span class=\"string\">test-ops-warn</span></span><br><span class=\"line\">    <span class=\"attr\">group_wait:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">    <span class=\"attr\">match_re:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">warning</span></span><br><span class=\"line\">      <span class=\"attr\">POD_IP:</span> <span class=\"string\">&#x27;^10\\.100.*&#x27;</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">receiver:</span> <span class=\"string\">prod-ops-warn</span></span><br><span class=\"line\">    <span class=\"attr\">group_wait:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">    <span class=\"attr\">match_re:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">warning</span></span><br><span class=\"line\">      <span class=\"attr\">POD_IP:</span> <span class=\"string\">&#x27;^10\\.102.*&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">receivers:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;devops&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">http://alertmanager-wechat:8001</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;test-ops-crit&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;test-ops-warn&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;test-dev&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;prod-ops-crit&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;prod-ops-warn&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;prod-dev&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">inhibit_rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">source_match:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">&#x27;critical&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">target_match:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">&#x27;critical&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">equal:</span> [<span class=\"string\">&#x27;alertname&#x27;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">source_match:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">&#x27;error&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">target_match:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">&#x27;error&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">equal:</span> [<span class=\"string\">&#x27;alertname&#x27;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">source_match:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">&#x27;warning&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">target_match:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">&#x27;warning&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">equal:</span> [<span class=\"string\">&#x27;alertname&#x27;</span>]</span><br></pre></td></tr></table></figure>","site":{"data":{"links":{"创造狮":{"link":"http://chuangzaoshi.com/","avatar":"/images/favatar/chuangzaoshi-logo.png","desc":"为创意工作者而设计"},"腾讯设计导航":{"link":"http://idesign.qq.com/","avatar":"/images/favatar/idesign-logo.png","desc":"网罗全网高逼格的设计站点"}},"gallery":{"Name":{"full_link":"http://example.com/full-image.png","thumb_link":"http://example.com/thumb-image.png","descr":"这是一个描述"}}}},"excerpt":"","more":"<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\">  <span class=\"attr\">smtp_smarthost:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">smtp_from:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">smtp_auth_username:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">smtp_auth_password:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"attr\">route:</span></span><br><span class=\"line\">  <span class=\"attr\">group_by:</span> [<span class=\"string\">&quot;alertname&quot;</span>,<span class=\"string\">&quot;severity&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">group_wait:</span> <span class=\"string\">60s</span> <span class=\"comment\"># 接收到告警后，多久开始发送,</span></span><br><span class=\"line\">  <span class=\"attr\">group_interval:</span> <span class=\"string\">120s</span> <span class=\"comment\"># 同一个周期内，多个分组发送报警的间隔时间</span></span><br><span class=\"line\">  <span class=\"attr\">repeat_interval:</span> <span class=\"string\">60s</span> <span class=\"comment\"># 不同周期内，每个分组重复告警的时间间隔</span></span><br><span class=\"line\">  <span class=\"attr\">receiver:</span> <span class=\"string\">devops</span> <span class=\"comment\"># 默认使用这个接收器</span></span><br><span class=\"line\">  <span class=\"attr\">routes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">receiver:</span> <span class=\"string\">test-dev</span></span><br><span class=\"line\">    <span class=\"attr\">group_wait:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">    <span class=\"attr\">match_re:</span></span><br><span class=\"line\">       <span class=\"attr\">POD_IP:</span> <span class=\"string\">&#x27;^10\\.100.*&#x27;</span></span><br><span class=\"line\">       <span class=\"attr\">alertname:</span> <span class=\"string\">^(BlackboxProbeFailed|PodMemoryUsageAlmostFull|JvmMemoryUsageAlmostFull|ElasticsearchNoNewDocuments|etcdMembersDown|etcdInsufficientMembers|etcdNoLeader|JvmFullGcOccured|JvmThreadsUsageOverload|PodNotReady|KubePodNotReady)$</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">receiver:</span> <span class=\"string\">prod-dev</span></span><br><span class=\"line\">    <span class=\"attr\">group_wait:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">    <span class=\"attr\">match_re:</span></span><br><span class=\"line\">       <span class=\"attr\">POD_IP:</span> <span class=\"string\">&#x27;^10\\.102.*&#x27;</span></span><br><span class=\"line\">       <span class=\"attr\">alertname:</span> <span class=\"string\">^(BlackboxProbeFailed|PodMemoryUsageAlmostFull|JvmMemoryUsageAlmostFull|ElasticsearchNoNewDocuments|etcdMembersDown|etcdInsufficientMembers|etcdNoLeader|JvmFullGcOccured|JvmThreadsUsageOverload|PodNotReady|KubePodNotReady)$</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">receiver:</span> <span class=\"string\">test-ops-crit</span></span><br><span class=\"line\">    <span class=\"attr\">group_wait:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">    <span class=\"attr\">match_re:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">critical</span></span><br><span class=\"line\">      <span class=\"attr\">POD_IP:</span> <span class=\"string\">&#x27;^10\\.100.*&#x27;</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">receiver:</span> <span class=\"string\">prod-ops-crit</span></span><br><span class=\"line\">    <span class=\"attr\">group_wait:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">    <span class=\"attr\">match_re:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">critical</span></span><br><span class=\"line\">      <span class=\"attr\">POD_IP:</span> <span class=\"string\">&#x27;^10\\.102.*&#x27;</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">receiver:</span> <span class=\"string\">test-ops-warn</span></span><br><span class=\"line\">    <span class=\"attr\">group_wait:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">    <span class=\"attr\">match_re:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">warning</span></span><br><span class=\"line\">      <span class=\"attr\">POD_IP:</span> <span class=\"string\">&#x27;^10\\.100.*&#x27;</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">receiver:</span> <span class=\"string\">prod-ops-warn</span></span><br><span class=\"line\">    <span class=\"attr\">group_wait:</span> <span class=\"string\">10s</span></span><br><span class=\"line\">    <span class=\"attr\">match_re:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">warning</span></span><br><span class=\"line\">      <span class=\"attr\">POD_IP:</span> <span class=\"string\">&#x27;^10\\.102.*&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">receivers:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;devops&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">http://alertmanager-wechat:8001</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;test-ops-crit&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;test-ops-warn&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;test-dev&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;prod-ops-crit&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;prod-ops-warn&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;prod-dev&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">send_resolved:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">inhibit_rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">source_match:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">&#x27;critical&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">target_match:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">&#x27;critical&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">equal:</span> [<span class=\"string\">&#x27;alertname&#x27;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">source_match:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">&#x27;error&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">target_match:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">&#x27;error&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">equal:</span> [<span class=\"string\">&#x27;alertname&#x27;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">source_match:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">&#x27;warning&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">target_match:</span></span><br><span class=\"line\">      <span class=\"attr\">severity:</span> <span class=\"string\">&#x27;warning&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">equal:</span> [<span class=\"string\">&#x27;alertname&#x27;</span>]</span><br></pre></td></tr></table></figure>"}],"PostAsset":[],"PostCategory":[{"post_id":"clhzqrgue0009w8f8cbd71yy6","category_id":"cli3bjxsk00042kf84ekkbnbs","_id":"cli3bjxsk00052kf8hmpx761m"},{"post_id":"clhzqn8n90005w8f81pzxesvn","category_id":"cli3bjxsk00042kf84ekkbnbs","_id":"cli3bk6w900062kf823d2c7zj"},{"post_id":"clhzqpixk0007w8f84rcm9e90","category_id":"cli3bjxsk00042kf84ekkbnbs","_id":"cli3blcdb000024f8hwz3cbof"},{"post_id":"clhzqmhfy0001w8f861i90wy2","category_id":"cli3bjxsk00042kf84ekkbnbs","_id":"cli3blgxg000124f8fc807n8v"},{"post_id":"clhzo2qv80001f0f8dwa6cswx","category_id":"cli3blqgy000324f853qic9bw","_id":"cli3blqgz000424f82a1f5v3o"},{"post_id":"clhzvkmv8000030f8apqx2yyy","category_id":"cli3bm2q4000524f88iur6aku","_id":"cli3bm2q5000624f89eo45t50"}],"PostTag":[{"post_id":"clhzqmhfy0001w8f861i90wy2","tag_id":"cli3br9io0002oof8fmiq6bl3","_id":"cli3br9ip0003oof8cy8dgwwg"},{"post_id":"clhzqpixk0007w8f84rcm9e90","tag_id":"cli3br9io0002oof8fmiq6bl3","_id":"cli3briao0004oof8bqia8gqk"},{"post_id":"clhzqn8n90005w8f81pzxesvn","tag_id":"cli3br9io0002oof8fmiq6bl3","_id":"cli3bsdf60005oof80zio0lwq"},{"post_id":"clhzqrgue0009w8f8cbd71yy6","tag_id":"cli3br9io0002oof8fmiq6bl3","_id":"cli3bsgff0006oof8dbwucr1h"},{"post_id":"clhzvkmv8000030f8apqx2yyy","tag_id":"cli3br9io0002oof8fmiq6bl3","_id":"cli3bsypg0007oof8448k1ith"},{"post_id":"clhzo2qv80001f0f8dwa6cswx","tag_id":"cli3btnba0009oof874m41aps","_id":"cli3btnba000aoof82d6ahotf"}],"Tag":[{"name":"文章标签","_id":"cli3bqm7q0000oof8af2g0if2"},{"name":"k8s","_id":"cli3br9io0002oof8fmiq6bl3"},{"name":"hexo","_id":"cli3btnba0009oof874m41aps"}]}}